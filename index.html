<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>장비 관리 시스템 - 형님 명령 이행</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .card { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 10px; border-left: 10px solid #d63031; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .card-title { font-weight: bold; font-size: 14px; color: #222; margin-bottom: 8px; }
    .card-note { background: #fdf2f2; padding: 10px; border-radius: 6px; color: #d63031; font-size: 13px; border: 1px solid #ffcccc; font-weight: bold; }
  </style>
</head>
<body>

<div class="header" id="status">데이터 동기화 중...</div>
<div class="box" id="searchBox"></div>
<div id="results"></div>

<script>
const SID = '1qJpWnVNBZIwnwZG4OD3JdUKytVq_4V6n';
const SHEETS = {'청력기':'1397804768','청력부스':'1226463543','중이기기':'1413774664','소음계':'199554987','원심분리기':'1627219985','HRV':'816640230','EKG':'914024434','폐활량':'348975961','실린지':'874684579','프린터기':'70160554','업무용노트북':'811915899','와이브로':'1793948339'};
let allData = [];

// 장소 맵핑: 형님 말씀대로 "현재위치" 열 글자 그대로!
function getLoc(r) {
  const l = (r['현재위치'] || r['현재 위치'] || '').toString().trim();
  return l === '' ? '미입력' : l;
}

// 로그 찾기: 날짜 열들 중에서 '글자가 있는 마지막 열'을 찾음
function getLastLog(r) {
  const keys = Object.keys(r).filter(k => k.match(/^\d{1,2}[\/\-]\d{1,2}$/));
  // 날짜 역순 정렬 (최신 날짜부터 탐색)
  const sorted = keys.sort((a,b) => {
    const [am, ad] = a.split(/[\/\-]/).map(Number);
    const [bm, bd] = b.split(/[\/\-]/).map(Number);
    return (bm===1?13:bm)*100+bd - (am===1?13:am)*100+ad;
  });

  for(let k of sorted) {
    const val = r[k].toString().trim();
    if(val !== '') return { d: k, v: val }; // 글자(특이사항 없음 등)가 있으면 바로 반환
  }
  return { d: '기록없음', v: '내용없음' };
}

async function load() {
  allData = [];
  for (const [nm, gid] of Object.entries(SHEETS)) {
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res = await fetch(url);
      const csv = await res.text();
      const p = Papa.parse(csv.trim(), {header: true, skipEmptyLines: true});
      p.data.forEach(r => {
        const asset = r['자산번호'] || r['자산 번호'];
        if(asset && asset.trim()) {
          allData.push({ ...r, _eq: nm, _loc: getLoc(r), _asset: asset });
        }
      });
    } catch (e) {}
  }
  document.getElementById('status').innerText = `✅ 장비 ${allData.length}대 로드 완료`;
  initUI();
}

function initUI() {
  const locs = [...new Set(allData.map(r => r._loc))].sort();
  document.getElementById('searchBox').innerHTML = `
    <label>1. 장비 선택</label>
    <select id="es" onchange="updateLocs()"><option value="">--선택--</option>${Object.keys(SHEETS).map(e=>`<option value="${e}">${e}</option>`).join('')}</select>
    <div id="locDiv" style="display:none">
      <label>2. 장소 선택 (현재위치 기준)</label>
      <select id="ls" onchange="render()"></select>
    </div>`;
}

function updateLocs() {
  const e = document.getElementById('es').value;
  if(!e) return;
  const filtered = allData.filter(r => r._eq === e);
  const locs = [...new Set(filtered.map(r => r._loc))].sort();
  document.getElementById('ls').innerHTML = '<option value="">전체보기</option>' + locs.map(l=>`<option value="${l}">${l}</option>`).join('');
  document.getElementById('locDiv').style.display = 'block';
  render();
}

function render() {
  const e = document.getElementById('es').value;
  const l = document.getElementById('ls').value;
  let f = allData.filter(r => r._eq === e);
  if(l) f = f.filter(r => r._loc === l);

  document.getElementById('results').innerHTML = f.map(r => {
    const log = getLastLog(r);
    return `
      <div class="card">
        <div class="card-title">${r._loc} / ${r._eq} / ${r._asset}</div>
        <div class="card-note">${log.d} : ${log.v}</div>
      </div>`;
  }).join('');
}

load();
</script>
</body>
</html>