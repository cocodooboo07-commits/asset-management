<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 15px; background: #fff; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; }
    .tab.active { background: #d63031; color: white; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .card { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 10px; border-left: 10px solid #d63031; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .card-title { font-weight: bold; font-size: 16px; color: #222; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .card-content { font-size: 14px; color: #444; line-height: 1.6; }
    .issue-text { color: #d63031; font-weight: bold; }
    /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
    .cal-wrap { background: #fff; border-radius: 10px; padding: 10px; }
    .month-nav { display: flex; justify-content: space-between; align-items: center; padding: 10px; font-weight: bold; }
    .month-nav button { padding: 5px 15px; background: #d63031; color: white; border: none; border-radius: 5px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd; }
    .cal-h { background: #f8f9fa; padding: 10px; text-align: center; font-size: 12px; font-weight: bold; }
    .cal-d { background: #fff; height: 70px; padding: 5px; font-size: 12px; cursor: pointer; position: relative; }
    .cal-d.has-issue::after { content: 'ğŸ”´'; position: absolute; bottom: 5px; right: 5px; font-size: 10px; }
    .cal-d.selected { background: #ffebeb; border: 2px solid #d63031; }
  </style>
</head>
<body>

<div class="header" id="status">ì¥ë¹„ 12ì¢… ì‹œíŠ¸ ë¡œë“œ ì¤‘...</div>
<div class="tabs">
  <div class="tab active" id="tab1" onclick="setMode('equip')">ì¥ë¹„â†’ì¥ì†Œ</div>
  <div class="tab" id="tab2" onclick="setMode('date')">ë‚ ì§œë³„ ë¡œê·¸</div>
</div>
<div id="searchBox" class="box"></div>
<div id="results"></div>

<script>
const SID = '1qJpWnVNBZIwnwZG4OD3JdUKytVq_4V6n';
const SHEETS = {'ì²­ë ¥ê¸°':'1397804768','ì²­ë ¥ë¶€ìŠ¤':'1226463543','ì¤‘ì´ê¸°ê¸°':'1413774664','ì†ŒìŒê³„':'199554987','ì›ì‹¬ë¶„ë¦¬ê¸°':'1627219985','HRV':'816640230','EKG':'914024434','íí™œëŸ‰':'348975961','ì‹¤ë¦°ì§€':'874684579','í”„ë¦°í„°ê¸°':'70160554','ì—…ë¬´ìš©ë…¸íŠ¸ë¶':'811915899','ì™€ì´ë¸Œë¡œ':'1793948339'};
let allData = [];
let mode = 'equip';
let nowYear = 2026, nowMonth = 1;

// í˜•ë‹˜ ìš”ì²­: íŠ¹ì´ì‚¬í•­ì´ ìˆëŠ” ê²½ìš° íŒë³„ (ì •ìƒ, ì´ìƒì—†ìŒ ë“± ì œì™¸)
function checkIssue(t) {
  if(!t) return false;
  const c = t.toString().replace(/\s/g,'');
  const ignore = ['ì •ìƒ','ì´ìƒì—†ìŒ','íŠ¹ì´ì‚¬í•­ì—†ìŒ','ì™„ë£Œ','-','ì—†ìŒ'];
  return !ignore.some(i => c.includes(i)) && c.length > 0;
}

// ìœ„ì¹˜ ë¶„ë¥˜ ë¡œì§
function getLoc(r) {
  const v = (r['í˜„ì¬ìœ„ì¹˜'] || r['í˜„ì¬ ìœ„ì¹˜'] || '').toString();
  if(v.includes('ì•„ì‚°1')) return 'ì•„ì‚°1';
  if(v.includes('í‰íƒ')) return 'í‰íƒ';
  if(v.includes('ìˆ˜ì›')) return 'ìˆ˜ì›';
  if(v.includes('ì‚¬ë¬´ì‹¤')) return 'ì‚¬ë¬´ì‹¤';
  if(v.includes('ì˜ê³µì‹¤')) return 'ì˜ê³µì‹¤';
  if(v.includes('ì„¼í„°')) return 'ì„¼í„°';
  const m = v.match(/[1-6]/);
  return m ? m[0]+'íŒ€' : 'ê¸°íƒ€';
}

async function load() {
  allData = [];
  document.getElementById('status').innerText = 'â³ ì¥ë¹„ ì‹œíŠ¸ ì‹¤ì‹œê°„ ì½ëŠ” ì¤‘...';
  for (const [nm, gid] of Object.entries(SHEETS)) {
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res = await fetch(url);
      const csv = await res.text();
      const p = Papa.parse(csv.trim(), {header: true, skipEmptyLines: true});
      p.data.forEach(r => {
        if(r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸']) {
          allData.push({ ...r, _eq: nm, _loc: getLoc(r) });
        }
      });
    } catch (e) {}
  }
  document.getElementById('status').innerText = `âœ… ì´ ${allData.length}ëŒ€ ë¡œë“œ ì™„ë£Œ (1/27 í¬í•¨)`;
  show();
}

function setMode(m) {
  mode = m;
  document.getElementById('tab1').className = m==='equip'?'tab active':'tab';
  document.getElementById('tab2').className = m==='date'?'tab active':'tab';
  show();
}

function show() {
  const b = document.getElementById('searchBox');
  document.getElementById('results').innerHTML = '';
  if(mode === 'equip') {
    b.innerHTML = `<select id="es" onchange="uL()"><option value="">ì¥ë¹„ ì„ íƒ</option>${Object.keys(SHEETS).map(e=>`<option value="${e}">${e}</option>`).join('')}</select><div id="lb" style="display:none"><select id="ls" onchange="dS()"></select></div>`;
  } else showCal();
}

function uL() {
  const e = document.getElementById('es').value;
  if(!e) { document.getElementById('lb').style.display='none'; return; }
  const f = allData.filter(r => r._eq === e);
  const ls = [...new Set(f.map(r => r._loc))].sort();
  document.getElementById('ls').innerHTML = '<option value="">ì¥ì†Œ ì„ íƒ</option>' + ls.map(l=>`<option value="${l}">${l}</option>`).join('');
  document.getElementById('lb').style.display='block';
}

function dS() {
  const e = document.getElementById('es').value;
  const l = document.getElementById('ls').value;
  let f = allData.filter(r => r._eq === e && r._loc === l);
  document.getElementById('results').innerHTML = f.map(r => {
    const ks = Object.keys(r).filter(k => k.match(/^\d{1,2}[\/\-]\d{1,2}$/)).sort((a,b)=>b.localeCompare(a));
    const d = ks[0] || 'ê¸°ë¡ì—†ìŒ';
    const v = r[d] || 'ë‚´ìš©ì—†ìŒ';
    let st = 'ë³´ìœ ';
    if(v.includes('ë°˜ë‚©')) st = 'ë°˜ë‚©';
    else if(v.includes('ìˆ˜ë ¹')) st = 'ìˆ˜ë ¹';
    return `<div class="card"><div class="card-title">${r._loc} ${st} / ${r._eq} / ${r['ìì‚°ë²ˆí˜¸']||r['ìì‚° ë²ˆí˜¸']}</div><div class="card-content">${d} - ${checkIssue(v)?`<span class="issue-text">${v}</span>`:v}</div></div>`;
  }).join('');
}

function showCal() {
  const b = document.getElementById('searchBox');
  const issues = new Set();
  allData.forEach(r => {
    Object.keys(r).forEach(k => {
      if(k.match(/^\d{1,2}[\/\-]\d{1,2}$/) && checkIssue(r[k])) {
        const p = k.split(/[\/\-]/);
        issues.add(`${p[0].padStart(2,'0')}/${p[1].padStart(2,'0')}`);
      }
    });
  });
  const first = new Date(nowYear, nowMonth-1, 1).getDay();
  const last = new Date(nowYear, nowMonth, 0).getDate();
  let h = `<div class="cal-wrap"><div class="month-nav"><button onclick="mM(-1)">â—€</button><span>${nowYear}ë…„ ${nowMonth}ì›”</span><button onclick="mM(1)">â–¶</button></div><div class="calendar">`;
  ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d=>h+=`<div class="cal-h">${d}</div>`);
  for(let i=0; i<first; i++) h+='<div></div>';
  for(let d=1; d<=last; d++) {
    const s = `${nowMonth.toString().padStart(2,'0')}/${d.toString().padStart(2,'0')}`;
    h+=`<div class="cal-d ${issues.has(s)?'has-issue':''}" onclick="sD('${s}',this)">${d}</div>`;
  }
  b.innerHTML = h+'</div></div><div id="dr"></div>';
}

function mM(v) { nowMonth+=v; if(nowMonth>12){nowMonth=1;nowYear++;}else if(nowMonth<1){nowMonth=12;nowYear--;} showCal(); }

function sD(s, el) {
  document.querySelectorAll('.cal-d').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  const [m, d] = s.split('/').map(Number);
  const f = allData.filter(r => {
    const k = Object.keys(r).find(x => {
      const p = x.split(/[\/\-]/);
      return p.length===2 && Number(p[0])===m && Number(p[1])===d;
    });
    return k && checkIssue(r[k]);
  });
  document.getElementById('dr').innerHTML = f.map(r => {
    const k = Object.keys(r).find(x => x.includes(`${m}/${d}`) || x.includes(`${m}-${d}`));
    return `<div class="card"><div class="card-title">${r._loc} / ${r._eq}</div><div class="card-content issue-text">${r[k]}</div></div>`;
  }).join('') || '<p style="text-align:center;padding:20px;">íŠ¹ì´ì‚¬í•­ ì—†ìŒ</p>';
}
load();
</script>
</body>
</html>