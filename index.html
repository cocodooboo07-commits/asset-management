<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë¹„ ê´€ë¦¬</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 15px; background: #fff; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; }
    .tab.active { background: #d63031; color: white; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border-radius: 8px; overflow: hidden; }
    .cal-header { padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; font-size: 12px; }
    .cal-day { height: 60px; background: #fff; padding: 5px; text-align: left; font-size: 12px; cursor: pointer; position: relative; }
    .cal-day.issue { background: #ffe5e5; }
    .cal-day.issue::after { content: 'ğŸ”´'; position: absolute; bottom: 3px; right: 5px; font-size: 10px; }
    .cal-day.selected { background: #d63031 !important; color: white !important; }
    .card { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 8px solid #d63031; }
    .card-title { font-weight: bold; font-size: 15px; color: #333; margin-bottom: 5px; }
    .card-note { background: #fdf2f2; padding: 10px; border-radius: 5px; color: #d63031; font-weight: bold; font-size: 14px; border: 1px solid #ff7675; }
    .month-nav { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
    .month-nav button { padding: 10px 20px; background: #d63031; color: white; border: none; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
<div class="header" id="status">ë¡œë”©ì¤‘...</div>
<div class="tabs">
  <div class="tab active" onclick="setMode('equip')">ì¥ë¹„â†’ì¥ì†Œ</div>
  <div class="tab" onclick="setMode('date')">ë‚ ì§œë³„</div>
</div>
<div id="searchBox" class="box"></div>
<div id="results"></div>
<script>
const SID='1qJpWnVNBZIwnwZG4OD3JdUKytVq_4V6n';
const SHEETS={'ì²­ë ¥ê¸°':'1397804768','ì²­ë ¥ë¶€ìŠ¤':'1226463543','ì¤‘ì´ê¸°ê¸°':'1413774664','ì†ŒìŒê³„':'199554987','ì›ì‹¬ë¶„ë¦¬ê¸°':'1627219985','HRV':'816640230','EKG':'914024434','íí™œëŸ‰':'348975961','ì‹¤ë¦°ì§€':'874684579','í”„ë¦°í„°ê¸°':'70160554','ì—…ë¬´ìš©ë…¸íŠ¸ë¶':'811915899','ì™€ì´ë¸Œë¡œ':'1793948339'};
let data=[];
let mode='equip';
let year=2026;
let month=1;
const LOCS=['1','2','3','4','5','6','ì•„ì‚°1','í‰íƒ','ìˆ˜ì›','ì‚¬ë¬´ì‹¤','ì„¼í„°','ì˜ê³µì‹¤'];
const IGN=['íŠ¹ì´ì‚¬í•­ì—†ìŒ','íŠ¹ì´ì‚¬í•­ ì—†ìŒ','ì´ìƒì—†ìŒ','ì´ìƒ ì—†ìŒ','ì •ìƒ','ì™„ë£Œ','-','ì—†ìŒ'];

async function load(){
  data=[];
  document.getElementById('status').innerText='â³ ë¡œë”©ì¤‘...';
  for(const[nm,gid]of Object.entries(SHEETS)){
    try{
      const url=`https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res=await fetch(url,{cache:'no-store'});
      const csv=await res.text();
      const p=Papa.parse(csv.trim(),{header:true,skipEmptyLines:true});
      let cnt=0;
      p.data.forEach(r=>{
        const an=(r['ìì‚°ë²ˆí˜¸']||r['ìì‚° ë²ˆí˜¸']||'').trim();
        if(an&&an!==''){data.push({...r,_eq:nm});cnt++;}
      });
      console.log(`${nm}: ${cnt}ê°œ`);
    }catch(e){console.error(nm,'ì‹¤íŒ¨');}
  }
  document.getElementById('status').innerText=`âœ… ${data.length}ê°œ ë¡œë“œ`;
  console.log('ì´:',data.length);
  show();
}

function isIssue(t){
  if(!t||!t.trim())return false;
  const c=t.replace(/\s/g,'').toLowerCase();
  return!IGN.some(i=>i.replace(/\s/g,'').toLowerCase()===c);
}

function getLoc(r){
  const v=r['í˜„ì¬ìœ„ì¹˜']||r['í˜„ì¬ ìœ„ì¹˜']||'';
  if(!v)return'?';
  const s=v.toString().trim();
  if(s.includes('ì•„ì‚°1'))return'ì•„ì‚°1';
  if(s.includes('í‰íƒ'))return'í‰íƒ';
  if(s.includes('ìˆ˜ì›'))return'ìˆ˜ì›';
  if(s.includes('ì‚¬ë¬´ì‹¤'))return'ì‚¬ë¬´ì‹¤';
  if(s.includes('ì„¼í„°'))return'ì„¼í„°';
  if(s.includes('ì˜ê³µì‹¤'))return'ì˜ê³µì‹¤';
  const m=s.match(/(?:^|[^\d])([1-6])(?:[^\d]|$)/);
  if(m)return m[1];
  return'?';
}

function setMode(m){
  mode=m;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',false));
  event.target.classList.add('active');
  show();
}

function show(){
  const b=document.getElementById('searchBox');
  document.getElementById('results').innerHTML='';
  if(mode==='equip'){
    b.innerHTML=`<label>ì¥ë¹„</label><select id="es" onchange="uL()"><option value="">ì„ íƒ</option>${Object.keys(SHEETS).map(e=>`<option value="${e}">${e}</option>`).join('')}</select><div id="lb" style="display:none"><label>ì¥ì†Œ</label><select id="ls" onchange="dS()"><option value="">ì „ì²´</option></select></div>`;
  }else{
    showCal();
  }
}

function uL(){
  const e=document.getElementById('es').value;
  if(!e){document.getElementById('lb').style.display='none';document.getElementById('results').innerHTML='';return;}
  const f=data.filter(r=>r._eq===e);
  const ls=[...new Set(f.map(r=>getLoc(r)))].filter(l=>l!=='?').sort((a,b)=>{
    const an=parseInt(a),bn=parseInt(b);
    if(!isNaN(an)&&!isNaN(bn))return an-bn;
    if(!isNaN(an))return-1;
    if(!isNaN(bn))return 1;
    return a.localeCompare(b);
  });
  console.log(`${e} ì¥ì†Œ:`,ls);
  document.getElementById('ls').innerHTML='<option value="">ì „ì²´</option>'+ls.map(l=>`<option value="${l}">${isNaN(l)?l:l+'íŒ€'}</option>`).join('');
  document.getElementById('lb').style.display='block';
  dS();
}

function dS(){
  const e=document.getElementById('es').value;
  const l=document.getElementById('ls').value;
  let f=data.filter(r=>r._eq===e);
  if(l)f=f.filter(r=>getLoc(r)===l);
  document.getElementById('results').innerHTML=f.map(r=>{
    const loc=getLoc(r);
    const ks=Object.keys(r).filter(k=>k.match(/^\d{1,2}[\/\-]\d{1,2}$/)).sort().reverse();
    const ld=ks.find(k=>r[k]&&r[k].trim());
    const note=ld?r[ld]:'ê¸°ë¡ì—†ìŒ';
    let st='ë³´ìœ ';
    if(note.includes('ë°˜ë‚©'))st='ë°˜ë‚©';
    else if(note.includes('ìˆ˜ë ¹'))st='ìˆ˜ë ¹';
    const an=r['ìì‚°ë²ˆí˜¸']||r['ìì‚° ë²ˆí˜¸']||'';
    return`<div class="card"><div class="card-title">${loc}${isNaN(loc)?'':'íŒ€'} ${st} / ${r._eq} / ${an}</div><div class="card-note">${ld||'ìµœê·¼'}: ${note}</div></div>`;
  }).join('');
}

function showCal(){
  const b=document.getElementById('searchBox');
  const ids=new Set();
  data.forEach(r=>{
    Object.keys(r).forEach(k=>{
      if(k.match(/^\d{1,2}[\/\-]\d{1,2}$/)&&isIssue(r[k])){
        const p=k.trim().replace('-','/').split('/');
        ids.add(`${p[0].padStart(2,'0')}/${p[1].padStart(2,'0')}`);
      }
    });
  });
  console.log('íŠ¹ì´ì‚¬í•­:',Array.from(ids).sort());
  const fd=new Date(year,month-1,1).getDay();
  const ld=new Date(year,month,0).getDate();
  let h=`<div class="month-nav"><button onclick="mM(-1)">â—€</button><b>${year}ë…„ ${month}ì›”</b><button onclick="mM(1)">â–¶</button></div><div class="calendar">`;
  ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d=>h+=`<div class="cal-header">${d}</div>`);
  for(let i=0;i<fd;i++)h+='<div></div>';
  for(let d=1;d<=ld;d++){
    const ds=`${String(month).padStart(2,'0')}/${String(d).padStart(2,'0')}`;
    h+=`<div class="cal-day ${ids.has(ds)?'issue':''}" onclick="sD('${ds}',this)">${d}</div>`;
  }
  b.innerHTML=h+'</div><div id="dr"></div>';
}

function mM(v){
  month+=v;
  if(month>12){month=1;year++;}
  else if(month<1){month=12;year--;}
  showCal();
}

function sD(ds,el){
  document.querySelectorAll('.cal-day').forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');
  const[m,d]=ds.split('/');
  const ad=`${parseInt(m)}/${parseInt(d)}`;
  const f=data.filter(r=>{
    const k=Object.keys(r).find(x=>{
      const n=x.trim().replace('-','/');
      return(n===ds||n===ad)&&isIssue(r[x]);
    });
    return k!==undefined;
  });
  console.log(`${ds}:`,f.length);
  document.getElementById('dr').innerHTML=f.length===0?'<p style="padding:20px;text-align:center;">íŠ¹ì´ì‚¬í•­ ì—†ìŒ</p>':f.map(r=>{
    const k=Object.keys(r).find(x=>x.trim().replace('-','/')===ds||x.trim().replace('-','/')===ad);
    const loc=getLoc(r);
    const an=r['ìì‚°ë²ˆí˜¸']||r['ìì‚° ë²ˆí˜¸']||'';
    return`<div class="card"><div class="card-title">${loc}${isNaN(loc)?'':'íŒ€'} / ${r._eq} / ${an}</div><div class="card-note">${r[k]}</div></div>`;
  }).join('');
}

load();
</script>
</body>
</html>