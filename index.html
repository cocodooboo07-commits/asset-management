<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #f0f2f5; }
        .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 15px 5px; cursor: pointer; border: none; background: #ccc; font-weight: bold; border-radius: 8px; min-width: 100px; }
        .tab-btn.active { background: #007bff; color: white; }
        .content { display: none; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-height: 500px; }
        .content.active { display: block; }
        input, select { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .card { border-left: 6px solid #007bff; background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-title { font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 8px; }
        .card-info { font-size: 0.9em; color: #555; line-height: 1.6; }
        .memo { margin-top: 10px; padding: 10px; background: #fff1f0; border: 1px solid #ffa39e; border-radius: 5px; color: #cf1322; font-weight: bold; }
        #loading { text-align: center; padding: 30px; font-weight: bold; color: #007bff; font-size: 1.2em; }
    </style>
</head>
<body>

    <div class="tab-menu">
        <button class="tab-btn active" onclick="openTab('search-tab')">1. ìì‚°ë²ˆí˜¸ ê²€ìƒ‰</button>
        <button class="tab-btn" onclick="openTab('place-tab')">2. ì¥ì†Œ/ì¥ë¹„ë³„</button>
        <button class="tab-btn" onclick="initCalendar(); openTab('date-tab')">3. ë‚ ì§œë³„ ë‹¬ë ¥</button>
    </div>

    <div id="loading">ë°ì´í„° ë¡œë”© ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì‹­ì‡¼ í˜•ë‹˜!</div>

    <div id="search-tab" class="content active">
        <input type="text" id="assetInput" placeholder="ìì‚°ë²ˆí˜¸ ì…ë ¥..." onkeyup="searchByAsset()">
        <div id="searchResult"></div>
    </div>

    <div id="place-tab" class="content">
        <select id="typeSelect" onchange="filterByType()">
            <option value="">íƒ­ ì„ íƒ (ìˆ˜ì›, ì•„ì‚°1, ì²­ë ¥ê¸° ë“±...)</option>
        </select>
        <div id="placeResult"></div>
    </div>

    <div id="date-tab" class="content">
        <div id="calendar"></div>
        <div id="dateResult"></div>
    </div>

    <script>
        const sheetId = "12xhA0X6iOrg-4mq9KWZsQ9nPb2818P5VGUDXQMhjeTw";
        const sheetNames = ["ì²­ë ¥ê¸°","ì²­ë ¥ë¶€ìŠ¤","ì¤‘ì´ê¸°ê¸°","ì†ŒìŒê³„","ì›ì‹¬ë¶„ë¦¬ê¸°","HRV","EKG","íí™œëŸ‰","ì‹¤ë¦°ì§€","í”„ë¦°í„°ê¸°","ì—…ë¬´ìš©ë…¸íŠ¸ë¶","ì™€ì´ë¸Œë¡œ","ìˆ˜ì›","ì•„ì‚°1","í‰íƒ","ì‚¬ë¬´ì‹¤"];
        let allData = [];

        async function init() {
            const promises = sheetNames.map(name => {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`;
                return new Promise(resolve => {
                    Papa.parse(url, {
                        download: true, header: true,
                        complete: res => resolve(res.data.map(row => ({ ...row, _tab: name }))),
                        error: () => resolve([])
                    });
                });
            });
            const results = await Promise.all(promises);
            allData = results.flat().filter(row => Object.values(row).some(v => v));
            
            const sel = document.getElementById('typeSelect');
            sheetNames.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n; opt.text = n; sel.add(opt);
            });
            document.getElementById('loading').style.display = 'none';
        }

        function openTab(id) {
            document.querySelectorAll('.content, .tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'date-tab' && calendar) calendar.render();
        }

        function getVal(row, keyPart) {
            const k = Object.keys(row).find(k => k.replace(/\s/g, '').includes(keyPart));
            return row[k] || '';
        }

        function searchByAsset() {
            const val = document.getElementById('assetInput').value.toLowerCase();
            const res = allData.filter(row => getVal(row, 'ìì‚°ë²ˆí˜¸').toLowerCase().includes(val));
            render(res, 'searchResult');
        }

        function filterByType() {
            const val = document.getElementById('typeSelect').value;
            const res = allData.filter(row => row._tab === val);
            render(res, 'placeResult');
        }

        let calendar;
        function initCalendar() {
            if(calendar) return;
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'ko',
                events: (info, success) => {
                    let evts = [];
                    allData.forEach(row => {
                        Object.keys(row).forEach(k => {
                            if(/\d{1,2}\/\d{1,2}/.test(k) && row[k].trim()) {
                                const [m, d] = k.split('/');
                                evts.push({ start: `2025-${m.padStart(2,'0')}-${d.padStart(2,'0')}`, display: 'background', color: '#ff4d4f' });
                            }
                        });
                    });
                    success(evts);
                },
                dateClick: info => showDate(info.dateStr)
            });
            calendar.render();
        }

        function showDate(dateStr) {
            const [y, m, d] = dateStr.split('-');
            const searchKey = `${parseInt(m)}/${parseInt(d)}`;
            const res = allData.filter(row => {
                const k = Object.keys(row).find(k => k.includes(searchKey));
                return k && row[k].trim();
            });
            document.getElementById('dateResult').innerHTML = `<h3>ğŸ“… ${dateStr} íŠ¹ì´ì‚¬í•­</h3>`;
            render(res, 'dateResult', searchKey);
        }

        function render(data, targetId, dateKey = null) {
            const target = document.getElementById(targetId);
            if(!data.length) { target.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            target.innerHTML = data.map(row => {
                const memo = dateKey ? (Object.keys(row).find(k => k.includes(dateKey)) ? row[Object.keys(row).find(k => k.includes(dateKey))] : '') : '';
                return `
                    <div class="card">
                        <div class="card-title">${getVal(row, 'ìì‚°ë²ˆí˜¸')} <small>[${row._tab}]</small></div>
                        <div class="card-info">
                            <b>ê¸°ê¸°ëª…:</b> ${getVal(row, 'ê¸°ê¸°ëª…')}<br>
                            <b>ëª¨ë¸:</b> ${getVal(row, 'ëª¨ë¸')}<br>
                            <b>ìœ„ì¹˜:</b> ${getVal(row, 'í˜„ì¬ìœ„ì¹˜') || row._tab}
                        </div>
                        ${memo ? `<div class="memo">âš ï¸ íŠ¹ì´ì‚¬í•­: ${memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        init();
    </script>
</body>
</html>