<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>장비 관리 시스템 - 장소 분류 완결</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    label { font-size: 13px; font-weight: bold; color: #444; display: block; margin: 10px 0 5px 5px; }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 5px; background: #fff; }
    .card { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 10px; border-left: 10px solid #d63031; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .card-title { font-weight: bold; font-size: 14px; color: #222; margin-bottom: 8px; }
    .card-note { background: #fdf2f2; padding: 10px; border-radius: 6px; color: #d63031; font-size: 13px; border: 1px solid #ffcccc; font-weight: bold; }
    #status { font-size: 12px; text-align: center; margin-bottom: 5px; color: #666; }
  </style>
</head>
<body>

<div class="header">장비 관리 시스템 (1/28 최신)</div>
<div id="status">데이터 연결 중...</div>

<div class="box">
  <label>1. 장비 선택</label>
  <select id="selEquip" onchange="render()">
    <option value="">-- 장비 종류 선택 --</option>
  </select>
  
  <label>2. 장소 선택 (고정 분류)</label>
  <select id="selLoc" onchange="render()">
    <option value="">전체보기</option>
    <option value="1팀">1팀</option>
    <option value="2팀">2팀</option>
    <option value="3팀">3팀</option>
    <option value="4팀">4팀</option>
    <option value="5팀">5팀</option>
    <option value="6팀">6팀</option>
    <option value="의공실">의공실</option>
    <option value="사무실">사무실</option>
    <option value="아산1">아산1</option>
    <option value="센터">센터</option>
    <option value="평택">평택</option>
    <option value="수원">수원</option>
    <option value="미입력">미입력(빈칸)</option>
  </select>
</div>

<div id="results"></div>

<script>
const SID = '1qJpWnVNBZIwnwZG4OD3JdUKytVq_4V6n';
const SHEETS = {'청력기':'1397804768','청력부스':'1226463543','중이기기':'1413774664','소음계':'199554987','원심분리기':'1627219985','HRV':'816640230','EKG':'914024434','폐활량':'348975961','실린지':'874684579','프린터기':'70160554','업무용노트북':'811915899','와이브로':'1793948339'};
let allData = [];

// 최신 로그 추출 (1월 우선)
function getLatest(r) {
  const keys = Object.keys(r).filter(k => k.match(/^\d{1,2}[\/\-]\d{1,2}$/));
  const sorted = keys.sort((a,b) => {
    const [am, ad] = a.split(/[\/\-]/).map(Number);
    const [bm, bd] = b.split(/[\/\-]/).map(Number);
    return ((bm===1?13:bm)*100+bd) - ((am===1?13:am)*100+ad);
  });
  for(let k of sorted) {
    if(r[k] && r[k].trim() !== '') return { d: k, v: r[k] };
  }
  return { d: '기록없음', v: '내용없음' };
}

async function load() {
  allData = [];
  const selE = document.getElementById('selEquip');
  for (const [name, gid] of Object.entries(SHEETS)) {
    selE.innerHTML += `<option value="${name}">${name}</option>`;
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res = await fetch(url);
      const csv = await res.text();
      const p = Papa.parse(csv.trim(), {header: true, skipEmptyLines: true});
      p.data.forEach(r => {
        const asset = r['자산번호'] || r['자산 번호'];
        if(asset) {
          let loc = (r['현재위치'] || r['현재 위치'] || '').trim();
          allData.push({ ...r, _type: name, _loc: loc === '' ? '미입력' : loc, _asset: asset });
        }
      });
    } catch (e) {}
  }
  document.getElementById('status').innerText = `✅ 장비 약 230대 동기화 완료`;
}

function render() {
  const type = document.getElementById('selEquip').value;
  const loc = document.getElementById('selLoc').value;
  if(!type) return;

  let filtered = allData.filter(d => d._type === type);
  
  if(loc) {
    if(loc === '미입력') {
      filtered = filtered.filter(d => d._loc === '미입력');
    } else {
      // 장소 이름(1팀, 아산1 등)이 포함되어 있는지 확인
      const searchStr = loc.replace('팀', ''); 
      filtered = filtered.filter(d => d._loc.includes(searchStr));
    }
  }

  document.getElementById('results').innerHTML = filtered.map(d => {
    const log = getLatest(d);
    let st = '보유';
    if(log.v.includes('반납')) st = '반납';
    else if(log.v.includes('수령')) st = '수령';
    return `
      <div class="card">
        <div class="card-title">${d._loc} ${st} / ${d._type} / ${d._asset}</div>
        <div class="card-note">${log.d} : ${log.v}</div>
      </div>`;
  }).join('');
}

load();
</script>
</body>
</html>