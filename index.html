<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; font-size: 14px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 12px; background: #fff; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; font-size: 13px; }
    .tab.active { background: #d63031; color: white; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; gap: 1px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .cal-header { padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; font-size: 12px; }
    .cal-day { height: 60px; background: #fff; padding: 5px; text-align: left; font-size: 12px; cursor: pointer; position: relative; }
    .cal-day.issue { background: #fff0f0; }
    .cal-day.issue::after { content: 'âš ï¸'; position: absolute; bottom: 5px; right: 5px; font-size: 12px; color: #d63031; }
    .cal-day.selected { background: #d63031 !important; color: white !important; }
    .card { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 8px solid #d63031; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card.normal { border-left-color: #2d3436; }
    .card.issue { border-left-color: #d63031; background: #fff5f5; }
    .card-title { font-weight: bold; font-size: 15px; color: #333; margin-bottom: 5px; }
    .card-note { background: #fdf2f2; padding: 10px; border-radius: 5px; color: #d63031; font-weight: bold; font-size: 14px; border: 1px solid #ff7675; }
    .card-note.normal { background: #f8f9fa; color: #2d3436; border-color: #dfe6e9; }
    .month-nav { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
    .month-nav button { padding: 10px 20px; background: #d63031; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .download-btn { display: inline-block; margin-top: 10px; padding: 12px 24px; background: #00b894; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-decoration: none; }
    .download-btn:hover { background: #00a383; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #2d3436; }
    .modal-close { float: right; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
    .modal-close:hover { color: #000; }
    .recipient-btn { display: block; width: 100%; padding: 15px; margin: 8px 0; background: #f8f9fa; border: 2px solid #dfe6e9; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
    .recipient-btn:hover { background: #d63031; color: white; border-color: #d63031; }
    .equipment-checkbox { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
    .select-all-btn { padding: 10px 20px; background: #0984e3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px; }
    .select-all-btn:hover { background: #0770c9; }
    .send-email-btn { padding: 12px 30px; background: #00b894; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
    .send-email-btn:hover { background: #00a383; }
    .send-email-btn:disabled { background: #b2bec3; cursor: not-allowed; }
    .button-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; }
  </style>
</head>
<body>
<div class="header" id="status">ë°ì´í„° ì—°ê²° ì¤‘... (v2026-01-28 19:25)</div>
<div class="tabs">
  <div class="tab active" id="tab-equip" onclick="setMode('equip')">ì¥ë¹„ â†’ ì¥ì†Œ</div>
  <div class="tab" id="tab-location" onclick="setMode('location')">ì¥ì†Œ</div>
  <div class="tab" id="tab-date" onclick="setMode('date')">ë‚ ì§œë³„ ê¸°ë¡</div>
</div>
<div id="searchBox" class="box"></div>
<div id="results"></div>

<!-- ë©”ì¼ ìˆ˜ì‹ ì ì„ íƒ ëª¨ë‹¬ -->
<div id="emailModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeEmailModal()">&times;</span>
    <div class="modal-title">ğŸ“§ ìˆ˜ì‹ ì ì„ íƒ</div>
    <div id="recipientList"></div>
  </div>
</div>

<script>
const SHEET_ID = '12xhA0X6iOrg-4mq9KWZsQ9nPb2818P5VGUDXQMhjeTw';
const SHEETS = { 
  'ì²­ë ¥ê¸°': '1720829217', 'ì²­ë ¥ë¶€ìŠ¤': '783939503', 'ì¤‘ì´ê¸°ê¸°': '951007328', 
  'ì†ŒìŒê³„': '389015843', 'ì›ì‹¬ë¶„ë¦¬ê¸°': '1430550353', 'HRV': '575182905', 
  'EKG': '37674733', 'íí™œëŸ‰': '2106009043', 'ì‹¤ë¦°ì§€': '829162327', 
  'í”„ë¦°í„°ê¸°': '283353512', 'ì—…ë¬´ìš©ë…¸íŠ¸ë¶': '239338022', 'ì™€ì´ë¸Œë¡œ': '763688386' 
};

let allData = [];
let mode = 'equip';
let currentYear = 2026;
let currentMonth = 1;
const IGNORE_TEXT = ["íŠ¹ì´ì‚¬í•­ì—†ìŒ", "íŠ¹ì´ì‚¬í•­ ì—†ìŒ", "ì´ìƒì—†ìŒ", "ì´ìƒ ì—†ìŒ"];
const FIXED_LOCATIONS = ['1', '2', '3', '4', '5', '6', 'í‰íƒ', 'ìˆ˜ì›', 'ì•„ì‚°1', 'ì‚¬ë¬´ì‹¤', 'ì˜ê³µì‹¤', 'ì„¼í„°', 'ë¯¸ì„ íƒ'];

// Google Apps Script ì›¹ ì•± URL (ë°°í¬ í›„ ì—¬ê¸°ì— URL ì…ë ¥)
const APPS_SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL';

// ë©”ì¼ ë°œì‹ ì ëª©ë¡ (ë³´ë‚´ëŠ” ì‚¬ëŒ ì„ íƒìš©)
const EMAIL_SENDERS = {
  'ê¹€ë¯¼ì² ': 'minchul.kim@company.com',
  'ì´ì˜í¬': 'younghee.lee@company.com',
  'ë°•ì² ìˆ˜': 'chulsoo.park@company.com'
};

// ë©”ì¼ ìˆ˜ì‹ ì ëª©ë¡ (ë°›ëŠ” ì‚¬ëŒ ì„ íƒìš©)
const EMAIL_RECIPIENTS = {
  'ê¹€ë¯¼ì² ': 'minchul.kim@company.com',
  'ì´ì˜í¬': 'younghee.lee@company.com',
  'ë°•ì² ìˆ˜': 'chulsoo.park@company.com',
  'ìµœì§€ì˜': 'jiyoung.choi@company.com',
  'ì •ìˆ˜í˜„': 'soohyun.jung@company.com',
  'ë³¸ë¶€ì¥': 'director@company.com'
};

async function load() {
  allData = [];
  const startTime = new Date();
  document.getElementById('status').innerText = 'Loading... (v2026-01-28 19:15)';
  
  for (const [name, gid] of Object.entries(SHEETS)) {
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      const csv = await res.text();
      const parsed = Papa.parse(csv.trim(), { header: true, skipEmptyLines: true });
      
      parsed.data.forEach(row => {
        const assetNum = row['ìì‚°ë²ˆí˜¸'] || row['ìì‚° ë²ˆí˜¸'] || '';
        if (assetNum && assetNum.trim()) {
          allData.push({ ...row, _equip: name });
        }
      });
    } catch (e) {
      console.error(name + ' failed:', e);
    }
  }
  
  const loadTime = ((new Date() - startTime) / 1000).toFixed(1);
  document.getElementById('status').innerText = allData.length + ' devices (' + loadTime + 's) - v2026-01-28 19:15';
  show();
}

function isRealIssue(text) {
  if (!text || !text.trim()) return false;
  const clean = text.replace(/\s/g, "").toLowerCase();
  
  // ì •í™•íˆ "íŠ¹ì´ì‚¬í•­ ì—†ìŒ" ë˜ëŠ” "ì´ìƒ ì—†ìŒ"ë§Œ ì œì™¸
  for (const ig of IGNORE_TEXT) {
    const cleanIgnore = ig.replace(/\s/g, "").toLowerCase();
    if (clean === cleanIgnore || clean.includes(cleanIgnore)) {
      return false;
    }
  }
  
  return true;
}

function parseCurrentLocation(row) {
  const val = row['í˜„ì¬ìœ„ì¹˜'] || row['í˜„ì¬ ìœ„ì¹˜'] || '';
  if (!val || !val.trim()) return { location: "ë¯¸ì„ íƒ", date: null };
  
  const str = val.toString().trim();
  const dateMatch = str.match(/\((\d{1,2})\/(\d{1,2})\)/);
  const date = dateMatch ? dateMatch[1].padStart(2, '0') + '/' + dateMatch[2].padStart(2, '0') : null;
  
  const cleanStr = str.replace(/\(.*?\)/g, '').trim();
  
  let location = "ë¯¸ì„ íƒ";
  if (cleanStr.includes('ì•„ì‚°1')) location = 'ì•„ì‚°1';
  else if (cleanStr.includes('í‰íƒ')) location = 'í‰íƒ';
  else if (cleanStr.includes('ìˆ˜ì›')) location = 'ìˆ˜ì›';
  else if (cleanStr.includes('ì‚¬ë¬´ì‹¤')) location = 'ì‚¬ë¬´ì‹¤';
  else if (cleanStr.includes('ì„¼í„°')) location = 'ì„¼í„°';
  else if (cleanStr.includes('ì˜ê³µì‹¤')) location = 'ì˜ê³µì‹¤';
  else {
    const match = cleanStr.match(/(?:^|[^\d])([1-6])(?:íŒ€|[^\d]|$)/);
    if (match) location = match[1];
  }
  
  return { location, date };
}

function getEquipmentNumber(row) {
  const equipName = row['ê¸°ê¸°ëª…'] || '';
  const match = equipName.match(/\((\d+)\)/);
  return match ? match[1] : '';
}

function getDetailByDate(row, targetDate) {
  if (!targetDate) return null;
  const dateKeys = Object.keys(row).filter(k => k.match(/^\d{1,2}[\/\-]\d{1,2}$/));
  
  for (const key of dateKeys) {
    const normalized = key.trim().replace('-', '/').split('/').map(p => p.padStart(2, '0')).join('/');
    if (normalized === targetDate && row[key] && row[key].trim()) {
      return row[key].trim();
    }
  }
  return null;
}

function setMode(m) {
  mode = m;
  document.getElementById('tab-equip').classList.toggle('active', m === 'equip');
  document.getElementById('tab-location').classList.toggle('active', m === 'location');
  document.getElementById('tab-date').classList.toggle('active', m === 'date');
  show();
}

function show() {
  const b = document.getElementById('searchBox');
  document.getElementById('results').innerHTML = '';
  
  if (mode === 'equip') {
    // ê° ì¥ë¹„ë³„ ê°œìˆ˜ ê³„ì‚°
    const equipCounts = {};
    Object.keys(SHEETS).forEach(name => {
      equipCounts[name] = allData.filter(r => r._equip === name).length;
    });
    
    b.innerHTML = '<label>ì¥ë¹„ ì„ íƒ</label><select id="es" onchange="updateLocations()"><option value="">ì„ íƒ</option>' + Object.keys(SHEETS).map(e => '<option value="' + e + '">' + e + ' (' + equipCounts[e] + 'ê°œ)</option>').join('') + '</select><div id="lb" style="display:none"><label>ì¥ì†Œ í•„í„°</label><select id="ls" onchange="displayResults()"><option value="">ì¥ì†Œ ì„ íƒ</option></select></div>';
  } else if (mode === 'location') {
    // ê° ì¥ì†Œë³„ ê°œìˆ˜ ê³„ì‚°
    const locationCounts = {};
    FIXED_LOCATIONS.forEach(loc => {
      locationCounts[loc] = allData.filter(r => parseCurrentLocation(r).location === loc).length;
    });
    
    b.innerHTML = '<label>ì¥ì†Œ ì„ íƒ</label><select id="locationSelect" onchange="displayLocationResults()"><option value="">ì„ íƒ</option>' + FIXED_LOCATIONS.map(l => '<option value="' + l + '">' + (/^[1-6]$/.test(l) ? l + 'íŒ€' : l) + ' (' + locationCounts[l] + 'ê°œ)</option>').join('') + '</select>';
  } else {
    showCalendar();
  }
}

function updateLocations() {
  const eq = document.getElementById('es').value;
  if (!eq) {
    document.getElementById('lb').style.display = 'none';
    document.getElementById('results').innerHTML = '';
    return;
  }
  
  // í•´ë‹¹ ì¥ë¹„ì˜ ì¥ì†Œë³„ ê°œìˆ˜ ê³„ì‚°
  const locationCounts = {};
  FIXED_LOCATIONS.forEach(loc => {
    locationCounts[loc] = allData.filter(r => r._equip === eq && parseCurrentLocation(r).location === loc).length;
  });
  
  document.getElementById('ls').innerHTML = '<option value="">ì¥ì†Œ ì„ íƒ</option>' + FIXED_LOCATIONS.map(l => '<option value="' + l + '">' + (/^[1-6]$/.test(l) ? l + 'íŒ€' : l) + ' (' + locationCounts[l] + 'ê°œ)</option>').join('');
  document.getElementById('lb').style.display = 'block';
  document.getElementById('results').innerHTML = '';
}

function displayResults() {
  const eq = document.getElementById('es').value;
  const loc = document.getElementById('ls').value;
  
  if (!loc) {
    document.getElementById('results').innerHTML = '<p style="padding:20px; text-align:center; color:#999;">ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>';
    return;
  }
  
  let found = allData.filter(r => r._equip === eq && parseCurrentLocation(r).location === loc);
  
  if (found.length === 0) {
    document.getElementById('results').innerHTML = '<p style="padding:20px; text-align:center; color:#999;">í•´ë‹¹ ì¥ì†Œì— ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    return;
  }
  
  document.getElementById('results').innerHTML = found.map(r => {
    const data = parseCurrentLocation(r);
    const locName = /^[1-6]$/.test(data.location) ? data.location + 'íŒ€' : data.location;
    const assetNum = r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '';
    const equipNum = getEquipmentNumber(r);
    const detail = data.date ? getDetailByDate(r, data.date) : null;
    
    let state = "ë³´ìœ ";
    if (detail) {
      if (detail.includes("ë°˜ë‚©")) state = "ë°˜ë‚©";
      else if (detail.includes("ìˆ˜ë ¹")) state = "ìˆ˜ë ¹";
    }
    
    let person = "", issue = detail || "ê¸°ë¡ ì—†ìŒ";
    if (detail) {
      const match = detail.match(/\(([^-]+)-([^)]+)\)/) || detail.match(/([ê°€-í£]+)\s*-\s*(.+)/);
      if (match) {
        person = match[1].trim();
        issue = match[2].trim();
      }
    }
    
    const equipDisplay = equipNum ? r._equip + '(' + equipNum + ')' : r._equip;
    const hasIssue = detail && isRealIssue(detail);
    const cardClass = hasIssue ? 'card issue' : 'card normal';
    const noteClass = hasIssue ? 'card-note' : 'card-note normal';
    
    return '<div class="' + cardClass + '"><div class="card-title">' + locName + ' ' + state + ' / ' + equipDisplay + ' / ' + assetNum + '</div><div class="' + noteClass + '">' + (data.date || 'ìµœê·¼') + ' ' + (person ? person + ' - ' : '') + issue + '</div></div>';
  }).join('');
}

function displayLocationResults() {
  const loc = document.getElementById('locationSelect').value;
  if (!loc) {
    document.getElementById('results').innerHTML = '';
    return;
  }
  
  let found = allData.filter(r => parseCurrentLocation(r).location === loc);
  if (found.length === 0) {
    document.getElementById('results').innerHTML = '<p style="padding:20px; text-align:center; color:#999;">í•´ë‹¹ ì¥ì†Œì— ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    return;
  }
  
  // ë²„íŠ¼ ê·¸ë£¹ ì¶”ê°€
  let html = '<div class="button-group">';
  html += '<div>';
  html += '<button class="select-all-btn" onclick="selectAllEquipment(true)">âœ“ ì „ì²´ì„ íƒ</button>';
  html += '<button class="select-all-btn" onclick="selectAllEquipment(false)">âœ— ì „ì²´í•´ì œ</button>';
  html += '</div>';
  html += '<button class="send-email-btn" onclick="showEmailModalWithSelection(\'' + loc + '\')">ğŸ“§ ì„ íƒí•­ëª© ë©”ì¼ ì „ì†¡</button>';
  html += '</div>';
  
  html += found.map((r, idx) => {
    const data = parseCurrentLocation(r);
    const locName = /^[1-6]$/.test(data.location) ? data.location + 'íŒ€' : data.location;
    const assetNum = r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '';
    const equipNum = getEquipmentNumber(r);
    const detail = data.date ? getDetailByDate(r, data.date) : null;
    
    let state = "ë³´ìœ ";
    if (detail) {
      if (detail.includes("ë°˜ë‚©")) state = "ë°˜ë‚©";
      else if (detail.includes("ìˆ˜ë ¹")) state = "ìˆ˜ë ¹";
    }
    
    let person = "", issue = detail || "ê¸°ë¡ ì—†ìŒ";
    if (detail) {
      const match = detail.match(/\(([^-]+)-([^)]+)\)/) || detail.match(/([ê°€-í£]+)\s*-\s*(.+)/);
      if (match) {
        person = match[1].trim();
        issue = match[2].trim();
      }
    }
    
    const equipDisplay = equipNum ? r._equip + '(' + equipNum + ')' : r._equip;
    const hasIssue = detail && isRealIssue(detail);
    const cardClass = hasIssue ? 'card issue' : 'card normal';
    const noteClass = hasIssue ? 'card-note' : 'card-note normal';
    
    // ì—‘ì…€ ì „ì†¡ìš© ë°ì´í„°
    const equipData = JSON.stringify({
      '': '',
      'ê¸°ê¸°ëª…': r['ê¸°ê¸°ëª…'] || '',
      'ëª¨ë¸': r['ëª¨ë¸'] || '',
      'ì œì¡°ë²ˆí˜¸': r['ì œì¡°ë²ˆí˜¸'] || r['ì œì¡° ë²ˆí˜¸'] || '',
      'ìì‚°ë²ˆí˜¸': assetNum,
      'í˜„ì¬ìœ„ì¹˜': r['í˜„ì¬ìœ„ì¹˜'] || r['í˜„ì¬ ìœ„ì¹˜'] || ''
    }).replace(/'/g, '&apos;');
    
    return '<div class="' + cardClass + '" style="display: flex; align-items: center;"><input type="checkbox" class="equipment-checkbox" data-equipment=\'' + equipData + '\' checked><div style="flex: 1;"><div class="card-title">' + locName + ' ' + state + ' / ' + equipDisplay + ' / ' + assetNum + '</div><div class="' + noteClass + '">' + (data.date || 'ìµœê·¼') + ' ' + (person ? person + ' - ' : '') + issue + '</div></div></div>';
  }).join('');
  
  document.getElementById('results').innerHTML = html;
}

// ì „ì²´ ì„ íƒ/í•´ì œ
function selectAllEquipment(checked) {
  document.querySelectorAll('.equipment-checkbox').forEach(cb => cb.checked = checked);
}

let currentLocation = null;
let selectedSender = null;

function showEmailModalWithSelection(location) {
  // ì„ íƒëœ ì¥ë¹„ í™•ì¸
  const selectedCheckboxes = document.querySelectorAll('.equipment-checkbox:checked');
  
  if (selectedCheckboxes.length === 0) {
    alert('âš ï¸ ì „ì†¡í•  ì¥ë¹„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
    return;
  }
  
  currentLocation = location;
  const modal = document.getElementById('emailModal');
  const recipientList = document.getElementById('recipientList');
  
  // 1ë‹¨ê³„: ë°œì‹ ì ì„ íƒ
  recipientList.innerHTML = '<div style="margin-bottom: 20px; font-size: 18px; font-weight: bold; color: #2d3436;">1ï¸âƒ£ ë³´ë‚´ëŠ” ì‚¬ëŒ ì„ íƒ</div><div style="margin-bottom: 15px; padding: 10px; background: #f0f3ff; border-radius: 8px; color: #0984e3; font-weight: bold;">âœ“ ' + selectedCheckboxes.length + 'ê°œ ì¥ë¹„ ì„ íƒë¨</div>' + Object.keys(EMAIL_SENDERS).map(name => 
    '<button class="recipient-btn" onclick="selectSender(\'' + name + '\')">' + name + '<br><small style="color:#636e72;">' + EMAIL_SENDERS[name] + '</small></button>'
  ).join('');
  
  modal.style.display = 'block';
}

function selectSender(senderName) {
  selectedSender = senderName;
  const recipientList = document.getElementById('recipientList');
  
  // 2ë‹¨ê³„: ìˆ˜ì‹ ì ì„ íƒ
  recipientList.innerHTML = '<div style="margin-bottom: 15px; padding: 10px; background: #e8f5e9; border-radius: 8px; color: #27ae60; font-weight: bold;">ğŸ“¤ ë³´ë‚´ëŠ” ì‚¬ëŒ: ' + senderName + '</div><div style="margin-bottom: 20px; font-size: 18px; font-weight: bold; color: #2d3436;">2ï¸âƒ£ ë°›ëŠ” ì‚¬ëŒ ì„ íƒ</div>' + Object.keys(EMAIL_RECIPIENTS).map(name => 
    '<button class="recipient-btn" onclick="sendEmailWithSelection(\'' + name + '\')">' + name + '<br><small style="color:#636e72;">' + EMAIL_RECIPIENTS[name] + '</small></button>'
  ).join('');
}

function showEmailModal(location) {
  currentLocation = location;
  const modal = document.getElementById('emailModal');
  const recipientList = document.getElementById('recipientList');
  
  // ìˆ˜ì‹ ì ë²„íŠ¼ ìƒì„±
  recipientList.innerHTML = Object.keys(EMAIL_RECIPIENTS).map(name => 
    '<button class="recipient-btn" onclick="sendEmail(\'' + name + '\')">' + name + '<br><small style="color:#636e72;">' + EMAIL_RECIPIENTS[name] + '</small></button>'
  ).join('');
  
  modal.style.display = 'block';
}

function closeEmailModal() {
  document.getElementById('emailModal').style.display = 'none';
}

async function sendEmailWithSelection(recipientName) {
  const recipient = EMAIL_RECIPIENTS[recipientName];
  const sender = EMAIL_SENDERS[selectedSender];
  const senderName = selectedSender;
  const location = currentLocation;
  const locName = /^[1-6]$/.test(location) ? location + 'íŒ€' : location;
  
  if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL') {
    alert('âš ï¸ Google Apps Script URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
    return;
  }
  
  if (!selectedSender) {
    alert('âš ï¸ ë°œì‹ ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
    return;
  }
  
  // ì„ íƒëœ ì¥ë¹„ë§Œ ê°€ì ¸ì˜¤ê¸°
  const selectedCheckboxes = document.querySelectorAll('.equipment-checkbox:checked');
  const selectedEquipment = Array.from(selectedCheckboxes).map(cb => 
    JSON.parse(cb.getAttribute('data-equipment').replace(/&apos;/g, "'"))
  );
  
  if (selectedEquipment.length === 0) {
    alert('âš ï¸ ì „ì†¡í•  ì¥ë¹„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
    return;
  }
  
  // ë¡œë”© í‘œì‹œ
  const modal = document.getElementById('emailModal');
  modal.querySelector('.modal-content').innerHTML = '<div style="text-align:center; padding:40px;"><div style="font-size:40px;">ğŸ“§</div><div style="margin-top:20px; font-size:18px; font-weight:bold;">ë©”ì¼ ì „ì†¡ ì¤‘...</div><div style="margin-top:10px; color:#636e72;">' + selectedEquipment.length + 'ê°œ ì¥ë¹„</div></div>';
  
  try {
    // ì—‘ì…€ ìƒì„±
    const ws = XLSX.utils.json_to_sheet(selectedEquipment);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, locName);
    
    // Base64ë¡œ ë³€í™˜
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
    const fileName = locName + '_ì¥ë¹„ëª©ë¡_' + selectedEquipment.length + 'ê°œ_' + new Date().toISOString().slice(0, 10) + '.xlsx';
    
    // Apps Scriptë¡œ ì „ì†¡ (ë°œì‹ ì ì •ë³´ í¬í•¨)
    const response = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        recipient: recipient,
        sender: sender,
        senderName: senderName,
        locationName: locName,
        excelBase64: wbout,
        fileName: fileName
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      modal.querySelector('.modal-content').innerHTML = '<div style="text-align:center; padding:40px;"><div style="font-size:60px;">âœ…</div><div style="margin-top:20px; font-size:18px; font-weight:bold; color:#00b894;">ë©”ì¼ ì „ì†¡ ì™„ë£Œ!</div><div style="margin-top:10px; color:#636e72;">' + senderName + ' â†’ ' + recipientName + '<br>' + selectedEquipment.length + 'ê°œ ì¥ë¹„ ì „ì†¡</div><button class="download-btn" onclick="closeEmailModal()" style="margin-top:20px;">ë‹«ê¸°</button></div>';
    } else {
      throw new Error(result.message);
    }
    
  } catch (error) {
    modal.querySelector('.modal-content').innerHTML = '<div style="text-align:center; padding:40px;"><div style="font-size:60px;">âŒ</div><div style="margin-top:20px; font-size:18px; font-weight:bold; color:#d63031;">ì „ì†¡ ì‹¤íŒ¨</div><div style="margin-top:10px; color:#636e72;">' + error.message + '</div><button class="download-btn" onclick="closeEmailModal()" style="margin-top:20px;">ë‹«ê¸°</button></div>';
  }
}

async function sendEmail(recipientName) {
  const recipient = EMAIL_RECIPIENTS[recipientName];
  const location = currentLocation;
  const locName = /^[1-6]$/.test(location) ? location + 'íŒ€' : location;
  
  if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL') {
    alert('âš ï¸ Google Apps Script URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
    return;
  }
  
  // ë¡œë”© í‘œì‹œ
  const modal = document.getElementById('emailModal');
  modal.querySelector('.modal-content').innerHTML = '<div style="text-align:center; padding:40px;"><div style="font-size:40px;">ğŸ“§</div><div style="margin-top:20px; font-size:18px; font-weight:bold;">ë©”ì¼ ì „ì†¡ ì¤‘...</div></div>';
  
  try {
    // ì—‘ì…€ ë°ì´í„° ìƒì„±
    const found = allData.filter(r => parseCurrentLocation(r).location === location);
    const excelData = found.map(r => ({
      '': '',
      'ê¸°ê¸°ëª…': r['ê¸°ê¸°ëª…'] || '',
      'ëª¨ë¸': r['ëª¨ë¸'] || '',
      'ì œì¡°ë²ˆí˜¸': r['ì œì¡°ë²ˆí˜¸'] || r['ì œì¡° ë²ˆí˜¸'] || '',
      'ìì‚°ë²ˆí˜¸': r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '',
      'í˜„ì¬ìœ„ì¹˜': r['í˜„ì¬ìœ„ì¹˜'] || r['í˜„ì¬ ìœ„ì¹˜'] || ''
    }));
    
    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, locName);
    
    // ì—‘ì…€ì„ Base64ë¡œ ë³€í™˜
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
    const fileName = locName + '_ì¥ë¹„ëª©ë¡_' + new Date().toISOString().slice(0, 10) + '.xlsx';
    
    // Apps Scriptë¡œ ì „ì†¡
    const response = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        recipient: recipient,
        locationName: locName,
        excelBase64: wbout,
        fileName: fileName
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      modal.querySelector('.modal-content').innerHTML = '<div style="text-align:center; padding:40px;"><div style="font-size:60px;">âœ…</div><div style="margin-top:20px; font-size:18px; font-weight:bold; color:#00b894;">ë©”ì¼ ì „ì†¡ ì™„ë£Œ!</div><div style="margin-top:10px; color:#636e72;">' + recipientName + 'ë‹˜ê»˜ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</div><button class="download-btn" onclick="closeEmailModal()" style="margin-top:20px;">ë‹«ê¸°</button></div>';
    } else {
      throw new Error(result.message);
    }
    
  } catch (error) {
    modal.querySelector('.modal-content').innerHTML = '<div style="text-align:center; padding:40px;"><div style="font-size:60px;">âŒ</div><div style="margin-top:20px; font-size:18px; font-weight:bold; color:#d63031;">ì „ì†¡ ì‹¤íŒ¨</div><div style="margin-top:10px; color:#636e72;">' + error.message + '</div><button class="download-btn" onclick="closeEmailModal()" style="margin-top:20px;">ë‹«ê¸°</button></div>';
  }
}

function showCalendar() {
  const b = document.getElementById('searchBox');
  const issueDates = new Set();
  
  allData.forEach(r => {
    const data = parseCurrentLocation(r);
    if (data.date) {
      const detail = getDetailByDate(r, data.date);
      if (detail && isRealIssue(detail)) {
        issueDates.add(data.date);
      }
    }
  });
  
  const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
  const lastDate = new Date(currentYear, currentMonth, 0).getDate();
  
  let html = '<div class="month-nav"><button onclick="moveMonth(-1)">â—€</button><b>' + currentYear + 'ë…„ ' + currentMonth + 'ì›”</b><button onclick="moveMonth(1)">â–¶</button></div><div class="calendar">';
  
  ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(d => { html += '<div class="cal-header">' + d + '</div>'; });
  
  for (let i = 0; i < firstDay; i++) html += '<div></div>';
  
  for (let d = 1; d <= lastDate; d++) {
    const dateStr = String(currentMonth).padStart(2, '0') + '/' + String(d).padStart(2, '0');
    html += '<div class="cal-day' + (issueDates.has(dateStr) ? ' issue' : '') + '" onclick="selectDate(\'' + dateStr + '\', this)">' + d + '</div>';
  }
  
  html += '</div><div id="dateRes"></div>';
  b.innerHTML = html;
}

function moveMonth(direction) {
  currentMonth += direction;
  if (currentMonth > 12) { currentMonth = 1; currentYear++; }
  else if (currentMonth < 1) { currentMonth = 12; currentYear--; }
  showCalendar();
}

function selectDate(dateStr, element) {
  document.querySelectorAll('.cal-day').forEach(x => x.classList.remove('selected'));
  element.classList.add('selected');
  
  const found = allData.filter(r => {
    const data = parseCurrentLocation(r);
    if (data.date !== dateStr) return false;
    const detail = getDetailByDate(r, data.date);
    return detail && isRealIssue(detail);
  });
  
  if (found.length === 0) {
    document.getElementById('dateRes').innerHTML = '<p style="padding:20px; text-align:center;">íŠ¹ì´ì‚¬í•­ ì—†ìŒ</p>';
    return;
  }
  
  document.getElementById('dateRes').innerHTML = found.map(r => {
    const data = parseCurrentLocation(r);
    const locName = /^[1-6]$/.test(data.location) ? data.location + 'íŒ€' : data.location;
    const assetNum = r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '';
    const equipNum = getEquipmentNumber(r);
    const equipDisplay = equipNum ? r._equip + '(' + equipNum + ')' : r._equip;
    const detail = getDetailByDate(r, data.date);
    
    return '<div class="card issue"><div class="card-title">' + locName + ' / ' + equipDisplay + ' / ' + assetNum + '</div><div class="card-note">' + detail + '</div></div>';
  }).join('');
}

load();
</script>
</body>
</html>