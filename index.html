<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë¹„ê´€ë¦¬ í†µí•© ì‹œìŠ¤í…œ (ìµœì¢…)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #f0f2f5; }
        .status-bar { background: #000; color: #0f0; padding: 12px; font-size: 14px; text-align: center; border-bottom: 2px solid #0f0; position: sticky; top: 0; z-index: 100; }
        .tab-menu { display: flex; gap: 5px; margin: 10px 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #dfe6e9; font-weight: bold; border-radius: 5px; cursor: pointer; }
        .tab-btn.active { background: #d63031; color: white; }
        .content { display: none; background: white; padding: 15px; border-radius: 10px; min-height: 400px; }
        .content.active { display: block; }
        select, input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        .card { border-left: 8px solid #0984e3; background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card-title { font-weight: bold; margin-bottom: 5px; color: #2d3436; }
        .memo-box { background: #fff5f5; border: 1px solid #ff7675; padding: 8px; border-radius: 4px; color: #d63031; font-size: 14px; }
        .date-header { font-size: 1.2em; font-weight: bold; color: #e84118; margin: 15px 0; text-align: center; }
    </style>
</head>
<body>

<div class="status-bar" id="statusBar">â³ ë°ì´í„° ì „ìˆ˜ ë™ê¸°í™” ì¤‘...</div>

<div class="tab-menu">
    <button class="tab-btn active" onclick="openTab('place-tab')">ğŸ“ ì¥ì†Œ/ì¥ë¹„</button>
    <button class="tab-btn" onclick="openTab('search-tab')">ğŸ” ìì‚°ê²€ìƒ‰</button>
    <button class="tab-btn" onclick="initCalendar(); openTab('date-tab')">ğŸ“… ë‚ ì§œë³„</button>
</div>

<div id="place-tab" class="content active">
    <select id="locSelect" onchange="filterComplex()">
        <option value="">1. ì¥ì†Œ ì„ íƒ (ì „ì²´)</option>
        <option value="ìˆ˜ì›">ìˆ˜ì›</option><option value="ì•„ì‚°1">ì•„ì‚°1</option>
        <option value="í‰íƒ">í‰íƒ</option><option value="ì‚¬ë¬´ì‹¤">ì‚¬ë¬´ì‹¤</option>
    </select>
    <select id="devSelect" onchange="filterComplex()">
        <option value="">2. ì¥ë¹„ ì„ íƒ (ì „ì²´)</option>
        <option value="ì²­ë ¥">ì²­ë ¥ê¸°</option><option value="ì¤‘ì´">ì¤‘ì´ê¸°ê¸°</option>
        <option value="ì†ŒìŒ">ì†ŒìŒê³„</option><option value="ì›ì‹¬">ì›ì‹¬ë¶„ë¦¬ê¸°</option>
        <option value="HRV">HRV</option><option value="EKG">EKG</option>
        <option value="íí™œëŸ‰">íí™œëŸ‰</option><option value="í”„ë¦°í„°">í”„ë¦°í„°ê¸°</option>
        <option value="ë…¸íŠ¸ë¶">ë…¸íŠ¸ë¶</option>
    </select>
    <div id="placeResult"></div>
</div>

<div id="search-tab" class="content">
    <input type="text" id="assetInput" placeholder="ìì‚°ë²ˆí˜¸ ì…ë ¥..." onkeyup="searchByAsset()">
    <div id="searchResult"></div>
</div>

<div id="date-tab" class="content">
    <div id="calendar"></div>
    <div id="dateResult"></div>
</div>

<script>
    const sheetId = "12xhA0X6iOrg-4mq9KWZsQ9nPb2818P5VGUDXQMhjeTw";
    const sheetGids = [
        {n:"ì²­ë ¥",g:"1397804768"},{n:"ì²­ë ¥ë¶€ìŠ¤",g:"1226463543"},{n:"ì¤‘ì´",g:"1413774664"},
        {n:"ì†ŒìŒ",g:"199554987"},{n:"ì›ì‹¬",g:"1627219985"},{n:"HRV",g:"816640230"},
        {n:"EKG",g:"914024434"},{n:"íí™œëŸ‰",g:"348975961"},{n:"ì‹¤ë¦°ì§€",g:"874684579"},
        {n:"í”„ë¦°í„°",g:"70160554"},{n:"ë…¸íŠ¸ë¶",g:"811915899"},{n:"ì™€ì´ë¸Œë¡œ",g:"1793948339"},
        {n:"ìˆ˜ì›",g:"1112786"},{n:"ì•„ì‚°1",g:"1052607410"},{n:"í‰íƒ",g:"503432091"},{n:"ì‚¬ë¬´ì‹¤",g:"734953362"}
    ];

    let allData = [];

    async function syncAll() {
        const promises = sheetGids.map(s => {
            return new Promise(resolve => {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${s.g}&cache=${Math.random()}`;
                Papa.parse(url, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: res => {
                        const fixed = res.data.map(row => ({...row, _sheetName: s.n}));
                        resolve(fixed);
                    },
                    error: () => resolve([])
                });
            });
        });
        const results = await Promise.all(promises);
        allData = results.flat().filter(row => Object.values(row).some(v => v && v.length > 1));
        document.getElementById('statusBar').innerText = `âœ… ì´ ${allData.length}ê±´ ë°ì´í„° ë¡œë“œ ì„±ê³µ!`;
        filterComplex();
    }

    function getVal(row, keyword) {
        const key = Object.keys(row).find(k => k.replace(/\s/g,'').includes(keyword));
        return key ? row[key] : "";
    }

    function renderCard(row, specificDate = null) {
        const asset = getVal(row, "ìì‚°ë²ˆí˜¸") || "ë²ˆí˜¸ì—†ìŒ";
        const loc = getVal(row, "í˜„ì¬ìœ„ì¹˜") || row._sheetName;
        const keys = Object.keys(row);
        let memo = "íŠ¹ì´ì‚¬í•­ ì—†ìŒ";
        let dateLabel = "";

        if (specificDate) {
            memo = row[specificDate];
            dateLabel = specificDate;
        } else {
            const dateKey = keys.filter(k => /\d{1,2}\/\d{1,2}/.test(k)).reverse().find(k => row[k] && row[k].trim());
            if (dateKey) { memo = row[dateKey]; dateLabel = dateKey; }
        }

        return `<div class="card">
            <div class="card-title">${loc} / ${asset}</div>
            <div class="memo-box">[${dateLabel || 'ìµœê·¼'}] ${memo}</div>
        </div>`;
    }

    function filterComplex() {
        const loc = document.getElementById('locSelect').value;
        const dev = document.getElementById('devSelect').value;
        const filtered = allData.filter(row => {
            const rowLoc = (getVal(row, "í˜„ì¬ìœ„ì¹˜") || row._sheetName);
            const rowStr = JSON.stringify(row);
            return (!loc || rowLoc.includes(loc)) && (!dev || rowStr.includes(dev));
        });
        document.getElementById('placeResult').innerHTML = filtered.map(row => renderCard(row)).join('');
    }

    function searchByAsset() {
        const val = document.getElementById('assetInput').value.toLowerCase();
        const filtered = allData.filter(row => getVal(row, "ìì‚°ë²ˆí˜¸").toLowerCase().includes(val));
        document.getElementById('searchResult').innerHTML = filtered.map(row => renderCard(row)).join('');
    }

    function openTab(id) {
        document.querySelectorAll('.content, .tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    let calendar;
    function initCalendar() {
        if(calendar) return;
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth', locale: 'ko',
            dateClick: info => {
                const d = new Date(info.dateStr);
                const k = `${d.getMonth()+1}/${d.getDate()}`;
                const k2 = `${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
                const res = allData.filter(row => (row[k] && row[k].trim()) || (row[k2] && row[k2].trim()));
                document.getElementById('dateResult').innerHTML = `<div class="date-header">ğŸ“… ${info.dateStr}</div>` + 
                    res.map(row => renderCard(row, row[k] ? k : k2)).join('');
            }
        });
        calendar.render();
    }
    syncAll();
</script>
</body>
</html>