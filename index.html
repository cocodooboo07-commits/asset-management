<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìì‚° í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; padding: 10px; background: #f0f2f5; }
        .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; }
        .tab-btn { flex: 0 0 auto; padding: 12px 15px; cursor: pointer; border: none; background: #ccc; font-weight: bold; border-radius: 8px; font-size: 13px; }
        .tab-btn.active { background: #007bff; color: white; }
        .content { display: none; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 500px; }
        .content.active { display: block; }
        input, select { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .card { border-left: 6px solid #007bff; background: #fff; padding: 12px; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card-title { font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 5px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.9em; color: #666; }
        .status-box { margin-top: 8px; padding: 8px; background: #fff1f0; border-radius: 4px; border: 1px solid #ffa39e; color: #cf1322; font-weight: bold; font-size: 0.85em; }
        #loading { text-align: center; padding: 20px; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>

<div class="tab-menu">
    <button class="tab-btn active" onclick="openTab('search-tab')">1. ìì‚°ë²ˆí˜¸ ê²€ìƒ‰</button>
    <button class="tab-btn" onclick="openTab('place-tab')">2. ì¥ì†Œ/ì¥ë¹„ë³„</button>
    <button class="tab-btn" onclick="initCalendar(); openTab('date-tab')">3. ë‚ ì§œë³„(ë‹¬ë ¥)</button>
</div>

<div id="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (ì‹œíŠ¸ê°€ ì»¤ì„œ 5ì´ˆ ì •ë„ ê±¸ë¦½ë‹ˆë‹¤)</div>

<div id="search-tab" class="content active">
    <input type="text" id="assetSearch" placeholder="ìì‚°ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeyup="searchAsset()">
    <div id="searchResult"></div>
</div>

<div id="place-tab" class="content">
    <select id="typeSelect" onchange="filterData()">
        <option value="">íƒ­ ì„ íƒ (ì¥ë¹„/ì¥ì†Œ)</option>
    </select>
    <div id="filterResult"></div>
</div>

<div id="date-tab" class="content">
    <div id="calendar"></div>
    <div id="dateResult" style="margin-top:20px;"></div>
</div>

<script>
    const sheetId = "12xhA0X6iOrg-4mq9KWZsQ9nPb2818P5VGUDXQMhjeTw";
    const sheetNames = ["ì²­ë ¥ê¸°","ì²­ë ¥ë¶€ìŠ¤","ì¤‘ì´ê¸°ê¸°","ì†ŒìŒê³„","ì›ì‹¬ë¶„ë¦¬ê¸°","HRV","EKG","íí™œëŸ‰","ì‹¤ë¦°ì§€","í”„ë¦°í„°ê¸°","ì—…ë¬´ìš©ë…¸íŠ¸ë¶","ì™€ì´ë¸Œë¡œ","ìˆ˜ì›","ì•„ì‚°1","í‰íƒ","ì‚¬ë¬´ì‹¤"];
    
    let allData = [];

    async function init() {
        const fetchPromises = sheetNames.map(name => {
            return new Promise((resolve) => {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`;
                Papa.parse(url, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (results) => {
                        const tagged = results.data.map(row => ({ ...row, _tabName: name }));
                        resolve(tagged);
                    },
                    error: () => resolve([])
                });
            });
        });

        const results = await Promise.all(fetchPromises);
        allData = results.flat().filter(row => {
            // ìì‚°ë²ˆí˜¸ ì—´(Eì—´ ë“±)ì´ ë¹„ì–´ìˆì§€ ì•Šì€ ê²ƒë§Œ ê°€ì ¸ì˜´
            const assetKey = Object.keys(row).find(k => k.toLowerCase().includes('ìì‚°ë²ˆí˜¸'));
            return row[assetKey] && row[assetKey].toString().trim() !== "";
        });

        // íƒ­ ì„ íƒì°½ ì˜µì…˜ ì±„ìš°ê¸°
        const sel = document.getElementById('typeSelect');
        sheetNames.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name; opt.innerText = name;
            sel.appendChild(opt);
        });

        document.getElementById('loading').style.display = 'none';
    }

    function openTab(id) {
        document.querySelectorAll('.content, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'date-tab' && calendar) calendar.render();
    }

    function searchAsset() {
        const val = document.getElementById('assetSearch').value.toLowerCase();
        const res = allData.filter(row => {
            const assetKey = Object.keys(row).find(k => k.includes('ìì‚°ë²ˆí˜¸'));
            return row[assetKey] && row[assetKey].toString().toLowerCase().includes(val);
        });
        renderCards(res, 'searchResult');
    }

    function filterData() {
        const val = document.getElementById('typeSelect').value;
        const res = allData.filter(row => row._tabName === val);
        renderCards(res, 'filterResult');
    }

    let calendar = null;
    function initCalendar() {
        if (calendar) return;
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth',
            locale: 'ko',
            events: function(fetchInfo, successCallback) {
                let eventDates = [];
                allData.forEach(row => {
                    Object.keys(row).forEach(key => {
                        // MM/DD í˜•ì‹ì˜ í—¤ë”ì—ì„œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì´ë²¤íŠ¸ ì¶”ê°€
                        if (/\d{2}\/\d{2}/.test(key) && row[key] && row[key].trim() !== "") {
                            const [m, d] = key.split('/');
                            const dateStr = `2025-${m.trim()}-${d.trim().padStart(2, '0')}`;
                            eventDates.push({ start: dateStr, display: 'background', color: '#ffccc7' });
                        }
                    });
                });
                successCallback(eventDates);
            },
            dateClick: (info) => showDateData(info.dateStr)
        });
        calendar.render();
    }

    function showDateData(dateStr) {
        const [y, m, d] = dateStr.split('-');
        const colName = `${m}/${parseInt(d)}`; // ì‹œíŠ¸ í—¤ë” í˜•ì‹ (01/01 -> 1/1 ëŒ€ì‘)
        const res = allData.filter(row => {
            const key = Object.keys(row).find(k => k.includes(`${m}/${d}`) || k.includes(`${parseInt(m)}/${parseInt(d)}`));
            return key && row[key] && row[key].trim() !== "";
        });
        document.getElementById('dateResult').innerHTML = `<h3>ğŸ“… ${dateStr} íŠ¹ì´ì‚¬í•­ ì¥ë¹„</h3>`;
        renderCards(res, 'dateResult', dateStr);
    }

    function renderCards(data, targetId, targetDate = null) {
        const target = document.getElementById(targetId);
        if(data.length === 0) { target.innerHTML = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
        
        target.innerHTML = data.map(row => {
            const assetKey = Object.keys(row).find(k => k.includes('ìì‚°ë²ˆí˜¸')) || 'ìì‚°ë²ˆí˜¸';
            const modelKey = Object.keys(row).find(k => k.includes('ëª¨ë¸')) || 'ëª¨ë¸';
            const nameKey = Object.keys(row).find(k => k.includes('ê¸°ê¸°ëª…')) || 'ê¸°ê¸°ëª…';
            const locKey = Object.keys(row).find(k => k.includes('í˜„ì¬ìœ„ì¹˜')) || 'í˜„ì¬ìœ„ì¹˜';
            
            // íŠ¹ì´ì‚¬í•­ ì°¾ê¸° (í•´ë‹¹ ë‚ ì§œ ì—´ì˜ ê°’)
            let note = "";
            if(targetDate) {
                const [y, m, d] = targetDate.split('-');
                const dateKey = Object.keys(row).find(k => k.includes(`${m}/${d}`) || k.includes(`${parseInt(m)}/${parseInt(d)}`));
                note = row[dateKey] || "";
            }

            return `
                <div class="card">
                    <div class="card-title">${row[assetKey]} <small style="color:#007bff">[${row._tabName}]</small></div>
                    <div class="info-grid">
                        <div>ê¸°ê¸°: ${row[nameKey] || '-'}</div>
                        <div>ëª¨ë¸: ${row[modelKey] || '-'}</div>
                        <div>ìœ„ì¹˜: ${row[locKey] || 'íƒ­ í™•ì¸'}</div>
                    </div>
                    ${note ? `<div class="status-box">âš ï¸ íŠ¹ì´ì‚¬í•­: ${note}</div>` : ''}
                </div>
            `;
        }).join('');
    }

    init();
</script>
</body>
</html>