<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ (í†µí•©ë³¸)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 15px; background: #fff; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; }
    .tab.active { background: #d63031; color: white; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .card { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 8px solid #d63031; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card-title { font-weight: bold; font-size: 15px; color: #333; margin-bottom: 8px; }
    /* ì§„ì‹¤ì›ë³¸ íŠ¹ì´ì‚¬í•­ (ë…¸ë€ìƒ‰) */
    .master-info { background: #fffceb; padding: 10px; border-radius: 5px; color: #856404; font-size: 13px; border: 1px solid #ffeeba; margin-bottom: 8px; }
    /* ì¼ì¼ ë¡œê·¸ íŠ¹ì´ì‚¬í•­ (ë¹¨ê°„ìƒ‰) */
    .card-note { background: #fdf2f2; padding: 10px; border-radius: 5px; color: #d63031; font-weight: bold; font-size: 14px; border: 1px solid #ff7675; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border-radius: 8px; overflow: hidden; }
    .cal-header { padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; font-size: 12px; }
    .cal-day { height: 60px; background: #fff; padding: 5px; text-align: left; font-size: 12px; cursor: pointer; position: relative; }
    .cal-day.issue { background: #ffe5e5; }
    .cal-day.issue::after { content: 'ğŸ”´'; position: absolute; bottom: 3px; right: 5px; font-size: 10px; }
    .cal-day.selected { background: #d63031 !important; color: white !important; }
    .month-nav { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
    .month-nav button { padding: 10px 20px; background: #d63031; color: white; border: none; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
<div class="header" id="status">ì—°ê²° ì¤‘...</div>
<div class="tabs">
  <div class="tab active" id="tab-eq" onclick="setMode('equip')">ì¥ë¹„â†’ì¥ì†Œ</div>
  <div class="tab" id="tab-dt" onclick="setMode('date')">ë‚ ì§œë³„</div>
</div>
<div id="searchBox" class="box"></div>
<div id="results"></div>

<script>
const SID = '1qJpWnVNBZIwnwZG4OD3JdUKytVq_4V6n';
const LOG_SHEETS = {'ì²­ë ¥ê¸°':'1397804768','ì²­ë ¥ë¶€ìŠ¤':'1226463543','ì¤‘ì´ê¸°ê¸°':'1413774664','ì†ŒìŒê³„':'199554987','ì›ì‹¬ë¶„ë¦¬ê¸°':'1627219985','HRV':'816640230','EKG':'914024434','íí™œëŸ‰':'348975961','ì‹¤ë¦°ì§€':'874684579','í”„ë¦°í„°ê¸°':'70160554','ì—…ë¬´ìš©ë…¸íŠ¸ë¶':'811915899','ì™€ì´ë¸Œë¡œ':'1793948339'};
const MASTER_SHEETS = {'1íŒ€':'0','2íŒ€':'131109673','3íŒ€':'547721869','4íŒ€':'56762319','5íŒ€':'2102046487','6íŒ€':'1478546552','ìˆ˜ì›':'507000843','í‰íƒ':'1975949576','ì•„ì‚°1':'1713506145','ì‚¬ë¬´ì‹¤':'132442490','ì˜ê³µì‹¤':'1330366624','ì„¼í„°':'500585250'};

let masterMap = {};
let allData = [];
let mode = 'equip';
let year = 2026;
let month = 1;
const IGN = ['ì •ìƒ','ì´ìƒì—†ìŒ','ì´ìƒ ì—†ìŒ','ì™„ë£Œ','-','ì—†ìŒ'];

async function load() {
  allData = [];
  masterMap = {};
  document.getElementById('status').innerText = 'â³ ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë“œ ì¤‘...';

  // 1. íŒ€ë³„ ë§ˆìŠ¤í„° ì‹œíŠ¸ ë¡œë“œ (ê´€ë¦¬ì, íŠ¹ì´ì‚¬í•­ ê³ ì • ì •ë³´)
  for (const [tName, gid] of Object.entries(MASTER_SHEETS)) {
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res = await fetch(url, {cache: 'no-store'});
      const csv = await res.text();
      const p = Papa.parse(csv.trim(), {header: true, skipEmptyLines: false}); // skipEmptyLines: false (í•µì‹¬)
      p.data.forEach(r => {
        const an = (r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '').trim();
        if (an) {
          masterMap[an] = {
            manager: (r['ê´€ë¦¬ì'] || 'ë¯¸ì§€ì •').trim(),
            note: (r['íŠ¹ì´ì‚¬í•­'] || 'ê¸°ë¡ì—†ìŒ').trim(),
            team: tName
          };
        }
      });
    } catch (e) { console.error(tName, 'ë¡œë“œ ì‹¤íŒ¨'); }
  }

  document.getElementById('status').innerText = 'â³ ì¥ë¹„ ë¡œê·¸ ë³‘í•© ì¤‘...';
  // 2. ì¥ë¹„ë³„ ë¡œê·¸ ì‹œíŠ¸ ë¡œë“œ
  for (const [nm, gid] of Object.entries(LOG_SHEETS)) {
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res = await fetch(url, {cache: 'no-store'});
      const csv = await res.text();
      const p = Papa.parse(csv.trim(), {header: true, skipEmptyLines: true});
      p.data.forEach(r => {
        const an = (r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '').trim();
        if (an) {
          const mInfo = masterMap[an] || { manager: 'ë¯¸ë“±ë¡', note: 'ë§ˆìŠ¤í„° ì •ë³´ ì—†ìŒ', team: 'ê¸°íƒ€' };
          allData.push({ ...r, _eq: nm, _m: mInfo });
        }
      });
    } catch (e) { console.error(nm, 'ì‹¤íŒ¨'); }
  }
  document.getElementById('status').innerText = `âœ… ${allData.length}ê°œ ë™ê¸°í™” ì™„ë£Œ`;
  show();
}

function isIssue(t) {
  if (!t || !t.trim()) return false;
  const c = t.replace(/\s/g, '').toLowerCase();
  return !IGN.some(i => i.replace(/\s/g, '').toLowerCase() === c);
}

function setMode(m) {
  mode = m;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (m === 'equip') document.getElementById('tab-eq').classList.add('active');
  else document.getElementById('tab-dt').classList.add('active');
  show();
}

function show() {
  const b = document.getElementById('searchBox');
  document.getElementById('results').innerHTML = '';
  if (mode === 'equip') {
    b.innerHTML = `<label>ì¥ë¹„ ì¢…ë¥˜</label><select id="es" onchange="uL()"><option value="">ì„ íƒ</option>${Object.keys(LOG_SHEETS).map(e=>`<option value="${e}">${e}</option>`).join('')}</select><div id="lb" style="display:none"><label>ì¥ì†Œ (ë§ˆìŠ¤í„° ê¸°ì¤€)</label><select id="ls" onchange="dS()"><option value="">ì „ì²´</option></select></div>`;
  } else {
    showCal();
  }
}

function uL() {
  const e = document.getElementById('es').value;
  if (!e) { document.getElementById('lb').style.display='none'; return; }
  const f = allData.filter(r => r._eq === e);
  const ls = [...new Set(f.map(r => r._m.team))].sort();
  document.getElementById('ls').innerHTML = '<option value="">ì „ì²´</option>' + ls.map(l=>`<option value="${l}">${l}</option>`).join('');
  document.getElementById('lb').style.display='block';
  dS();
}

function dS() {
  const e = document.getElementById('es').value;
  const l = document.getElementById('ls').value;
  let f = allData.filter(r => r._eq === e);
  if (l) f = f.filter(r => r._m.team === l);

  document.getElementById('results').innerHTML = f.map(r => {
    const ks = Object.keys(r).filter(k => k.match(/^\d{1,2}[\/\-]\d{1,2}$/)).sort().reverse();
    const ld = ks.find(k => r[k] && r[k].trim());
    const logNote = ld ? r[ld] : 'ê¸°ë¡ì—†ìŒ';
    const an = r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '';
    
    return `
      <div class="card">
        <div class="card-title">[${r._m.team}] ${r._eq} / ${an}</div>
        <div class="master-info">ğŸ‘¤ ê´€ë¦¬ì: ${r._m.manager}<br>ğŸ“Œ ê³ ì • íŠ¹ì´ì‚¬í•­: ${r._m.note}</div>
        <div class="card-note">${ld || 'ìµœê·¼ ë¡œê·¸'}: ${logNote}</div>
      </div>`;
  }).join('');
}

function showCal() {
  const b = document.getElementById('searchBox');
  const ids = new Set();
  allData.forEach(r => {
    Object.keys(r).forEach(k => {
      if (k.match(/^\d{1,2}[\/\-]\d{1,2}$/) && isIssue(r[k])) {
        const p = k.trim().replace('-', '/').split('/');
        ids.add(`${p[0].padStart(2, '0')}/${p[1].padStart(2, '0')}`);
      }
    });
  });
  const fd = new Date(year, month - 1, 1).getDay();
  const ld = new Date(year, month, 0).getDate();
  let h = `<div class="month-nav"><button onclick="mM(-1)">â—€</button><b>${year}ë…„ ${month}ì›”</b><button onclick="mM(1)">â–¶</button></div><div class="calendar">`;
  ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(d => h += `<div class="cal-header">${d}</div>`);
  for (let i = 0; i < fd; i++) h += '<div></div>';
  for (let d = 1; d <= ld; d++) {
    const ds = `${String(month).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
    h += `<div class="cal-day ${ids.has(ds) ? 'issue' : ''}" onclick="sD('${ds}',this)">${d}</div>`;
  }
  b.innerHTML = h + '</div><div id="dr"></div>';
}

function mM(v) { month += v; if (month > 12) { month = 1; year++; } else if (month < 1) { month = 12; year--; } showCal(); }

function sD(ds, el) {
  document.querySelectorAll('.cal-day').forEach(x => x.classList.remove('selected'));
  el.classList.add('selected');
  const [m, d] = ds.split('/');
  const ad = `${parseInt(m)}/${parseInt(d)}`;
  const f = allData.filter(r => {
    return Object.keys(r).find(x => {
      const n = x.trim().replace('-', '/');
      return (n === ds || n === ad) && isIssue(r[x]);
    }) !== undefined;
  });
  document.getElementById('dr').innerHTML = f.length === 0 ? '<p style="padding:20px;text-align:center;">íŠ¹ì´ì‚¬í•­ ì—†ìŒ</p>' : f.map(r => {
    const k = Object.keys(r).find(x => x.trim().replace('-', '/') === ds || x.trim().replace('-', '/') === ad);
    return `
      <div class="card">
        <div class="card-title">[${r._m.team}] ${r._eq} / ${r._m.manager}</div>
        <div class="card-note">${r[k]}</div>
        <div style="font-size:12px; color:#888; margin-top:5px;">ğŸ“Œ ê³ ì •ë¹„ê³ : ${r._m.note}</div>
      </div>`;
  }).join('');
}

load();
</script>
</body>
</html>