<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>장비 관리 시스템</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 15px; background: #fff; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; }
    .tab.active { background: #d63031; color: white; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; gap: 1px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .cal-header { padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; font-size: 12px; }
    .cal-day { height: 60px; background: #fff; padding: 5px; text-align: left; font-size: 12px; cursor: pointer; position: relative; }
    .cal-day.issue { background: #fff0f0; }
    .cal-day.issue::after { content: '⚠️'; position: absolute; bottom: 5px; right: 5px; font-size: 12px; color: #d63031; }
    .cal-day.selected { background: #d63031 !important; color: white !important; }
    .card { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 8px solid #d63031; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card-title { font-weight: bold; font-size: 15px; color: #333; margin-bottom: 5px; }
    .card-note { background: #fdf2f2; padding: 10px; border-radius: 5px; color: #d63031; font-weight: bold; font-size: 14px; border: 1px solid #ff7675; }
    .month-nav { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
    .month-nav button { padding: 10px 20px; background: #d63031; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
<div class="header" id="status">데이터 연결 중...</div>
<div class="tabs">
  <div class="tab active" id="tab-equip" onclick="setMode('equip')">장비 → 장소</div>
  <div class="tab" id="tab-date" onclick="setMode('date')">날짜별 기록</div>
</div>
<div id="searchBox" class="box"></div>
<div id="results"></div>
<script>
const SHEET_ID = '1qJpWnVNBZIwnwZG4OD3JdUKytVq_4V6n';
const SHEETS = { '청력기': '1397804768', '청력부스': '1226463543', '중이기기': '1413774664', '소음계': '199554987', '원심분리기': '1627219985', 'HRV': '816640230', 'EKG': '914024434', '폐활량': '348975961', '실린지': '874684579', '프린터기': '70160554', '업무용노트북': '811915899', '와이브로': '1793948339' };
let allData = [];
let mode = 'equip';
let currentYear = 2026;
let currentMonth = 1;
const TARGET_LOCS = ["1", "2", "3", "4", "5", "6", "아산1", "평택", "수원", "사무실", "센터", "의공실"];
const IGNORE_TEXT = ["특이사항없음", "특이사항 없음", "이상없음", "이상 없음", "정상", "완료", "-", "없음"];

function getVal(row, names) { 
    const keys = Object.keys(row);
    for (let n of names) {
        const k = keys.find(x => x.trim().replace(/\s/g, '') === n.replace(/\s/g, ''));
        if (k) return row[k];
    }
    return "";
}

async function load() {
    allData = [];
    document.getElementById('status').innerText = '⏳ 로딩 중...';
    for (const [name, gid] of Object.entries(SHEETS)) {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
            const res = await fetch(url, { cache: 'no-store' });
            const csv = await res.text();
            const parsed = Papa.parse(csv.trim(), { header: true, skipEmptyLines: false });
            
            let count = 0;
            parsed.data.forEach(row => {
                const an = getVal(row, ['자산번호', '자산 번호']);
                if (an && an.trim()) {
                    allData.push({ ...row, _equip: name, _assetIdx: an.trim() });
                    count++;
                }
            });
            console.log(`${name}: ${count}개 로드`);
        } catch (e) {
            console.error(`${name} 로드 실패:`, e);
        }
    }
    document.getElementById('status').innerText = `✅ ${allData.length}대 연결됨`;
    console.log('총 데이터:', allData.length);
    show();
}

function isRealIssue(t) {
    if (!t || !t.trim()) return false;
    const ct = t.replace(/\s/g, "").toLowerCase();
    return !IGNORE_TEXT.some(i => i.replace(/\s/g, "").toLowerCase() === ct);
}

function parseLoc(row) {
    const v = getVal(row, ['현재위치', '현재 위치']);
    if (!v) return "기타";
    for (let l of TARGET_LOCS) if (v.toString().includes(l)) return l;
    return "기타";
}

function setMode(m) {
    mode = m;
    document.getElementById('tab-equip').classList.toggle('active', m === 'equip');
    document.getElementById('tab-date').classList.toggle('active', m === 'date');
    show();
}

function show() {
    const b = document.getElementById('searchBox');
    document.getElementById('results').innerHTML = '';
    if (mode === 'equip') {
        b.innerHTML = `<label>장비 선택</label><select id="es" onchange="uL()"><option value="">선택</option>${Object.keys(SHEETS).map(e=>`<option value="${e}">${e}</option>`).join('')}</select><div id="lb" style="display:none"><label>장소 필터</label><select id="ls" onchange="dS()"><option value="">전체</option></select></div>`;
    } else showCalendar();
}

function uL() {
    const e = document.getElementById('es').value;
    if (!e) {
        document.getElementById('lb').style.display='none';
        document.getElementById('results').innerHTML = '';
        return;
    }
    const f = allData.filter(r => r._equip === e);
    const ls = [...new Set(f.map(r => parseLoc(r)))].filter(l => l !== "기타").sort();
    document.getElementById('ls').innerHTML = '<option value="">전체</option>' + ls.map(l=>`<option value="${l}">${isNaN(l)?l:l+'팀'}</option>`).join('');
    document.getElementById('lb').style.display='block';
    dS();
}

function dS() {
    const e = document.getElementById('es').value;
    const l = document.getElementById('ls').value;
    let f = allData.filter(r => r._equip === e);
    if (l) f = f.filter(r => parseLoc(r) === l);
    
    document.getElementById('results').innerHTML = f.map(r => {
        const ln = parseLoc(r);
        const ks = Object.keys(r).filter(k => k.match(/^\d{1,2}[\/\-]\d{1,2}$/)).sort().reverse();
        const ld = ks.find(k => r[k] && r[k].trim());
        const note = ld ? r[ld] : '기록 없음';
        
        let state = "보유";
        if (note.includes("반납")) state = "반납";
        else if (note.includes("수령")) state = "수령";
        
        return `<div class="card"><div class="card-title">${ln}${isNaN(ln)?'':'팀'} ${state} / ${r._equip} / ${r._assetIdx}</div><div class="card-note">${ld || '최근'} : ${note}</div></div>`;
    }).join('');
}

function showCalendar() {
    const b = document.getElementById('searchBox');
    const ids = new Set();
    
    allData.forEach(r => {
        Object.keys(r).forEach(k => {
            if (k.match(/^\d{1,2}[\/\-]\d{1,2}$/) && isRealIssue(r[k])) {
                const p = k.trim().replace('-', '/').split('/');
                ids.add(`${p[0].padStart(2, '0')}/${p[1].padStart(2, '0')}`);
            }
        });
    });
    
    console.log('특이사항 날짜:', Array.from(ids).sort());
    
    const f = new Date(currentYear, currentMonth-1, 1).getDay();
    const ld = new Date(currentYear, currentMonth, 0).getDate();
    let h = `<div class="month-nav"><button onclick="mM(-1)">◀</button><b>${currentYear}년 ${currentMonth}월</b><button onclick="mM(1)">▶</button></div><div class="calendar">`;
    ['일','월','화','수','목','금','토'].forEach(d => h += `<div class="cal-header">${d}</div>`);
    for (let i=0; i<f; i++) h += '<div></div>';
    for (let d=1; d<=ld; d++) {
        const s = `${String(currentMonth).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
        h += `<div class="cal-day ${ids.has(s)?'issue':''}" onclick="sD('${s}', this)">${d}</div>`;
    }
    b.innerHTML = h + '</div><div id="dateRes"></div>';
}

function mM(v) { 
    currentMonth += v; 
    if(currentMonth>12){currentMonth=1;currentYear++;} 
    else if(currentMonth<1){currentMonth=12;currentYear--;} 
    showCalendar(); 
}

function sD(d, el) {
    document.querySelectorAll('.cal-day').forEach(x => x.classList.remove('selected'));
    el.classList.add('selected');
    const [m, dy] = d.split('/');
    const ad = `${parseInt(m)}/${parseInt(dy)}`;
    
    const f = allData.filter(r => {
        const k = Object.keys(r).find(x => { 
            const ck = x.trim().replace('-', '/'); 
            return ck === d || ck === ad; 
        });
        return k && isRealIssue(r[k]);
    });
    
    document.getElementById('dateRes').innerHTML = f.length === 0 ? `<p style="padding:20px; text-align:center;">특이사항 없음</p>` : f.map(r => {
        const k = Object.keys(r).find(x => {
            const ck = x.trim().replace('-', '/');
            return ck === d || ck === ad;
        });
        const ln = parseLoc(r);
        return `<div class="card"><div class="card-title">${ln}${isNaN(ln)?'':'팀'} / ${r._equip} / ${r._assetIdx}</div><div class="card-note">${r[k]}</div></div>`;
    }).join('');
}

load();
</script>
</body>
</html>