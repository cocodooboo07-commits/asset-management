<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë¹„ í†µí•© ê´€ë¦¬ ê²Œì‹œíŒ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; padding: 10px; background: #f0f2f5; }
        .status-bar { background: #000; color: #0f0; padding: 12px; font-size: 15px; margin-bottom: 10px; border-radius: 8px; font-family: monospace; border: 2px solid #0f0; text-align: center; font-weight: bold; }
        .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 15px 5px; cursor: pointer; border: none; background: #dfe6e9; font-weight: bold; border-radius: 8px; }
        .tab-btn.active { background: #0984e3; color: white; }
        .content { display: none; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 550px; }
        .content.active { display: block; }
        select, input { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ced4da; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .card { border-left: 8px solid #00b894; background: #fff; padding: 18px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-title { font-size: 1.15em; font-weight: bold; color: #2d3436; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .memo-box { background: #fff5f5; border: 2px solid #ff7675; border-radius: 6px; padding: 12px; color: #d63031; font-weight: 800; line-height: 1.6; }
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.9em; margin-right: 5px; background: #ffeaa7; color: #d35400; }
    </style>
</head>
<body>

    <div class="status-bar" id="statusBar">ğŸ”Œ 16ê°œ ì‹œíŠ¸ ì „ìˆ˜ ì¡°ì‚¬ ì¤‘...</div>

    <div class="tab-menu">
        <button class="tab-btn active" onclick="openTab('place-tab')">ğŸ“ ì¥ì†Œ/ì¥ë¹„ ê²€ìƒ‰</button>
        <button class="tab-btn" onclick="openTab('search-tab')">ğŸ” ìì‚°ë²ˆí˜¸ ê²€ìƒ‰</button>
        <button class="tab-btn" onclick="initCalendar(); openTab('date-tab')">ğŸ“… ë‚ ì§œë³„ ê²Œì‹œíŒ</button>
    </div>

    <div id="place-tab" class="content active">
        <select id="locSelect" onchange="filterData()">
            <option value="">1. ì¥ì†Œ ì„ íƒ (ì „ì²´)</option>
            <option value="ìˆ˜ì›">ìˆ˜ì›</option><option value="ì•„ì‚°1">ì•„ì‚°1</option>
            <option value="í‰íƒ">í‰íƒ</option><option value="ì‚¬ë¬´ì‹¤">ì‚¬ë¬´ì‹¤</option>
        </select>
        <select id="devSelect" onchange="filterData()">
            <option value="">2. ì¥ë¹„ ì„ íƒ (ì „ì²´)</option>
            <option value="ì²­ë ¥ê¸°">ì²­ë ¥ê¸°</option><option value="ì²­ë ¥ë¶€ìŠ¤">ì²­ë ¥ë¶€ìŠ¤</option>
            <option value="ì¤‘ì´ê¸°ê¸°">ì¤‘ì´ê¸°ê¸°</option><option value="ì†ŒìŒê³„">ì†ŒìŒê³„</option>
            <option value="ì›ì‹¬ë¶„ë¦¬ê¸°">ì›ì‹¬ë¶„ë¦¬ê¸°</option><option value="HRV">HRV</option>
            <option value="EKG">EKG</option><option value="íí™œëŸ‰">íí™œëŸ‰</option>
            <option value="ì‹¤ë¦°ì§€">ì‹¤ë¦°ì§€</option><option value="í”„ë¦°í„°ê¸°">í”„ë¦°í„°ê¸°</option>
            <option value="ì—…ë¬´ìš©ë…¸íŠ¸ë¶">ì—…ë¬´ìš©ë…¸íŠ¸ë¶</option><option value="ì™€ì´ë¸Œë¡œ">ì™€ì´ë¸Œë¡œ</option>
        </select>
        <div id="placeResult"></div>
    </div>

    <div id="search-tab" class="content">
        <input type="text" id="assetInput" placeholder="ìì‚°ë²ˆí˜¸ ì…ë ¥..." onkeyup="searchByAsset()">
        <div id="searchResult"></div>
    </div>

    <div id="date-tab" class="content">
        <div id="calendar"></div>
        <div id="dateResult"></div>
    </div>

    <script>
        const sheetId = "12xhA0X6iOrg-4mq9KWZsQ9nPb2818P5VGUDXQMhjeTw";
        const sheetGids = [
            {name: "ì²­ë ¥ê¸°", gid: "1397804768"}, {name: "ì²­ë ¥ë¶€ìŠ¤", gid: "1226463543"},
            {name: "ì¤‘ì´ê¸°ê¸°", gid: "1413774664"}, {name: "ì†ŒìŒê³„", gid: "199554987"},
            {name: "ì›ì‹¬ë¶„ë¦¬ê¸°", gid: "1627219985"}, {name: "HRV", gid: "816640230"},
            {name: "EKG", gid: "914024434"}, {name: "íí™œëŸ‰", gid: "348975961"},
            {name: "ì‹¤ë¦°ì§€", gid: "874684579"}, {name: "í”„ë¦°í„°ê¸°", gid: "70160554"},
            {name: "ì—…ë¬´ìš©ë…¸íŠ¸ë¶", gid: "811915899"}, {name: "ì™€ì´ë¸Œë¡œ", gid: "1793948339"},
            {name: "ìˆ˜ì›", gid: "1112786"}, {name: "ì•„ì‚°1", gid: "1052607410"},
            {name: "í‰íƒ", gid: "503432091"}, {name: "ì‚¬ë¬´ì‹¤", gid: "734953362"}
        ];
        
        let allRecords = [];
        let assetToDeviceMap = {}; 

        async function init() {
            const bar = document.getElementById('statusBar');
            allRecords = []; 

            // 1. ë¨¼ì € ì¥ë¹„ íƒ­ì„ ëŒë©´ì„œ ìì‚°ë²ˆí˜¸-ì¥ë¹„ëª… ë§¤í•‘ í…Œì´ë¸” ì™„ì„±
            for(const info of sheetGids.slice(0, 12)) {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${info.gid}&cache=${Math.random()}`;
                await new Promise(resolve => {
                    Papa.parse(url, { download: true, header: true, complete: res => {
                        res.data.forEach(row => {
                            const assetKey = Object.keys(row).find(k => k.replace(/\s/g,'').includes('ìì‚°ë²ˆí˜¸'));
                            if(assetKey && row[assetKey]) assetToDeviceMap[row[assetKey].trim()] = info.name;
                        });
                        resolve();
                    }});
                });
            }

            // 2. ì´ì œ ëª¨ë“  ì‹œíŠ¸ë¥¼ ëŒë©´ì„œ ì¤‘ë³µ í—ˆìš©í•˜ê³  ì‹¹ ë‹¤ ê¸ì–´ì˜´
            for(let i=0; i < sheetGids.length; i++) {
                const info = sheetGids[i];
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${info.gid}&cache=${Math.random()}`;
                bar.innerText = `â³ [${i+1}/${sheetGids.length}] ${info.name} ë°ì´í„° ê°•ì œ ì¶”ì¶œ ì¤‘...`;
                
                await new Promise(resolve => {
                    Papa.parse(url, { download: true, header: true, complete: res => {
                        res.data.forEach(row => {
                            const assetKey = Object.keys(row).find(k => k.replace(/\s/g,'').includes('ìì‚°ë²ˆí˜¸'));
                            const assetId = assetKey ? (row[assetKey] || "").trim() : "";
                            if (assetId) {
                                allRecords.push({ ...row, _originTab: info.name, _assetId: assetId });
                            }
                        });
                        resolve();
                    }});
                });
            }
            bar.innerText = `âœ… ì´ ${allRecords.length}ê±´ ë™ê¸°í™” ì„±ê³µ! ì´ì œ 365ê±´ ë„˜ì„ê²ë‹ˆë‹¤.`;
        }

        function openTab(id) {
            document.querySelectorAll('.content, .tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'date-tab' && calendar) setTimeout(() => calendar.render(), 100);
        }

        function renderCard(row, dateKey = null) {
            const keys = Object.keys(row);
            const locKey = keys.find(k => k.replace(/\s/g,'').includes('í˜„ì¬ìœ„ì¹˜'));
            const loc = row[locKey] || row._originTab;
            const device = assetToDeviceMap[row._assetId] || row._originTab;
            
            let memoContent = "";
            let displayDate = "";

            if(dateKey) {
                memoContent = row[dateKey];
                displayDate = dateKey;
            } else {
                // ê°€ì¥ ìµœê·¼ ë‚ ì§œ ê¸°ë¡ ì°¾ê¸°
                const dateKeys = keys.filter(k => /\d{1,2}\/\d{1,2}/.test(k)).reverse();
                for(const k of dateKeys) {
                    if(row[k] && row[k].trim()) {
                        memoContent = row[k];
                        displayDate = k;
                        break;
                    }
                }
            }

            return `
                <div class="card">
                    <div class="card-title">${loc} / ${device} / ${row._assetId}</div>
                    <div class="memo-box">
                        <span class="status-badge">${displayDate || 'ìµœê·¼'}</span> ${memoContent || 'ê¸°ë¡ ì—†ìŒ'}
                    </div>
                </div>
            `;
        }

        function filterData() {
            const loc = document.getElementById('locSelect').value;
            const dev = document.getElementById('devSelect').value;
            const res = allRecords.filter(row => {
                const locKey = Object.keys(row).find(k => k.replace(/\s/g,'').includes('í˜„ì¬ìœ„ì¹˜'));
                const matchesLoc = !loc || (row[locKey] || "").includes(loc) || row._originTab.includes(loc);
                const matchesDev = !dev || (assetToDeviceMap[row._assetId] === dev) || row._originTab.includes(dev);
                return matchesLoc && matchesDev;
            });
            document.getElementById('placeResult').innerHTML = res.map(row => renderCard(row)).join('');
        }

        function searchByAsset() {
            const val = document.getElementById('assetInput').value.toLowerCase();
            const res = allRecords.filter(row => row._assetId.toLowerCase().includes(val));
            document.getElementById('searchResult').innerHTML = res.map(row => renderCard(row)).join('');
        }

        let calendar;
        function initCalendar() {
            if(calendar) return;
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'ko',
                events: (info, success) => {
                    let evts = [];
                    allRecords.forEach(row => {
                        Object.keys(row).forEach(k => {
                            if(/\d{1,2}\/\d{1,2}/.test(k) && row[k] && row[k].trim()) {
                                const [m, d] = k.split('/');
                                evts.push({ start: `2025-${m.padStart(2,'0')}-${d.padStart(2,'0')}`, display: 'background', color: '#ff7675' });
                            }
                        });
                    });
                    success(evts);
                },
                dateClick: info => {
                    const [y, m, d] = info.dateStr.split('-');
                    const k1 = `${m}/${d}`; const k2 = `${parseInt(m)}/${parseInt(d)}`;
                    const res = allRecords.filter(row => (row[k1] && row[k1].trim()) || (row[k2] && row[k2].trim()));
                    document.getElementById('dateResult').innerHTML = `<h3>ğŸ“… ${info.dateStr} ë³€ë™ ê¸°ë¡ (${res.length}ê±´)</h3>` + 
                        res.map(row => renderCard(row, row[k1] ? k1 : k2)).join('');
                }
            });
            calendar.render();
        }
        init();
    </script>
</body>
</html>