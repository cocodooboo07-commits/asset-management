<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; padding: 10px; background: #f4f7f9; }
        .status-bar { background: #1a1a1a; color: #00ff00; padding: 10px; font-size: 12px; margin-bottom: 10px; border-radius: 5px; font-family: monospace; border: 1px solid #00ff00; }
        .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 15px 5px; cursor: pointer; border: none; background: #dfe6e9; font-weight: bold; border-radius: 8px; }
        .tab-btn.active { background: #0984e3; color: white; }
        .content { display: none; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 550px; }
        .content.active { display: block; }
        select, input { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ced4da; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .card { border-left: 6px solid #0984e3; background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-row { font-size: 1.05em; margin-bottom: 8px; line-height: 1.4; color: #2d3436; }
        .label { font-weight: bold; color: #636e72; }
        .memo-box { background: #fff5f5; border: 1px solid #fab1a0; border-radius: 6px; padding: 12px; margin-top: 10px; }
        .memo-content { font-size: 0.95em; color: #d63031; font-weight: bold; white-space: pre-wrap; }
    </style>
</head>
<body>

    <div class="status-bar" id="statusBar">ë°ì´í„° ë™ê¸°í™” ì¤€ë¹„ ì¤‘...</div>

    <div class="tab-menu">
        <button class="tab-btn active" onclick="openTab('place-tab')">ğŸ“ ì¥ì†Œ/ì¥ë¹„ ê²€ìƒ‰</button>
        <button class="tab-btn" onclick="openTab('search-tab')">ğŸ” ìì‚°ë²ˆí˜¸ ê²€ìƒ‰</button>
        <button class="tab-btn" onclick="initCalendar(); openTab('date-tab')">ğŸ“… ë‚ ì§œë³„ íŠ¹ì´ì‚¬í•­</button>
    </div>

    <div id="place-tab" class="content active">
        <select id="locSelect" onchange="filterData()">
            <option value="">1. ì¥ì†Œ ì„ íƒ (ì „ì²´)</option>
            <option value="ìˆ˜ì›">ìˆ˜ì›</option><option value="ì•„ì‚°1">ì•„ì‚°1</option>
            <option value="í‰íƒ">í‰íƒ</option><option value="ì‚¬ë¬´ì‹¤">ì‚¬ë¬´ì‹¤</option>
        </select>
        <select id="devSelect" onchange="filterData()">
            <option value="">2. ì¥ë¹„ ì„ íƒ (ì „ì²´)</option>
            <option value="ì²­ë ¥ê¸°">ì²­ë ¥ê¸°</option><option value="ì²­ë ¥ë¶€ìŠ¤">ì²­ë ¥ë¶€ìŠ¤</option>
            <option value="ì¤‘ì´ê¸°ê¸°">ì¤‘ì´ê¸°ê¸°</option><option value="ì†ŒìŒê³„">ì†ŒìŒê³„</option>
            <option value="ì›ì‹¬ë¶„ë¦¬ê¸°">ì›ì‹¬ë¶„ë¦¬ê¸°</option><option value="HRV">HRV</option>
            <option value="EKG">EKG</option><option value="íí™œëŸ‰">íí™œëŸ‰</option>
            <option value="ì‹¤ë¦°ì§€">ì‹¤ë¦°ì§€</option><option value="í”„ë¦°í„°ê¸°">í”„ë¦°í„°ê¸°</option>
            <option value="ì—…ë¬´ìš©ë…¸íŠ¸ë¶">ì—…ë¬´ìš©ë…¸íŠ¸ë¶</option><option value="ì™€ì´ë¸Œë¡œ">ì™€ì´ë¸Œë¡œ</option>
        </select>
        <div id="placeResult"></div>
    </div>

    <div id="search-tab" class="content">
        <input type="text" id="assetInput" placeholder="ìì‚°ë²ˆí˜¸ ì…ë ¥..." onkeyup="searchByAsset()">
        <div id="searchResult"></div>
    </div>

    <div id="date-tab" class="content">
        <div id="calendar"></div>
        <div id="dateResult"></div>
    </div>

    <script>
        const sheetId = "12xhA0X6iOrg-4mq9KWZsQ9nPb2818P5VGUDXQMhjeTw";
        const sheetGids = [
            {name: "ì²­ë ¥ê¸°", gid: "1397804768"}, {name: "ì²­ë ¥ë¶€ìŠ¤", gid: "1226463543"},
            {name: "ì¤‘ì´ê¸°ê¸°", gid: "1413774664"}, {name: "ì†ŒìŒê³„", gid: "199554987"},
            {name: "ì›ì‹¬ë¶„ë¦¬ê¸°", gid: "1627219985"}, {name: "HRV", gid: "816640230"},
            {name: "EKG", gid: "914024434"}, {name: "íí™œëŸ‰", gid: "348975961"},
            {name: "ì‹¤ë¦°ì§€", gid: "874684579"}, {name: "í”„ë¦°í„°ê¸°", gid: "70160554"},
            {name: "ì—…ë¬´ìš©ë…¸íŠ¸ë¶", gid: "811915899"}, {name: "ì™€ì´ë¸Œë¡œ", gid: "1793948339"},
            {name: "ìˆ˜ì›", gid: "1112786"}, {name: "ì•„ì‚°1", gid: "1052607410"},
            {name: "í‰íƒ", gid: "503432091"}, {name: "ì‚¬ë¬´ì‹¤", gid: "734953362"}
        ];
        
        let allData = [];

        async function init() {
            const bar = document.getElementById('statusBar');
            try {
                const promises = sheetGids.map(info => {
                    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${info.gid}`;
                    return new Promise(resolve => {
                        Papa.parse(url, {
                            download: true, header: true,
                            complete: res => resolve(res.data.map(row => ({ ...row, _originTab: info.name }))),
                            error: () => resolve([])
                        });
                    });
                });
                const results = await Promise.all(promises);
                allData = results.flat().filter(row => {
                    const k = Object.keys(row).find(key => key.includes('ìì‚°ë²ˆí˜¸'));
                    return k && row[k] && row[k].trim() !== "";
                });
                bar.innerText = `âœ… ë°ì´í„° ${allData.length}ê±´ ë™ê¸°í™” ì„±ê³µ!`;
            } catch (e) {
                bar.innerText = `âŒ ì—°ê²° ì—ëŸ¬!`;
            }
        }

        function openTab(id) {
            document.querySelectorAll('.content, .tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'date-tab' && calendar) setTimeout(() => calendar.render(), 100);
        }

        function findLatestMemo(row) {
            // ë‚ ì§œ ì—´(MM/DD) ì¤‘ ê°’ì´ ìˆëŠ” ë§ˆì§€ë§‰ ì—´ ì°¾ê¸°
            const dateKeys = Object.keys(row).filter(k => /\d{1,2}\/\d{1,2}/.test(k)).reverse();
            for (const key of dateKeys) {
                if (row[key] && row[key].trim()) return { date: key, content: row[key] };
            }
            return null;
        }

        function renderRow(row, specificDate = null) {
            const assetKey = Object.keys(row).find(k => k.includes('ìì‚°ë²ˆí˜¸'));
            const locKey = Object.keys(row).find(k => k.includes('í˜„ì¬ìœ„ì¹˜'));
            const deviceKey = Object.keys(row).find(k => k.includes('ê¸°ê¸°ëª…'));
            
            // í˜•ë‹˜ ìš”ì²­ ì–‘ì‹: ìœ„ì¹˜ / ì‹œíŠ¸ëª… / ìì‚°ë²ˆí˜¸ / íŠ¹ì´ì‚¬í•­
            const curLoc = row[locKey] || row._originTab;
            const curAsset = row[assetKey] || "ë²ˆí˜¸ì—†ìŒ";
            const curTab = row._originTab;
            
            const memoData = specificDate ? { date: specificDate, content: row[specificDate] } : findLatestMemo(row);
            const memoHtml = memoData ? `<div class="memo-box"><span class="memo-content">íŠ¹ì´ì‚¬í•­ (${memoData.content})</span></div>` : '<div style="color:#ccc; margin-top:5px;">íŠ¹ì´ì‚¬í•­ ì—†ìŒ</div>';

            return `
                <div class="card">
                    <div class="card-row">ìœ„ì¹˜ (${curLoc}) ì‹œíŠ¸ëª… (${curTab}) / ìì‚°ë²ˆí˜¸ (${curAsset})</div>
                    ${memoHtml}
                </div>
            `;
        }

        function filterData() {
            const loc = document.getElementById('locSelect').value;
            const dev = document.getElementById('devSelect').value;
            let res = allData;
            
            // 1. ì¥ì†Œ í•„í„°ë§: í˜„ì¬ìœ„ì¹˜ ì—´ í˜¹ì€ ì‹œíŠ¸ëª…ì— ì¥ì†Œì´ë¦„ì´ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
            if(loc) {
                res = res.filter(row => {
                    const lk = Object.keys(row).find(k => k.includes('í˜„ì¬ìœ„ì¹˜'));
                    return (row[lk] && row[lk].includes(loc)) || row._originTab.includes(loc);
                });
            }
            // 2. ì¥ë¹„ í•„í„°ë§: ê¸°ê¸°ëª… ì—´ í˜¹ì€ ì‹œíŠ¸ëª…ì— ì¥ë¹„ì´ë¦„ì´ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
            if(dev) {
                res = res.filter(row => {
                    const dk = Object.keys(row).find(k => k.includes('ê¸°ê¸°ëª…'));
                    return (row[dk] && row[dk].includes(dev)) || row._originTab.includes(dev);
                });
            }
            document.getElementById('placeResult').innerHTML = res.map(row => renderRow(row)).join('');
        }

        function searchByAsset() {
            const val = document.getElementById('assetInput').value.toLowerCase();
            const res = allData.filter(row => {
                const k = Object.keys(row).find(key => key.includes('ìì‚°ë²ˆí˜¸'));
                return row[k] && row[k].toString().toLowerCase().includes(val);
            });
            document.getElementById('searchResult').innerHTML = res.map(row => renderRow(row)).join('');
        }

        let calendar;
        function initCalendar() {
            if(calendar) return;
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'ko',
                events: (info, success) => {
                    let evts = [];
                    allData.forEach(row => {
                        Object.keys(row).forEach(k => {
                            if(/\d{1,2}\/\d{1,2}/.test(k) && row[k] && row[k].trim()) {
                                const [m, d] = k.split('/');
                                evts.push({ start: `2025-${m.padStart(2,'0')}-${d.padStart(2,'0')}`, display: 'background', color: '#ff7675' });
                            }
                        });
                    });
                    success(evts);
                },
                dateClick: info => {
                    const [y, m, d] = info.dateStr.split('-');
                    const k1 = `${m}/${d}`;
                    const k2 = `${parseInt(m)}/${parseInt(d)}`;
                    const res = allData.filter(row => (row[k1] && row[k1].trim()) || (row[k2] && row[k2].trim()));
                    document.getElementById('dateResult').innerHTML = `<h3>ğŸ“… ${info.dateStr} ê¸°ë¡</h3>` + 
                        res.map(row => renderRow(row, row[k1] ? k1 : k2)).join('');
                }
            });
            calendar.render();
        }
        init();
    </script>
</body>
</html>