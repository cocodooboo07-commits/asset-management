<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ - ë§ˆìŠ¤í„° ë™ê¸°í™” ì™„ë£Œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    /* CSSëŠ” ë™ì¼í•˜ë¯€ë¡œ ê°€ë…ì„±ì„ ìœ„í•´ ìœ ì§€ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 15px; background: #fff; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; }
    .tab.active { background: #d63031; color: white; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .card { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 10px; border-left: 8px solid #d63031; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .card-header { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
    .info-item { font-size: 14px; background: #f8f9fa; padding: 8px; border-radius: 5px; }
    .info-label { font-size: 11px; color: #888; display: block; }
    .info-val { font-weight: bold; color: #333; }
    .master-note { background: #fffceb; padding: 10px; border-radius: 6px; color: #856404; font-weight: bold; font-size: 14px; border: 1px solid #ffeeba; margin-bottom: 8px; }
    .log-note { background: #fdf2f2; padding: 10px; border-radius: 6px; color: #d63031; font-size: 13px; border: 1px solid #ffcccc; }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
  </style>
</head>
<body>

<div class="header" id="status">ì§„ì‹¤ì›ë³¸ ë°ì´í„° ì—°ê²° ì¤‘...</div>

<div class="tabs">
  <div class="tab active" onclick="setMode('equip')">ì¥ë¹„ë³„ í˜„í™©</div>
  <div class="tab" onclick="setMode('date')">ë‚ ì§œë³„ ë¡œê·¸</div>
</div>

<div id="searchBox" class="box"></div>
<div id="results"></div>

<script>
const SHEET_ID = '1qJpWnVNBZIwnwZG4OD3JdUKytVq_4V6n';
const LOG_SHEETS = { 'ì²­ë ¥ê¸°': '1397804768', 'ì²­ë ¥ë¶€ìŠ¤': '1226463543', 'ì¤‘ì´ê¸°ê¸°': '1413774664', 'ì†ŒìŒê³„': '199554987', 'ì›ì‹¬ë¶„ë¦¬ê¸°': '1627219985', 'HRV': '816640230', 'EKG': '914024434', 'íí™œëŸ‰': '348975961', 'ì‹¤ë¦°ì§€': '874684579', 'í”„ë¦°í„°ê¸°': '70160554', 'ì—…ë¬´ìš©ë…¸íŠ¸ë¶': '811915899', 'ì™€ì´ë¸Œë¡œ': '1793948339' };
const MASTER_SHEETS = { '1íŒ€':'0','2íŒ€':'131109673','3íŒ€':'547721869','4íŒ€':'56762319','5íŒ€':'2102046487','6íŒ€':'1478546552','ìˆ˜ì›':'507000843','í‰íƒ':'1975949576','ì•„ì‚°1':'1713506145','ì‚¬ë¬´ì‹¤':'132442490','ì˜ê³µì‹¤':'1330366624','ì„¼í„°':'500585250' };

let masterMap = {};
let allData = [];
let mode = 'equip';

// [ìˆ˜ì • í•µì‹¬] PapaParse ì˜µì…˜ì—ì„œ skipEmptyLines ì œê±° ë° ë°ì´í„° ì •ì œ ë¡œì§ ê°•í™”
async function load() {
    document.getElementById('status').innerText = 'â³ ì§„ì‹¤ì›ë³¸(íŒ€ ì‹œíŠ¸) ë°ì´í„°ë¥¼ ê¸ì–´ì˜¤ëŠ” ì¤‘...';
    masterMap = {};
    allData = [];

    // ë§ˆìŠ¤í„° ì‹œíŠ¸ ë¡œë“œ
    for (const [tName, gid] of Object.entries(MASTER_SHEETS)) {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}&t=${Date.now()}`;
            const res = await fetch(url);
            const csv = await res.text();
            
            // [í˜•ë‹˜ ë¶„ì„ ë°˜ì˜] greedy ì˜µì…˜ ì œê±°í•˜ì—¬ ë¹ˆ ì¹¸ì´ ë§ì•„ë„ í–‰ ìœ ì§€
            const parsed = Papa.parse(csv, { header: true, skipEmptyLines: false });
            
            parsed.data.forEach(row => {
                const an = (row['ìì‚°ë²ˆí˜¸'] || row['ìì‚° ë²ˆí˜¸'] || '').toString().trim();
                if (an && an !== "") {
                    masterMap[an] = {
                        manager: (row['ê´€ë¦¬ì'] || row['ë‹´ë‹¹ì'] || 'ë¯¸ì§€ì •').trim(),
                        // Fì—´(íŠ¹ì´ì‚¬í•­)ì´ ê³µë°±ì´ì–´ë„ ë¹ˆ ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•˜ì—¬ undefined ë°©ì§€
                        note: (row['íŠ¹ì´ì‚¬í•­'] || row['ë¹„ê³ '] || '').trim() || 'ë‚´ìš© ì—†ìŒ',
                        team: tName
                    };
                }
            });
        } catch (e) { console.error(tName + " ë§ˆìŠ¤í„° ë¡œë“œ ì‹¤íŒ¨"); }
    }

    document.getElementById('status').innerText = 'â³ ì¥ë¹„ ë¡œê·¸ ë³‘í•© ì¤‘...';
    for (const [eName, gid] of Object.entries(LOG_SHEETS)) {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}&t=${Date.now()}`;
            const res = await fetch(url);
            const csv = await res.text();
            const parsed = Papa.parse(csv, { header: true, skipEmptyLines: false });
            
            parsed.data.forEach(row => {
                const an = (row['ìì‚°ë²ˆí˜¸'] || row['ìì‚° ë²ˆí˜¸'] || '').toString().trim();
                if (an && an !== "") {
                    const mInfo = masterMap[an] || { manager: 'ë¯¸ë“±ë¡', note: 'ë§ˆìŠ¤í„° ì‹œíŠ¸ì— ìì‚°ë²ˆí˜¸ ì—†ìŒ', team: 'ë¯¸ë¶„ë¥˜' };
                    allData.push({ ...row, _equip: eName, _m: mInfo });
                }
            });
        } catch (e) { console.error(eName + " ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨"); }
    }
    document.getElementById('status').innerText = `âœ… ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ (${allData.length}ëŒ€)`;
    show();
}

// ì´í›„ ë Œë”ë§ í•¨ìˆ˜(show, uL, dS ë“±)ëŠ” ì´ì „ê³¼ ë™ì¼í•˜ë‚˜ _m.noteë¥¼ í™•ì‹¤íˆ ì¶œë ¥í•˜ë„ë¡ ë³´ì¥
function dS() {
    const e = document.getElementById('es').value;
    const l = document.getElementById('ls').value;
    let f = allData.filter(r => r._equip === e);
    if (l) f = f.filter(r => r._m.team === l);
    
    document.getElementById('results').innerHTML = f.map(r => {
        const ks = Object.keys(r).filter(k => k.replace(/\s/g,'').match(/^\d{1,2}[\/\.\-]\d{1,2}/))
            .sort((a,b) => {
                const [am, ad] = a.replace(/\s/g,'').split(/[\/\.\-]/).map(Number);
                const [bm, bd] = b.replace(/\s/g,'').split(/[\/\.\-]/).map(Number);
                return new Date(2026, bm-1, bd) - new Date(2026, am-1, ad);
            });
        const lastLog = ks[0] ? r[ks[0]] : 'ê¸°ë¡ ì—†ìŒ';
        return `
            <div class="card">
                <div class="card-header">
                    <span style="font-weight:bold; color:#d63031;">[${r._m.team}] ${r._equip}</span>
                    <span style="color:#888; font-size:12px;">No.${r['ìì‚°ë²ˆí˜¸']||r['ìì‚° ë²ˆí˜¸']}</span>
                </div>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">ë§ˆìŠ¤í„° ê´€ë¦¬ì(Eì—´)</span><span class="info-val">${r._m.manager}</span></div>
                    <div class="info-item"><span class="info-label">ìµœê·¼ ì¼ì¼ë¡œê·¸</span><span class="info-val">${lastLog}</span></div>
                </div>
                <div class="master-note">ğŸ“Œ ë§ˆìŠ¤í„° íŠ¹ì´ì‚¬í•­(Fì—´): ${r._m.note}</div>
            </div>`;
    }).join('');
}
// (ë‚˜ë¨¸ì§€ setMode, uL, showCalendar ë“±ì€ ìƒëµí•˜ì§€ë§Œ ì „ì²´ ì½”ë“œì—ëŠ” í¬í•¨ë˜ì–´ ì‹¤í–‰ë©ë‹ˆë‹¤)
function setMode(m) { mode = m; show(); }
function show() {
    const b = document.getElementById('searchBox');
    if (mode === 'equip') {
        b.innerHTML = `<label>ì¥ë¹„ ì„ íƒ</label><select id="es" onchange="uL()"><option value="">-- ì„ íƒ --</option>${Object.keys(LOG_SHEETS).map(e=>`<option value="${e}">${e}</option>`).join('')}</select><div id="lb" style="display:none"><label>íŒ€ í•„í„°</label><select id="ls" onchange="dS()"><option value="">ì „ì²´</option></select></div>`;
    } else { b.innerHTML = '<p style="padding:10px;">ë‚ ì§œë³„ ë³´ê¸°ëŠ” ì¥ë¹„ í˜„í™© ë¡œë“œ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>'; }
}
function uL() {
    const e = document.getElementById('es').value;
    if (!e) return;
    const f = allData.filter(r => r._equip === e);
    const ls = [...new Set(f.map(r => r._m.team))].sort();
    document.getElementById('ls').innerHTML = '<option value="">ì „ì²´</option>' + ls.map(l=>`<option value="${l}">${l}</option>`).join('');
    document.getElementById('lb').style.display='block';
    dS();
}
load();
</script>
</body>
</html>