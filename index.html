// ... (상단 CSS/HTML 동일)

async function load() {
  allData = [];
  document.getElementById('status').innerText = '⏳ 실시간 데이터 분석 중... (2026년)';
  
  for (const [name, gid] of Object.entries(SHEETS)) {
    try {
      // 캐시를 완전히 무시하고 가장 최신 데이터를 가져오는 파라미터 추가
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}&t=${new Date().getTime()}`;
      const res = await fetch(url, { cache: 'no-cache' }); 
      const csv = await res.text();
      const parsed = Papa.parse(csv.trim(), { header: true, skipEmptyLines: 'greedy' });
      
      parsed.data.forEach(row => {
        if (row['자산번호'] && row['자산번호'].trim()) {
          allData.push({ ...row, _equip: name });
        }
      });
    } catch (e) { console.error(name, "실패"); }
  }
  document.getElementById('status').innerText = `✅ 총 ${allData.length}대 동기화 완료`;
  show();
}

// 날짜 키를 유연하게 찾는 함수 (01/26이든 1/26이든 다 찾음)
function getFlexibleDateKey(row, targetDate) {
  const keys = Object.keys(row);
  const [m, d] = targetDate.split('/'); // targetDate는 항상 "01/26" 형식
  const altDate = `${parseInt(m)}/${parseInt(d)}`; // "1/26" 형식
  
  return keys.find(k => {
    const cleanK = k.trim().replace('-', '/');
    return cleanK === targetDate || cleanK === altDate;
  });
}

function showCalendar() {
  const box = document.getElementById('searchBox');
  const issueDates = new Set();
  
  allData.forEach(r => {
    Object.keys(r).forEach(k => {
      // 날짜 형태인 열 중에서 진짜 특이사항이 있는 날짜만 수집
      if (k.match(/^\d{1,2}[\/\-]\d{1,2}$/) && isRealIssue(r[k])) {
        const cleanK = k.trim().replace('-', '/');
        const [m, d] = cleanK.split('/');
        const standardized = `${m.padStart(2, '0')}/${d.padStart(2, '0')}`;
        issueDates.add(standardized);
      }
    });
  });

  const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
  const lastDate = new Date(currentYear, currentMonth, 0).getDate();

  let html = `<div class="month-nav"><button onclick="moveMonth(-1)">◀</button><b>${currentYear}년 ${currentMonth}월</b><button onclick="moveMonth(1)">▶</button></div><div class="calendar">`;
  ['일','월','화','수','목','금','토'].forEach(d => html += `<div class="cal-header">${d}</div>`);
  
  for (let i = 0; i < firstDay; i++) html += '<div></div>';
  for (let d = 1; d <= lastDate; d++) {
    const dStr = `${String(currentMonth).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
    // 특이사항이 있는 날이면 issue 클래스 추가
    html += `<div class="cal-day ${issueDates.has(dStr) ? 'issue' : ''}" onclick="showDateDetail('${dStr}')">${d}</div>`;
  }
  html += '</div><div id="dateRes"></div>';
  box.innerHTML = html;
}

function showDateDetail(date) {
  document.querySelectorAll('.cal-day').forEach(el => el.classList.remove('selected'));
  if(event.currentTarget.classList.contains('cal-day')) event.currentTarget.classList.add('selected');
  
  // 선택한 날짜에 진짜 특이사항이 있는 데이터만 필터링
  const found = allData.filter(r => {
    const key = getFlexibleDateKey(r, date);
    return key && isRealIssue(r[key]);
  });
  
  document.getElementById('dateRes').innerHTML = found.length === 0 ? 
    `<p style="text-align:center; padding:20px;">${date} 특이사항 없음</p>` : 
    found.map(r => {
      const key = getFlexibleDateKey(r, date);
      return `
        <div class="card">
          <div class="card-title">${parseLoc(r['현재위치'] || r['현재 위치'])} / ${r._equip} / ${r['자산번호']}</div>
          <div class="card-note">${r[key]}</div>
        </div>
      `;
    }).join('');
}