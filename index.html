<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ - ì •ë°€ ë¶„ë¥˜</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; }
    .tab.active { background: #d63031; color: white; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .card { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 10px; border-left: 10px solid #d63031; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .card-title { font-weight: bold; font-size: 14px; color: #222; margin-bottom: 8px; }
    .card-note { background: #fdf2f2; padding: 10px; border-radius: 6px; color: #d63031; font-size: 13px; border: 1px solid #ffcccc; font-weight: bold; }
    .cal-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 10px; }
    .cal-table td { border: 1px solid #ddd; height: 50px; text-align: center; cursor: pointer; position: relative; font-size: 12px; }
    .has-issue::after { content: 'ğŸ”´'; position: absolute; bottom: 2px; right: 2px; font-size: 10px; }
  </style>
</head>
<body>

<div class="header" id="status">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
<div class="tabs">
  <div class="tab active" id="tab1" onclick="setMode('equip')">ì¥ë¹„ ê²€ìƒ‰</div>
  <div class="tab" id="tab2" onclick="setMode('date')">ì‚¬ê³ /íŒŒì†</div>
</div>
<div id="searchBox" class="box"></div>
<div id="results"></div>

<script>
const SID = '1qJpWnVNBZIwnwZG4OD3JdUKytVq_4V6n';
const SHEETS = {'ì²­ë ¥ê¸°':'1397804768','ì²­ë ¥ë¶€ìŠ¤':'1226463543','ì¤‘ì´ê¸°ê¸°':'1413774664','ì†ŒìŒê³„':'199554987','ì›ì‹¬ë¶„ë¦¬ê¸°':'1627219985','HRV':'816640230','EKG':'914024434','íí™œëŸ‰':'348975961','ì‹¤ë¦°ì§€':'874684579','í”„ë¦°í„°ê¸°':'70160554','ì—…ë¬´ìš©ë…¸íŠ¸ë¶':'811915899','ì™€ì´ë¸Œë¡œ':'1793948339'};
let allData = [];
let mode = 'equip';

// í˜•ë‹˜ ëª…ë ¹: íŒŒì†/ì‚¬ê³ ë§Œ ë”²!
function isRealIssue(t) {
  if(!t) return false;
  const c = t.toString().replace(/\s/g, '');
  const ok = ['ì •ìƒ','ì´ìƒì—†ìŒ','íŠ¹ì´ì‚¬í•­ì—†ìŒ','ì™„ë£Œ','-','ë³´ìœ ','ë‚´ìš©ì—†ìŒ'];
  return !ok.some(n => c.includes(n)) && c.length > 1;
}

// í˜•ë‹˜ ëª…ë ¹: ì¥ì†Œ ëŒ€ê°€ë¦¬ êµ´ë ¤ì„œ ë§µí•‘
function smartLoc(v) {
  const s = (v || '').toString().trim();
  if(!s) return 'ë¯¸ë¶„ë¥˜(ë¹ˆì¹¸)';
  if(s.includes('ì•„ì‚°')) return 'ì•„ì‚°1';
  if(s.includes('ì˜ê³µ')) return 'ì˜ê³µì‹¤';
  if(s.includes('ì‚¬ë¬´')) return 'ì‚¬ë¬´ì‹¤';
  if(s.includes('ì„¼í„°')) return 'ì„¼í„°';
  if(s.includes('í‰íƒ')) return 'í‰íƒ';
  if(s.includes('ìˆ˜ì›')) return 'ìˆ˜ì›';
  for(let i=1; i<=6; i++) { if(s.includes(i+'íŒ€') || (s.includes(i) && s.length < 3)) return i+'íŒ€'; }
  return s; // ê·¸ ì™¸ ì íŒ ëŒ€ë¡œ
}

function getLatest(r) {
  const ks = Object.keys(r).filter(k => k.match(/^\d{1,2}[\/\-]\d{1,2}$/));
  const sorted = ks.sort((a,b) => {
    const [am, ad] = a.split(/[\/\-]/).map(Number);
    const [bm, bd] = b.split(/[\/\-]/).map(Number);
    return (bm===1?13:bm)*100+bd - (am===1?13:am)*100+ad;
  });
  return sorted.length ? { d: sorted[0], v: r[sorted[0]] } : { d: 'ê¸°ë¡ì—†ìŒ', v: 'ë‚´ìš©ì—†ìŒ' };
}

async function load() {
  allData = [];
  for (const [nm, gid] of Object.entries(SHEETS)) {
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res = await fetch(url);
      const csv = await res.text();
      const p = Papa.parse(csv.trim(), {header: true, skipEmptyLines: true});
      p.data.forEach(r => {
        const asset = r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'];
        if(asset && asset.length > 5) { // ìœ íš¨í•œ ìì‚°ë²ˆí˜¸ë§Œ
          allData.push({ ...r, _eq: nm, _loc: smartLoc(r['í˜„ì¬ìœ„ì¹˜']||r['í˜„ì¬ ìœ„ì¹˜']), _asset: asset });
        }
      });
    } catch (e) {}
  }
  // í˜•ë‹˜ ë§ì”€í•˜ì‹  230ëŒ€ ìˆ˜ì¤€ìœ¼ë¡œ ë”²!
  document.getElementById('status').innerText = `âœ… ì¥ë¹„ ${allData.length}ëŒ€ ìµœì‹ í™” ì™„ë£Œ (1/28)`;
  show();
}

function setMode(m) { mode = m; show(); }

function show() {
  const b = document.getElementById('searchBox');
  b.innerHTML = '';
  document.getElementById('results').innerHTML = '';
  if(mode === 'equip') {
    const locs = ['1íŒ€','2íŒ€','3íŒ€','4íŒ€','5íŒ€','6íŒ€','ì•„ì‚°1','ì‚¬ë¬´ì‹¤','ì˜ê³µì‹¤','ì„¼í„°','í‰íƒ','ìˆ˜ì›','ë¯¸ë¶„ë¥˜(ë¹ˆì¹¸)'];
    b.innerHTML = `<label>ì¥ë¹„</label><select id="es" onchange="uL()"><option value="">--ì„ íƒ--</option>${Object.keys(SHEETS).map(e=>`<option value="${e}">${e}</option>`).join('')}</select><div id="lb" style="display:none"><label>ì¥ì†Œ</label><select id="ls" onchange="dS()"><option value="">ì „ì²´ë³´ê¸°</option>${locs.map(l=>`<option value="${l}">${l}</option>`).join('')}</select></div>`;
  } else showCal();
}

function uL() { document.getElementById('lb').style.display = 'block'; dS(); }

function dS() {
  const e = document.getElementById('es').value;
  const l = document.getElementById('ls').value;
  let f = allData.filter(r => r._eq === e);
  if(l) f = f.filter(r => r._loc === l);
  document.getElementById('results').innerHTML = f.map(r => {
    const log = getLatest(r);
    const st = log.v.includes('ë°˜ë‚©') ? 'ë°˜ë‚©' : (log.v.includes('ìˆ˜ë ¹') ? 'ìˆ˜ë ¹' : 'ë³´ìœ ');
    return `<div class="card"><div class="card-title">${r._loc} ${st} / ${r._eq} / ${r._asset}</div><div class="card-note">${log.d} : ${log.v}</div></div>`;
  }).join('');
}

function showCal() {
  const issueDays = new Set();
  allData.forEach(r => Object.keys(r).forEach(k => { if(k.match(/^\d{1,2}[\/\-]\d{1,2}$/) && isRealIssue(r[k])) issueDays.add(k); }));
  let h = `<div class="box" style="text-align:center;"><b>2026ë…„ 1ì›” ì‚¬ê³  ë¡œê·¸</b><table class="cal-table"><tr>`;
  for(let d=1; d<=31; d++) {
    const s = `1/${d}`;
    h += `<td class="${issueDays.has(s)?'has-issue':''}" onclick="sD('1/${d}')">${d}</td>`;
    if(d%7===0) h += '</tr><tr>';
  }
  document.getElementById('searchBox').innerHTML = h + '</tr></table></div><div id="dr"></div>';
}

function sD(s) {
  const [m, d] = s.split('/').map(Number);
  const f = allData.filter(r => isRealIssue(r[s]));
  document.getElementById('dr').innerHTML = f.map(r => `<div class="card"><div class="card-title">${r._loc} / ${r._eq} / ${r._asset}</div><div class="card-note">ğŸš¨ ${r[s]}</div></div>`).join('') || '<p style="text-align:center;padding:20px;">ë¬¸ì œ ì—†ìŒ</p>';
}

load();
</script>
</body>
</html>