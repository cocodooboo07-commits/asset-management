<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë¹„ ê´€ë¦¬ í†µí•© ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; padding: 10px; background: #f0f2f5; }
        .status-bar { background: #000; color: #0f0; padding: 10px; font-size: 13px; margin-bottom: 10px; border-radius: 5px; font-family: monospace; border: 1px solid #0f0; }
        .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; }
        .tab-btn { flex: 0 0 auto; padding: 12px 15px; cursor: pointer; border: none; background: #ccc; font-weight: bold; border-radius: 8px; }
        .tab-btn.active { background: #007bff; color: white; }
        .content { display: none; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-height: 500px; }
        .content.active { display: block; }
        select, input { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .card { border-left: 6px solid #007bff; background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-header { font-size: 0.85em; color: #666; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .card-title { font-size: 1.1em; font-weight: bold; color: #333; margin: 8px 0; }
        .info-row { font-size: 0.95em; margin-bottom: 10px; color: #444; }
        .memo-box { background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 10px; }
        .memo-label { display: block; font-size: 0.8em; color: #cf1322; font-weight: bold; margin-bottom: 5px; }
        .memo-content { font-size: 0.9em; color: #333; line-height: 1.5; white-space: pre-wrap; }
    </style>
</head>
<body>

    <div class="status-bar" id="statusBar">ë°ì´í„° ë¡œë”© ì¤‘...</div>

    <div class="tab-menu">
        <button class="tab-btn active" onclick="openTab('search-tab')">ğŸ” ìì‚°ë²ˆí˜¸ ê²€ìƒ‰</button>
        <button class="tab-btn" onclick="openTab('place-tab')">ğŸ“ ì¥ì†Œ/ì¥ë¹„ ê²€ìƒ‰</button>
        <button class="tab-btn" onclick="initCalendar(); openTab('date-tab')">ğŸ“… ë‚ ì§œë³„ íŠ¹ì´ì‚¬í•­</button>
    </div>

    <div id="search-tab" class="content active">
        <input type="text" id="assetInput" placeholder="ìì‚°ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeyup="searchByAsset()">
        <div id="searchResult"></div>
    </div>

    <div id="place-tab" class="content">
        <select id="locSelect" onchange="filterData()">
            <option value="">1. ì¥ì†Œ ì„ íƒ</option>
            <option value="ìˆ˜ì›">ìˆ˜ì›</option><option value="ì•„ì‚°1">ì•„ì‚°1</option>
            <option value="í‰íƒ">í‰íƒ</option><option value="ì‚¬ë¬´ì‹¤">ì‚¬ë¬´ì‹¤</option>
        </select>
        <select id="devSelect" onchange="filterData()">
            <option value="">2. ì¥ë¹„ ì„ íƒ</option>
            <option value="ì²­ë ¥ê¸°">ì²­ë ¥ê¸°</option><option value="ì²­ë ¥ë¶€ìŠ¤">ì²­ë ¥ë¶€ìŠ¤</option>
            <option value="ì¤‘ì´ê¸°ê¸°">ì¤‘ì´ê¸°ê¸°</option><option value="ì†ŒìŒê³„">ì†ŒìŒê³„</option>
            <option value="ì›ì‹¬ë¶„ë¦¬ê¸°">ì›ì‹¬ë¶„ë¦¬ê¸°</option><option value="HRV">HRV</option>
            <option value="EKG">EKG</option><option value="íí™œëŸ‰">íí™œëŸ‰</option>
            <option value="ì‹¤ë¦°ì§€">ì‹¤ë¦°ì§€</option><option value="í”„ë¦°í„°ê¸°">í”„ë¦°í„°ê¸°</option>
            <option value="ì—…ë¬´ìš©ë…¸íŠ¸ë¶">ì—…ë¬´ìš©ë…¸íŠ¸ë¶</option><option value="ì™€ì´ë¸Œë¡œ">ì™€ì´ë¸Œë¡œ</option>
        </select>
        <div id="placeResult"></div>
    </div>

    <div id="date-tab" class="content">
        <div id="calendar"></div>
        <div id="dateResult"></div>
    </div>

    <script>
        const sheetId = "12xhA0X6iOrg-4mq9KWZsQ9nPb2818P5VGUDXQMhjeTw";
        const sheetGids = [
            {name: "ì²­ë ¥ê¸°", gid: "1397804768"}, {name: "ì²­ë ¥ë¶€ìŠ¤", gid: "1226463543"},
            {name: "ì¤‘ì´ê¸°ê¸°", gid: "1413774664"}, {name: "ì†ŒìŒê³„", gid: "199554987"},
            {name: "ì›ì‹¬ë¶„ë¦¬ê¸°", gid: "1627219985"}, {name: "HRV", gid: "816640230"},
            {name: "EKG", gid: "914024434"}, {name: "íí™œëŸ‰", gid: "348975961"},
            {name: "ì‹¤ë¦°ì§€", gid: "874684579"}, {name: "í”„ë¦°í„°ê¸°", gid: "70160554"},
            {name: "ì—…ë¬´ìš©ë…¸íŠ¸ë¶", gid: "811915899"}, {name: "ì™€ì´ë¸Œë¡œ", gid: "1793948339"},
            {name: "ìˆ˜ì›", gid: "1112786"}, {name: "ì•„ì‚°1", gid: "1052607410"},
            {name: "í‰íƒ", gid: "503432091"}, {name: "ì‚¬ë¬´ì‹¤", gid: "734953362"}
        ];
        
        let allData = [];

        async function init() {
            const bar = document.getElementById('statusBar');
            try {
                const promises = sheetGids.map(info => {
                    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${info.gid}`;
                    return new Promise(resolve => {
                        Papa.parse(url, {
                            download: true, header: true,
                            complete: res => resolve(res.data.map(row => ({ ...row, _origin: info.name }))),
                            error: () => resolve([])
                        });
                    });
                });
                const results = await Promise.all(promises);
                allData = results.flat().filter(row => {
                    const keys = Object.keys(row);
                    const assetKey = keys.find(k => k.includes('ìì‚°ë²ˆí˜¸'));
                    return assetKey && row[assetKey] && row[assetKey].toString().trim() !== "";
                });
                bar.innerText = `âœ… ë°ì´í„° ${allData.length}ê±´ ë¡œë“œ ì™„ë£Œ!`;
            } catch (e) {
                bar.innerText = `âŒ ì—°ê²° ì‹¤íŒ¨! ì‹œíŠ¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.`;
            }
        }

        function openTab(id) {
            document.querySelectorAll('.content, .tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'date-tab' && calendar) { setTimeout(() => calendar.render(), 100); }
        }

        function findLatestMemo(row) {
            // ë‚ ì§œ í˜•ì‹(XX/XX)ì˜ ì—´ ì¤‘ì—ì„œ ê°’ì´ ìˆëŠ” ê°€ì¥ ì˜¤ë¥¸ìª½(ìµœê·¼) ê°’ì„ ì°¾ìŒ
            const dateKeys = Object.keys(row).filter(k => /\d{1,2}\/\d{1,2}/.test(k)).reverse();
            for (const key of dateKeys) {
                if (row[key] && row[key].trim()) {
                    return { date: key, content: row[key] };
                }
            }
            return null;
        }

        function renderCard(row, specificDateKey = null) {
            const assetKey = Object.keys(row).find(k => k.includes('ìì‚°ë²ˆí˜¸'));
            const deviceKey = Object.keys(row).find(k => k.includes('ê¸°ê¸°ëª…'));
            const locKey = Object.keys(row).find(k => k.includes('í˜„ì¬ìœ„ì¹˜'));
            
            const memoData = specificDateKey ? { date: specificDateKey, content: row[specificDateKey] } : findLatestMemo(row);
            const memoHtml = (memoData && memoData.content) ? `
                <div class="memo-box">
                    <span class="memo-label">âš ï¸ íŠ¹ì´ì‚¬í•­ (${memoData.date} ê¸°ë¡)</span>
                    <div class="memo-content">${memoData.content}</div>
                </div>
            ` : `<div style="color:#999; font-size:0.85em;">- ìµœê·¼ íŠ¹ì´ì‚¬í•­ ì—†ìŒ -</div>`;

            return `
                <div class="card">
                    <div class="card-header">ì‹œíŠ¸: ${row._origin}</div>
                    <div class="card-title">${row[assetKey]} (${row[deviceKey] || 'ê¸°ê¸°ëª… ì—†ìŒ'})</div>
                    <div class="info-row">ğŸ“ ìœ„ì¹˜: ${row[locKey] || row._origin}</div>
                    ${memoHtml}
                </div>
            `;
        }

        function searchByAsset() {
            const val = document.getElementById('assetInput').value.toLowerCase();
            const res = allData.filter(row => {
                const k = Object.keys(row).find(k => k.includes('ìì‚°ë²ˆí˜¸'));
                return row[k] && row[k].toString().toLowerCase().includes(val);
            });
            document.getElementById('searchResult').innerHTML = res.map(row => renderCard(row)).join('');
        }

        function filterData() {
            const loc = document.getElementById('locSelect').value;
            const dev = document.getElementById('devSelect').value;
            let res = allData;
            if(loc) res = res.filter(row => (row['í˜„ì¬ìœ„ì¹˜'] || row._origin).includes(loc));
            if(dev) res = res.filter(row => (row['ê¸°ê¸°ëª…'] || row._origin).includes(dev));
            document.getElementById('placeResult').innerHTML = res.map(row => renderCard(row)).join('');
        }

        let calendar;
        function initCalendar() {
            if(calendar) return;
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'ko',
                events: (info, success) => {
                    let evts = [];
                    allData.forEach(row => {
                        Object.keys(row).forEach(k => {
                            if(/\d{1,2}\/\d{1,2}/.test(k) && row[k] && row[k].trim()) {
                                const [m, d] = k.split('/');
                                evts.push({ start: `2025-${m.padStart(2,'0')}-${d.padStart(2,'0')}`, display: 'background', color: '#ff4d4f' });
                            }
                        });
                    });
                    success(evts);
                },
                dateClick: info => showDate(info.dateStr)
            });
            calendar.render();
        }

        function showDate(dateStr) {
            const [y, m, d] = dateStr.split('-');
            // 01/23ê³¼ 1/23 ëª¨ë‘ ëŒ€ì‘
            const key1 = `${m}/${d}`;
            const key2 = `${parseInt(m)}/${parseInt(d)}`;
            const res = allData.filter(row => (row[key1] && row[key1].trim()) || (row[key2] && row[key2].trim()));
            
            document.getElementById('dateResult').innerHTML = `<h3>ğŸ“… ${dateStr} íŠ¹ì´ì‚¬í•­ ë¦¬ìŠ¤íŠ¸</h3>` + 
                res.map(row => renderCard(row, (row[key1] ? key1 : key2))).join('');
        }

        init();
    </script>
</body>
</html>