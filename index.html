<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë¹„ ê´€ë¦¬ - í˜„ì¬ìœ„ì¹˜ ê¸°ì¤€</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    label { font-size: 13px; font-weight: bold; color: #444; display: block; margin: 10px 0 5px 5px; }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; background: #fff; }
    .card { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 10px; border-left: 10px solid #d63031; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .card-title { font-weight: bold; font-size: 15px; color: #111; margin-bottom: 5px; }
    .card-note { background: #fdf2f2; padding: 10px; border-radius: 6px; color: #d63031; font-size: 13px; border: 1px solid #ffcccc; font-weight: bold; }
  </style>
</head>
<body>

<div class="header">ì‹¤ì‹œê°„ ì¥ë¹„ í˜„í™© (í˜„ì¬ìœ„ì¹˜ ìš°ì„ )</div>

<div class="box">
  <label>1. ì¥ë¹„ ì„ íƒ</label>
  <select id="selEquip" onchange="updateLocList()">
    <option value="">-- ì¥ë¹„ ì„ íƒ --</option>
  </select>
  
  <label>2. ì¥ì†Œ ì„ íƒ (ì‹œíŠ¸ ê¸€ì ê·¸ëŒ€ë¡œ)</label>
  <select id="selLoc" onchange="render()">
    <option value="">-- ì¥ë¹„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš” --</option>
  </select>
</div>

<div id="results"></div>

<script>
const SID = '1qJpWnVNBZIwnwZG4OD3JdUKytVq_4V6n';
const SHEETS = {'ì²­ë ¥ê¸°':'1397804768','ì²­ë ¥ë¶€ìŠ¤':'1226463543','ì¤‘ì´ê¸°ê¸°':'1413774664','ì†ŒìŒê³„':'199554987','ì›ì‹¬ë¶„ë¦¬ê¸°':'1627219985','HRV':'816640230','EKG':'914024434','íí™œëŸ‰':'348975961','ì‹¤ë¦°ì§€':'874684579','í”„ë¦°í„°ê¸°':'70160554','ì—…ë¬´ìš©ë…¸íŠ¸ë¶':'811915899','ì™€ì´ë¸Œë¡œ':'1793948339'};
let allData = [];

// ê°€ì¥ ìµœì‹  ë‚ ì§œ ì—´ ì°¾ê¸°
function getLatestLog(r) {
    const keys = Object.keys(r).filter(k => k.match(/^\d{1,2}[\/\-]\d{1,2}$/));
    const sorted = keys.sort((a,b) => {
        const [am, ad] = a.split(/[\/\-]/).map(Number);
        const [bm, bd] = b.split(/[\/\-]/).map(Number);
        const vA = (am === 1 ? 13 : am) * 100 + ad;
        const vB = (bm === 1 ? 13 : bm) * 100 + bd;
        return vB - vA;
    });
    for(let k of sorted) {
        if(r[k] && r[k].trim() !== "") return { d: k, v: r[k] };
    }
    return { d: "ê¸°ë¡ì—†ìŒ", v: "ë‚´ìš©ì—†ìŒ" };
}

async function load() {
  const selE = document.getElementById('selEquip');
  for (const [name, gid] of Object.entries(SHEETS)) {
    selE.innerHTML += `<option value="${name}">${name}</option>`;
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res = await fetch(url);
      const csv = await res.text();
      const p = Papa.parse(csv.trim(), {header: true, skipEmptyLines: true});
      p.data.forEach(r => {
        const asset = (r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || "").trim();
        if(asset) {
          const loc = (r['í˜„ì¬ìœ„ì¹˜'] || r['í˜„ì¬ ìœ„ì¹˜'] || "ë¯¸ì…ë ¥").trim();
          allData.push({ ...r, _type: name, _loc: loc, _asset: asset });
        }
      });
    } catch (e) {}
  }
  document.getElementById('header').innerText += " (ë¡œë“œ ì™„ë£Œ)";
}

function updateLocList() {
    const type = document.getElementById('selEquip').value;
    const locSel = document.getElementById('selLoc');
    locSel.innerHTML = '<option value="">ì „ì²´ë³´ê¸°</option>';
    
    if(!type) return;
    
    const filtered = allData.filter(d => d._type === type);
    const locs = [...new Set(filtered.map(d => d._loc))].sort();
    
    locs.forEach(l => {
        locSel.innerHTML += `<option value="${l}">${l}</option>`;
    });
    render();
}

function render() {
  const type = document.getElementById('selEquip').value;
  const loc = document.getElementById('selLoc').value;
  if(!type) return;

  let filtered = allData.filter(d => d._type === type);
  if(loc) filtered = filtered.filter(d => d._loc === loc);

  document.getElementById('results').innerHTML = filtered.map(d => {
    const log = getLatestLog(d);
    return `
      <div class="card">
        <div class="card-title">[${d._loc}] ${d._type} - ${d._asset}</div>
        <div class="card-note">ğŸ—“ï¸ ${log.d} ìµœì‹ ë¡œê·¸: ${log.v}</div>
      </div>`;
  }).join('');
}

load();
</script>
</body>
</html>