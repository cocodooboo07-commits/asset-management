<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìì‚° í†µí•© ê´€ë¦¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #f0f2f5; }
        .status-bar { background: #333; color: #0f0; padding: 10px; font-size: 12px; margin-bottom: 10px; border-radius: 5px; font-family: monospace; }
        .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 15px 5px; cursor: pointer; border: none; background: #ccc; font-weight: bold; border-radius: 8px; }
        .tab-btn.active { background: #007bff; color: white; }
        .content { display: none; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-height: 500px; }
        .content.active { display: block; }
        select, input { width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .card { border-left: 6px solid #007bff; background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-title { font-weight: bold; font-size: 1.1em; color: #333; }
        .memo { margin-top: 10px; padding: 10px; background: #fff1f0; border: 1px solid #ffa39e; border-radius: 5px; color: #cf1322; font-weight: bold; }
    </style>
</head>
<body>

    <div class="status-bar" id="statusBar">ì‹œìŠ¤í…œ ê°€ë™ ì¤‘... ì‹œíŠ¸ ì—°ê²° í™•ì¸ ì¤‘...</div>

    <div class="tab-menu">
        <button class="tab-btn active" onclick="openTab('search-tab')">ğŸ” ìì‚°ë²ˆí˜¸ ê²€ìƒ‰</button>
        <button class="tab-btn" onclick="openTab('place-tab')">ğŸ“ ì¥ì†Œ/ì¥ë¹„ ì„ íƒ</button>
        <button class="tab-btn" onclick="initCalendar(); openTab('date-tab')">ğŸ“… ë‚ ì§œë³„ íŠ¹ì´ì‚¬í•­</button>
    </div>

    <div id="search-tab" class="content active">
        <input type="text" id="assetInput" placeholder="ìì‚°ë²ˆí˜¸ ì…ë ¥ í›„ ì ì‹œ ê¸°ë‹¤ë¦¬ì‡¼..." onkeyup="searchByAsset()">
        <div id="searchResult"></div>
    </div>

    <div id="place-tab" class="content">
        <select id="locSelect" onchange="updateDeviceSelect()">
            <option value="">1. ì¥ì†Œ ì„ íƒ (ìˆ˜ì›, ì•„ì‚°1, í‰íƒ...)</option>
            <option value="ìˆ˜ì›">ìˆ˜ì›</option>
            <option value="ì•„ì‚°1">ì•„ì‚°1</option>
            <option value="í‰íƒ">í‰íƒ</option>
            <option value="ì‚¬ë¬´ì‹¤">ì‚¬ë¬´ì‹¤</option>
        </select>
        <select id="devSelect" onchange="filterByLocAndDev()">
            <option value="">2. ì¥ë¹„ ì„ íƒ (ì²­ë ¥ê¸°, ì†ŒìŒê³„...)</option>
        </select>
        <div id="placeResult"></div>
    </div>

    <div id="date-tab" class="content">
        <div id="calendar"></div>
        <div id="dateResult"></div>
    </div>

    <script>
        const sheetId = "12xhA0X6iOrg-4mq9KWZsQ9nPb2818P5VGUDXQMhjeTw";
        const devSheets = ["ì²­ë ¥ê¸°","ì²­ë ¥ë¶€ìŠ¤","ì¤‘ì´ê¸°ê¸°","ì†ŒìŒê³„","ì›ì‹¬ë¶„ë¦¬ê¸°","HRV","EKG","íí™œëŸ‰","ì‹¤ë¦°ì§€","í”„ë¦°í„°ê¸°","ì—…ë¬´ìš©ë…¸íŠ¸ë¶","ì™€ì´ë¸Œë¡œ"];
        const locSheets = ["ìˆ˜ì›","ì•„ì‚°1","í‰íƒ","ì‚¬ë¬´ì‹¤"];
        const allSheets = [...devSheets, ...locSheets];
        
        let allData = [];

        async function init() {
            const bar = document.getElementById('statusBar');
            try {
                const promises = allSheets.map(name => {
                    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`;
                    return new Promise(resolve => {
                        Papa.parse(url, {
                            download: true, header: true,
                            complete: res => resolve(res.data.map(row => ({ ...row, _origin: name }))),
                            error: () => resolve([])
                        });
                    });
                });
                const results = await Promise.all(promises);
                allData = results.flat().filter(row => Object.values(row).some(v => v));
                bar.innerText = `âœ… ì—°ê²° ì™„ë£Œ: ë°ì´í„° ${allData.length}ê±´ ë¡œë“œë¨.`;
                
                const devSel = document.getElementById('devSelect');
                devSheets.forEach(n => {
                    const opt = document.createElement('option');
                    opt.value = n; opt.text = n; devSel.add(opt);
                });
            } catch (e) {
                bar.innerText = `âŒ ì—°ê²° ì‹¤íŒ¨: ê³µìœ  ì„¤ì •ì´ë‚˜ ì‹œíŠ¸ëª…ì„ í™•ì¸í•˜ì‡¼!`;
            }
        }

        function openTab(id) {
            document.querySelectorAll('.content, .tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'date-tab' && calendar) calendar.render();
        }

        // ì¥ì†Œ ì„ íƒ ì‹œ ì¥ë¹„ í•„í„°ë§ ì¤€ë¹„
        function updateDeviceSelect() { filterByLocAndDev(); }

        function filterByLocAndDev() {
            const loc = document.getElementById('locSelect').value;
            const dev = document.getElementById('devSelect').value;
            let res = allData;
            if(loc) res = res.filter(row => (row['í˜„ì¬ìœ„ì¹˜'] || '').includes(loc) || row._origin === loc);
            if(dev) res = res.filter(row => (row['ê¸°ê¸°ëª…'] || '').includes(dev) || row._origin === dev);
            render(res, 'placeResult');
        }

        function searchByAsset() {
            const val = document.getElementById('assetInput').value.toLowerCase();
            const res = allData.filter(row => {
                const key = Object.keys(row).find(k => k.includes('ìì‚°ë²ˆí˜¸'));
                return row[key] && row[key].toString().toLowerCase().includes(val);
            });
            render(res, 'searchResult');
        }

        let calendar;
        function initCalendar() {
            if(calendar) return;
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'ko',
                events: (info, success) => {
                    let evts = [];
                    allData.forEach(row => {
                        Object.keys(row).forEach(k => {
                            if(/\d{2}\/\d{2}/.test(k) && row[k] && row[k].trim()) {
                                const [m, d] = k.split('/');
                                evts.push({ start: `2025-${m}-${d}`, display: 'background', color: '#ff4d4f' });
                            }
                        });
                    });
                    success(evts);
                },
                dateClick: info => showDate(info.dateStr)
            });
            calendar.render();
        }

        function showDate(dateStr) {
            const [y, m, d] = dateStr.split('-');
            const key1 = `${m}/${d}`; // 01/23 í˜•ì‹
            const res = allData.filter(row => (row[key1] && row[key1].trim()));
            document.getElementById('dateResult').innerHTML = `<h3>ğŸ“… ${dateStr} íŠ¹ì´ì‚¬í•­</h3>`;
            render(res, 'dateResult', key1);
        }

        function render(data, targetId, dateKey = null) {
            const target = document.getElementById(targetId);
            if(!data.length) { target.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            target.innerHTML = data.map(row => {
                const asset = row[Object.keys(row).find(k => k.includes('ìì‚°ë²ˆí˜¸'))] || 'ë²ˆí˜¸ì—†ìŒ';
                const device = row[Object.keys(row).find(k => k.includes('ê¸°ê¸°ëª…'))] || 'ê¸°ê¸°ëª…ì—†ìŒ';
                const memo = dateKey ? row[dateKey] : '';
                return `
                    <div class="card">
                        <div class="card-title">${asset} <small>[${row._origin}]</small></div>
                        <div>ê¸°ê¸°ëª…: ${device} | ìœ„ì¹˜: ${row['í˜„ì¬ìœ„ì¹˜'] || row._origin}</div>
                        ${memo ? `<div class="memo">âš ï¸ íŠ¹ì´ì‚¬í•­: ${memo}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        init();
    </script>
</body>
</html>