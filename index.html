<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Malgun Gothic', sans-serif; background: #f0f2f5; padding: 10px; }
    .header { background: #d63031; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 10px; margin-bottom: 10px; font-size: 14px; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 12px; background: #fff; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-weight: bold; cursor: pointer; font-size: 13px; }
    .tab.active { background: #d63031; color: white; }
    .box { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
    select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .card { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 8px solid #d63031; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card.normal { border-left-color: #2d3436; }
    .card.issue { border-left-color: #d63031; background: #fff5f5; }
    .card-title { font-weight: bold; font-size: 15px; color: #333; margin-bottom: 5px; }
    .card-note { background: #fdf2f2; padding: 10px; border-radius: 5px; color: #d63031; font-weight: bold; font-size: 14px; border: 1px solid #ff7675; }
    .card-note.normal { background: #f8f9fa; color: #2d3436; border-color: #dfe6e9; }
    .download-btn { display: inline-block; margin-top: 10px; padding: 12px 24px; background: #00b894; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-decoration: none; }
    .download-btn:hover { background: #00a383; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    .search-box { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 15px; }
    .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 15px; }
    .page-btn { padding: 8px 12px; background: #f8f9fa; border: 2px solid #dfe6e9; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .page-btn.active { background: #d63031; color: white; border-color: #d63031; }
    .page-btn:hover { background: #e8f5e9; }
    .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #2d3436; }
    .modal-close { float: right; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
    .modal-close:hover { color: #000; }
    .recipient-btn { display: block; width: 100%; padding: 15px; margin: 8px 0; background: #f8f9fa; border: 2px solid #dfe6e9; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
    .recipient-btn:hover { background: #d63031; color: white; border-color: #d63031; }
    .equipment-checkbox { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
    .select-all-btn { padding: 10px 20px; background: #0984e3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px; }
    .select-all-btn:hover { background: #0770c9; }
    .send-email-btn { padding: 12px 30px; background: #00b894; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
    .send-email-btn:hover { background: #00a383; }
    .button-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; gap: 1px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .cal-header { padding: 10px; text-align: center; font-weight: bold; background: #f8f9fa; font-size: 12px; }
    .cal-day { height: 60px; background: #fff; padding: 5px; text-align: left; font-size: 12px; cursor: pointer; position: relative; }
    .cal-day.issue { background: #fff0f0; }
    .cal-day.issue::after { content: 'âš ï¸'; position: absolute; bottom: 5px; right: 5px; font-size: 12px; color: #d63031; }
    .cal-day.selected { background: #d63031 !important; color: white !important; }
    .month-nav { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
    .month-nav button { padding: 10px 20px; background: #d63031; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

<!-- ë©”ì¸ ì•± -->
<div id="mainApp">
<div class="header" id="status">ë°ì´í„° ì—°ê²° ì¤‘... v20260130-0230-REAL-FINAL</div>
<div class="tabs">
  <div class="tab active" id="tab-equip" onclick="setMode('equip')">ì¥ë¹„ â†’ ì¥ì†Œ</div>
  <div class="tab" id="tab-location" onclick="setMode('location')">ì¥ì†Œ</div>
  <div class="tab" id="tab-date" onclick="setMode('date')">ë‚ ì§œë³„ ê¸°ë¡</div>
</div>
<div id="searchBox" class="box"></div>
<div id="results"></div>

<div id="emailModal" class="modal" onclick="if(event.target === this) closeEmailModal();">
  <div class="modal-content">
    <span class="modal-close" onclick="closeEmailModal()">&times;</span>
    <div class="modal-title">ğŸ“§ ìˆ˜ì‹ ì ì„ íƒ</div>
    <div id="recipientList"></div>
  </div>
</div>
</div>

<script>
const APP_VERSION = 'v20260130-0230-REAL-FINAL';
const SHEET_ID = '12xhA0X6iOrg-4mq9KWZsQ9nPb2818P5VGUDXQMhjeTw';
const SHEETS = { 
  'ì²­ë ¥ê¸°': '1720829217', 'ì²­ë ¥ë¶€ìŠ¤': '783939503', 'ì¤‘ì´ê¸°ê¸°': '951007328', 
  'ì†ŒìŒê³„': '389015843', 'ì›ì‹¬ë¶„ë¦¬ê¸°': '1430550353', 'HRV': '575182905', 
  'EKG': '37674733', 'íí™œëŸ‰': '2106009043', 'ì‹¤ë¦°ì§€': '829162327', 
  'í”„ë¦°í„°ê¸°': '283353512', 'ì—…ë¬´ìš©ë…¸íŠ¸ë¶': '239338022', 'ì™€ì´ë¸Œë¡œ': '763688386' 
};

// ì¥ë¹„ë³„ ìƒ‰ìƒ (12ê°€ì§€)
const EQUIPMENT_COLORS = {
  'ì²­ë ¥ê¸°': '#3498db',
  'ì²­ë ¥ë¶€ìŠ¤': '#9b59b6',
  'ì¤‘ì´ê¸°ê¸°': '#1abc9c',
  'ì†ŒìŒê³„': '#f39c12',
  'ì›ì‹¬ë¶„ë¦¬ê¸°': '#e67e22',
  'HRV': '#16a085',
  'EKG': '#8e44ad',
  'íí™œëŸ‰': '#2980b9',
  'ì‹¤ë¦°ì§€': '#27ae60',
  'í”„ë¦°í„°ê¸°': '#2c3e50',
  'ì—…ë¬´ìš©ë…¸íŠ¸ë¶': '#c0392b',
  'ì™€ì´ë¸Œë¡œ': '#d35400'
};

// íí™œëŸ‰ ìì‚°ë²ˆí˜¸ â†’ ë…¸íŠ¸ë¶ ëª¨ë¸/S/N ë§¤í•‘
const LUNG_ASSET_MAPPING = {
  '50601-00770': { model: 'NT300E5K-K34S', sn: '0N8V91IHB00202E' },
  '50601-00771': { model: 'NT270E5R-KD1S', sn: 'JKGK91KFC00009R' },
  '50601-00772': { model: 'NT270E5R-KD1S', sn: 'JKGK91KFC00410Y' },
  '50601-00773': { model: 'NT270E5R-KD1S', sn: 'JKGK91KFC00281R' },
  '50601-00774': { model: 'NT300E5K-L26W', sn: '0QP191IU100958E' },
  '50601-00775': { model: 'NT300E5X-AD2S', sn: 'HxX391RD100005B' },
  '50601-00776': { model: 'NT300E5C-A39S', sn: 'JkMM91DF300107K' },
  '50601-00822': { model: 'NT300E5K-K34S', sn: '0N8V91IHB00226K' },
  '50601-00823': { model: 'NT300E5R-KD3A', sn: 'OUMN91JJC00115M' },
  '50601-00863': { model: 'NT300E5K-L26W', sn: '0QP191IU201075D' },
  '50601-00864': { model: 'NT300E5K-L26W', sn: '0QP191IJ200766K' },
  '50601-00871': { model: 'NT550EAZ-AD2A', sn: '0WGE91AKC00159Y' },
  '50601-00872': { model: 'NT300E5R-KD3A', sn: '0UMN91CJC00017V' },
  '50601-00873': { model: 'NT300E5X-AD2S', sn: 'HxX391PD100015E' },
  '50601-00949': { model: 'NT550EAZ-AD2A', sn: '0WGE91AKC00012H' },
  '50601-00950': { model: 'NT270E5R-KD1S', sn: 'JKGK91KFC00319X' },
  '50601-00951': { model: 'NT270E5R-KD1S', sn: 'JKGK91KFC00086Z' },
  '50601-00964': { model: 'NT300E5K-L26W', sn: '0QP191GJ100332Z' },
  '50601-00965': { model: 'NT300E5K-L26W', sn: '0QP191AJ101068A' },
  '50601-00966': { model: 'NT550EAZ-AD2A', sn: '0WGE91AK800199N' },
  '50601-00967': { model: 'NT550EAZ-AD2A', sn: '0WGE91AKC00042E' },
  '50601-00968': { model: 'NT550EAZ-AD2A', sn: '0WGE91AK900074X' },
  '50601-00969': { model: 'NT550EAZ-AD2A', sn: '0WGE91AKC00039D' },
  '50601-01533': { model: 'NT551XED', sn: '67A29FCX100010E' },
  '50601-01534': { model: 'NT551XED', sn: '67A29FCX100020K' },
  '50601-01535': { model: 'NT551XED', sn: '67A29FCX100006M' },
  '50601-01536': { model: 'NT551XED-K0U/C', sn: '67A29FCX100011T' },
  '50601-01537': { model: 'NT551XED', sn: '67A29FCX100009Y' },
  '50601-01538': { model: 'NT551XED', sn: '67A29FCX100008J' },
  '50601-01539': { model: 'NT551XED', sn: '67A29FCX100025N' },
  '50601-01632': { model: 'NT751XGK-K03/C', sn: 'KYPD99YY90000BH' },
  '50601-01633': { model: 'NT751XGK-K03/C', sn: 'KYPD99YY90003KX' },
  '50601-01634': { model: 'NT751XGK-K03/C', sn: 'KYPD99YY90003KX' },
  '50601-01635': { model: 'NT751XGK-K03/C', sn: 'KYPD99YY90003WB' },
  '50601-01636': { model: 'NT751XGK-K03/C', sn: 'KYPD99YY90003P' },
  '50601-01637': { model: 'NT751XGK-K03/C', sn: 'KYPD99YY90005F' },
  '50601-01638': { model: 'NT751XGK-K03/C', sn: 'KYPD99YY900006' },
  '50601-01639': { model: 'NT751XGK-K03/C', sn: 'KYPD99YY90003S' }
};

const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzNrE3s08iOZndyR7estzZOMw_vd5BHz6zqwd0ogki5m00C6dOxRiySD4VgIy2Io3AQ/exec';

const ALLOWED_USERS = [
  'sj0206.ahn@samsung.com',
  'heroboy07@hanmail.net',
  'cocodooboo07@gmail.com'
  // ì—¬ê¸°ì— í—ˆìš©í•  ì´ë©”ì¼ ì¶”ê°€
];

const EMAIL_SENDERS = {
  'ì¡°í•´ì˜': 'hy0617.jo@samsung.com',
  'ë°±ìˆ˜ë¹ˆ': 'subeen2319.baek@samsung.com',
  'ì•ˆì„±ì§„': 'sj0206.ahn@samsung.com',
  'ê¹€ë³´í˜„': 'bohyeon6601.kim@samsung.com',
  'ê¹€ì •ë¯¼': 'jm0605.kim@samsung.com',
  'ê³ í¬ì§„': 'heejin3579.ko@samsung.com',
  'ì´ì§€ì—°': 'joanna0812.lee@samsung.com',
  'ì‹ ìˆ˜ì¸': 'suingss0120.shin@samsung.com',
};

const EMAIL_RECIPIENTS = {
  'ì¡°í•´ì˜': 'hy0617.jo@samsung.com',
  'ë°±ìˆ˜ë¹ˆ': 'subeen2319.baek@samsung.com',
  'ì•ˆì„±ì§„': 'sj0206.ahn@samsung.com',
  'ê¹€ë³´í˜„': 'bohyeon6601.kim@samsung.com',
  'ê¹€ì •ë¯¼': 'jm0605.kim@samsung.com',
  'ê³ í¬ì§„': 'heejin3579.ko@samsung.com',
  'ì´ì§€ì—°': 'joanna0812.lee@samsung.com',
  'ì‹ ìˆ˜ì¸': 'suingss0120.shin@samsung.com',
  'ì•ˆí™©ì½”': 'heroboy07@hanmail.net',
};

let allData = [];
let mode = 'equip';
let currentYear = 2026;
let currentMonth = 1;
const IGNORE_TEXT = ["íŠ¹ì´ì‚¬í•­ì—†ìŒ", "íŠ¹ì´ì‚¬í•­ ì—†ìŒ", "ì´ìƒì—†ìŒ", "ì´ìƒ ì—†ìŒ"];
const FIXED_LOCATIONS = ['1', '2', '3', '4', '5', '6', 'í‰íƒ', 'ìˆ˜ì›', 'ì•„ì‚°1', 'ì‚¬ë¬´ì‹¤', 'ì˜ê³µì‹¤', 'ì„¼í„°', 'ë¯¸ì„ íƒ'];
let currentLocation = null;
let selectedSender = null;
let currentSenderPage = 1;
let currentRecipientPage = 1;
let senderSearchQuery = '';
let recipientSearchQuery = '';
const ITEMS_PER_PAGE = 5;

// í—ˆìš©ëœ ì´ë©”ì¼ ëª©ë¡ (ì—¬ê¸°ì— ì¶”ê°€/ì‚­ì œ)
async function load() {
  allData = [];
  const startTime = new Date();
  document.getElementById('status').innerText = 'Loading... ' + APP_VERSION;
  
  for (const [name, gid] of Object.entries(SHEETS)) {
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}&t=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      const csv = await res.text();
      const parsed = Papa.parse(csv.trim(), { header: true, skipEmptyLines: true });
      
      parsed.data.forEach(row => {
        const assetNum = row['ìì‚°ë²ˆí˜¸'] || row['ìì‚° ë²ˆí˜¸'] || '';
        if (assetNum && assetNum.trim()) {
          allData.push({ ...row, _equip: name });
        }
      });
    } catch (e) {
      console.error(name + ' failed:', e);
    }
  }
  
  const loadTime = ((new Date() - startTime) / 1000).toFixed(1);
  document.getElementById('status').innerText = allData.length + ' devices (' + loadTime + 's) ' + APP_VERSION;
  show();
}

function isRealIssue(text) {
  if (!text || !text.trim()) return false;
  const clean = text.replace(/\s/g, "").toLowerCase();
  for (const ig of IGNORE_TEXT) {
    const cleanIgnore = ig.replace(/\s/g, "").toLowerCase();
    if (clean === cleanIgnore || clean.includes(cleanIgnore)) return false;
  }
  return true;
}

function parseCurrentLocation(row) {
  const val = row['í˜„ì¬ìœ„ì¹˜'] || row['í˜„ì¬ ìœ„ì¹˜'] || '';
  if (!val || !val.trim()) return { location: "ë¯¸ì„ íƒ", date: null };
  
  const str = val.toString().trim();
  const dateMatch = str.match(/\((\d{1,2})\/(\d{1,2})\)/);
  const date = dateMatch ? dateMatch[1].padStart(2, '0') + '/' + dateMatch[2].padStart(2, '0') : null;
  
  const cleanStr = str.replace(/\(.*?\)/g, '').trim();
  
  let location = "ë¯¸ì„ íƒ";
  if (cleanStr.includes('ì•„ì‚°1')) location = 'ì•„ì‚°1';
  else if (cleanStr.includes('í‰íƒ')) location = 'í‰íƒ';
  else if (cleanStr.includes('ìˆ˜ì›')) location = 'ìˆ˜ì›';
  else if (cleanStr.includes('ì‚¬ë¬´ì‹¤')) location = 'ì‚¬ë¬´ì‹¤';
  else if (cleanStr.includes('ì„¼í„°')) location = 'ì„¼í„°';
  else if (cleanStr.includes('ì˜ê³µì‹¤')) location = 'ì˜ê³µì‹¤';
  else {
    const match = cleanStr.match(/(?:^|[^\d])([1-6])(?:íŒ€|[^\d]|$)/);
    if (match) location = match[1];
  }
  
  return { location, date };
}

function getEquipmentNumber(row) {
  const equipName = row['ê¸°ê¸°ëª…'] || '';
  const match = equipName.match(/\((\d+)\)/);
  return match ? match[1] : '';
}

function getDetailByDate(row, targetDate) {
  if (!targetDate) return null;
  const dateKeys = Object.keys(row).filter(k => k.match(/^\d{1,2}[\/\-]\d{1,2}$/));
  for (const key of dateKeys) {
    const normalized = key.trim().replace('-', '/').split('/').map(p => p.padStart(2, '0')).join('/');
    if (normalized === targetDate && row[key] && row[key].trim()) {
      return row[key].trim();
    }
  }
  return null;
}

function setMode(m) {
  mode = m;
  document.getElementById('tab-equip').classList.toggle('active', m === 'equip');
  document.getElementById('tab-location').classList.toggle('active', m === 'location');
  document.getElementById('tab-date').classList.toggle('active', m === 'date');
  show();
}

function show() {
  const b = document.getElementById('searchBox');
  document.getElementById('results').innerHTML = '';
  
  if (mode === 'equip') {
    const equipCounts = {};
    Object.keys(SHEETS).forEach(name => {
      equipCounts[name] = allData.filter(r => r._equip === name).length;
    });
    b.innerHTML = '<label>ì¥ë¹„ ì„ íƒ</label><select id="es" onchange="updateLocations()"><option value="">ì„ íƒ</option>' + Object.keys(SHEETS).map(e => '<option value="' + e + '">' + e + ' (' + equipCounts[e] + 'ê°œ)</option>').join('') + '</select><div id="lb" style="display:none"><label>ì¥ì†Œ í•„í„°</label><select id="ls" onchange="displayResults()"><option value="">ì¥ì†Œ ì„ íƒ</option></select></div>';
  } else if (mode === 'location') {
    const locationCounts = {};
    FIXED_LOCATIONS.forEach(loc => {
      locationCounts[loc] = allData.filter(r => parseCurrentLocation(r).location === loc).length;
    });
    b.innerHTML = '<label>ì¥ì†Œ ì„ íƒ</label><select id="locationSelect" onchange="displayLocationResults()"><option value="">ì„ íƒ</option>' + FIXED_LOCATIONS.map(l => '<option value="' + l + '">' + (/^[1-6]$/.test(l) ? l + 'íŒ€' : l) + ' (' + locationCounts[l] + 'ê°œ)</option>').join('') + '</select>';
  } else {
    showCalendar();
  }
}

function updateLocations() {
  const eq = document.getElementById('es').value;
  if (!eq) {
    document.getElementById('lb').style.display = 'none';
    document.getElementById('results').innerHTML = '';
    return;
  }
  
  let totalEquipCount = 0;
  const locationCounts = {};
  
  if (eq === 'ì „ì²´') {
    FIXED_LOCATIONS.forEach(loc => {
      const count = allData.filter(r => parseCurrentLocation(r).location === loc).length;
      locationCounts[loc] = count;
      totalEquipCount += count;
    });
  } else {
    FIXED_LOCATIONS.forEach(loc => {
      const count = allData.filter(r => r._equip === eq && parseCurrentLocation(r).location === loc).length;
      locationCounts[loc] = count;
      totalEquipCount += count;
    });
  }
  
  document.getElementById('ls').innerHTML = '<option value="">ì¥ì†Œ ì„ íƒ</option><option value="ì „ì²´">ì „ì²´ (' + totalEquipCount + 'ê°œ)</option>' + FIXED_LOCATIONS.map(l => '<option value="' + l + '">' + (/^[1-6]$/.test(l) ? l + 'íŒ€' : l) + ' (' + locationCounts[l] + 'ê°œ)</option>').join('');
  document.getElementById('lb').style.display = 'block';
  document.getElementById('results').innerHTML = '';
}

function displayResults() {
  const eq = document.getElementById('es').value;
  const loc = document.getElementById('ls').value;
  if (!loc) {
    document.getElementById('results').innerHTML = '<p style="padding:20px; text-align:center; color:#999;">ì¥ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>';
    return;
  }
  
  let found;
  if (loc === 'ì „ì²´') {
    // í•´ë‹¹ ì¥ë¹„ì˜ ëª¨ë“  ì¥ì†Œ ë³´ê¸°
    found = allData.filter(r => r._equip === eq);
  } else {
    found = allData.filter(r => r._equip === eq && parseCurrentLocation(r).location === loc);
  }
  
  if (found.length === 0) {
    document.getElementById('results').innerHTML = '<p style="padding:20px; text-align:center; color:#999;">í•´ë‹¹ ì¥ì†Œì— ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    return;
  }
  document.getElementById('results').innerHTML = found.map(r => {
    const data = parseCurrentLocation(r);
    const locName = /^[1-6]$/.test(data.location) ? data.location + 'íŒ€' : data.location;
    const assetNum = r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '';
    const equipNum = getEquipmentNumber(r);
    const detail = data.date ? getDetailByDate(r, data.date) : null;
    let state = "ë³´ìœ ";
    if (detail) {
      const cleanDetail = detail.replace(/\s/g, '').toLowerCase();
      if (cleanDetail.includes("ë°˜ë‚©ì˜ˆì •")) state = "ë°˜ë‚©ì˜ˆì •";
      else if (cleanDetail.includes("ìˆ˜ë ¹ì˜ˆì •")) state = "ìˆ˜ë ¹ì˜ˆì •";
      else if (cleanDetail.includes("ë°˜ë‚©")) state = "ë°˜ë‚©";
      else if (cleanDetail.includes("ìˆ˜ë ¹")) state = "ìˆ˜ë ¹";
    }
    let person = "", issue = detail || "ê¸°ë¡ ì—†ìŒ";
    if (detail) {
      const match = detail.match(/\(([^-]+)-([^)]+)\)/) || detail.match(/([ê°€-í£]+)\s*-\s*(.+)/);
      if (match) {
        person = match[1].trim();
        issue = match[2].trim();
      }
    }
    const equipDisplay = equipNum ? r._equip + '(' + equipNum + ')' : r._equip;
    const hasIssue = detail && isRealIssue(detail);
    const cardClass = hasIssue ? 'card issue' : 'card normal';
    const noteClass = hasIssue ? 'card-note' : 'card-note normal';
    const equipColor = EQUIPMENT_COLORS[r._equip] || '#2d3436';
    
    // ëª¨ë¸ëª…ê³¼ S/N ì¶”ê°€
    let modelName = r['ëª¨ë¸'] || '';
    let serialNum = r['ì œì¡°ë²ˆí˜¸'] || r['ì œì¡° ë²ˆí˜¸'] || '';
    
    // íí™œëŸ‰ì€ ìì‚°ë²ˆí˜¸ë¡œ ë§¤í•‘
    if (r._equip === 'íí™œëŸ‰' && LUNG_ASSET_MAPPING[assetNum]) {
      modelName = LUNG_ASSET_MAPPING[assetNum].model;
      serialNum = LUNG_ASSET_MAPPING[assetNum].sn;
    }
    
    const modelInfo = (modelName || serialNum) ? ' (ëª¨ë¸ëª… - ' + modelName + ' , S/N - ' + serialNum + ')' : '';
    
    return '<div class="' + cardClass + '"><div class="card-title" style="color:' + equipColor + ';">' + locName + ' ' + state + ' / ' + equipDisplay + ' / ' + assetNum + modelInfo + '</div><div class="' + noteClass + '">' + (data.date || 'ìµœê·¼') + ' ' + (person ? person + ' - ' : '') + issue + '</div></div>';
  }).join('');
}

function displayLocationResults() {
  const loc = document.getElementById('locationSelect').value;
  if (!loc) {
    document.getElementById('results').innerHTML = '';
    return;
  }
  let found = allData.filter(r => parseCurrentLocation(r).location === loc);
  if (found.length === 0) {
    document.getElementById('results').innerHTML = '<p style="padding:20px; text-align:center; color:#999;">í•´ë‹¹ ì¥ì†Œì— ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    return;
  }
  let html = '<div class="button-group"><div><button class="select-all-btn" onclick="selectAllEquipment(true)">âœ“ ì „ì²´ì„ íƒ</button><button class="select-all-btn" onclick="selectAllEquipment(false)">âœ— ì „ì²´í•´ì œ</button></div><button class="send-email-btn" onclick="showEmailModalWithSelection(\'' + loc + '\')">ğŸ“§ ì„ íƒí•­ëª© ë©”ì¼ ì „ì†¡</button></div>';
  html += found.map(r => {
    const data = parseCurrentLocation(r);
    const locName = /^[1-6]$/.test(data.location) ? data.location + 'íŒ€' : data.location;
    const assetNum = r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '';
    const equipNum = getEquipmentNumber(r);
    const detail = data.date ? getDetailByDate(r, data.date) : null;
    let state = "ë³´ìœ ";
    if (detail) {
      const cleanDetail = detail.replace(/\s/g, '').toLowerCase();
      if (cleanDetail.includes("ë°˜ë‚©ì˜ˆì •")) state = "ë°˜ë‚©ì˜ˆì •";
      else if (cleanDetail.includes("ìˆ˜ë ¹ì˜ˆì •")) state = "ìˆ˜ë ¹ì˜ˆì •";
      else if (cleanDetail.includes("ë°˜ë‚©")) state = "ë°˜ë‚©";
      else if (cleanDetail.includes("ìˆ˜ë ¹")) state = "ìˆ˜ë ¹";
    }
    let person = "", issue = detail || "ê¸°ë¡ ì—†ìŒ";
    if (detail) {
      const match = detail.match(/\(([^-]+)-([^)]+)\)/) || detail.match(/([ê°€-í£]+)\s*-\s*(.+)/);
      if (match) {
        person = match[1].trim();
        issue = match[2].trim();
      }
    }
    const equipDisplay = equipNum ? r._equip + '(' + equipNum + ')' : r._equip;
    const hasIssue = detail && isRealIssue(detail);
    const cardClass = hasIssue ? 'card issue' : 'card normal';
    const noteClass = hasIssue ? 'card-note' : 'card-note normal';
    const equipColor = EQUIPMENT_COLORS[r._equip] || '#2d3436';
    
    // ëª¨ë¸ëª…ê³¼ S/N ì¶”ê°€
    let modelName = r['ëª¨ë¸'] || '';
    let serialNum = r['ì œì¡°ë²ˆí˜¸'] || r['ì œì¡° ë²ˆí˜¸'] || '';
    
    // íí™œëŸ‰ì€ ìì‚°ë²ˆí˜¸ë¡œ ë§¤í•‘
    if (r._equip === 'íí™œëŸ‰' && LUNG_ASSET_MAPPING[assetNum]) {
      modelName = LUNG_ASSET_MAPPING[assetNum].model;
      serialNum = LUNG_ASSET_MAPPING[assetNum].sn;
    }
    
    const modelInfo = (modelName || serialNum) ? ' (ëª¨ë¸ëª… - ' + modelName + ' , S/N - ' + serialNum + ')' : '';
    
    const equipData = JSON.stringify({
      'ê¸°ê¸°ëª…': r['ê¸°ê¸°ëª…'] || '',
      'ëª¨ë¸': modelName,
      'ì œì¡°ë²ˆí˜¸': serialNum,
      'ìì‚°ë²ˆí˜¸': assetNum
    }).replace(/'/g, '&apos;');
    return '<div class="' + cardClass + '" style="display: flex; align-items: center;"><input type="checkbox" class="equipment-checkbox" data-equipment=\'' + equipData + '\' checked><div style="flex: 1;"><div class="card-title" style="color:' + equipColor + ';">' + locName + ' ' + state + ' / ' + equipDisplay + ' / ' + assetNum + modelInfo + '</div><div class="' + noteClass + '">' + (data.date || 'ìµœê·¼') + ' ' + (person ? person + ' - ' : '') + issue + '</div></div></div>';
  }).join('');
  document.getElementById('results').innerHTML = html;
}

function selectAllEquipment(checked) {
  document.querySelectorAll('.equipment-checkbox').forEach(cb => cb.checked = checked);
}

function showEmailModalWithSelection(location) {
  const selectedCheckboxes = document.querySelectorAll('.equipment-checkbox:checked');
  if (selectedCheckboxes.length === 0) {
    alert('âš ï¸ ì „ì†¡í•  ì¥ë¹„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
    return;
  }
  selectedSender = null;
  currentSenderPage = 1;
  senderSearchQuery = '';
  currentLocation = location;
  const modal = document.getElementById('emailModal');
  renderSenderList(selectedCheckboxes.length);
  modal.style.display = 'block';
}

function renderSenderList(equipmentCount) {
  const senders = Object.keys(EMAIL_SENDERS);
  const filtered = senders.filter(name => name.toLowerCase().includes(senderSearchQuery.toLowerCase()) || EMAIL_SENDERS[name].toLowerCase().includes(senderSearchQuery.toLowerCase()));
  const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
  const startIdx = (currentSenderPage - 1) * ITEMS_PER_PAGE;
  const endIdx = startIdx + ITEMS_PER_PAGE;
  const currentItems = filtered.slice(startIdx, endIdx);
  let html = '<div style="margin-bottom: 20px; font-size: 18px; font-weight: bold; color: #2d3436;">1ï¸âƒ£ ë³´ë‚´ëŠ” ì‚¬ëŒ ì„ íƒ</div><div style="margin-bottom: 15px; padding: 10px; background: #f0f3ff; border-radius: 8px; color: #0984e3; font-weight: bold;">âœ“ ' + equipmentCount + 'ê°œ ì¥ë¹„ ì„ íƒë¨</div><input type="text" class="search-box" placeholder="ğŸ” ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰..." value="' + senderSearchQuery + '" oninput="senderSearchQuery = this.value; currentSenderPage = 1; renderSenderList(' + equipmentCount + ');">';
  html += currentItems.map(name => '<button class="recipient-btn" onclick="selectSender(\'' + name + '\')">' + name + '<br><small style="color:#636e72;">' + EMAIL_SENDERS[name] + '</small></button>').join('');
  if (totalPages > 1) {
    html += '<div class="pagination">';
    for (let i = 1; i <= totalPages; i++) {
      html += '<button class="page-btn' + (i === currentSenderPage ? ' active' : '') + '" onclick="currentSenderPage = ' + i + '; renderSenderList(' + equipmentCount + ');">' + i + '</button>';
    }
    html += '</div>';
  }
  document.getElementById('recipientList').innerHTML = html;
}

function selectSender(senderName) {
  selectedSender = senderName;
  currentRecipientPage = 1;
  recipientSearchQuery = '';
  renderRecipientList();
}

function renderRecipientList() {
  const recipients = Object.keys(EMAIL_RECIPIENTS);
  const filtered = recipients.filter(name => name.toLowerCase().includes(recipientSearchQuery.toLowerCase()) || EMAIL_RECIPIENTS[name].toLowerCase().includes(recipientSearchQuery.toLowerCase()));
  const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
  const startIdx = (currentRecipientPage - 1) * ITEMS_PER_PAGE;
  const endIdx = startIdx + ITEMS_PER_PAGE;
  const currentItems = filtered.slice(startIdx, endIdx);
  let html = '<div style="margin-bottom: 15px; padding: 10px; background: #e8f5e9; border-radius: 8px; color: #27ae60; font-weight: bold;">ğŸ“¤ ë³´ë‚´ëŠ” ì‚¬ëŒ: ' + selectedSender + '</div><div style="margin-bottom: 20px; font-size: 18px; font-weight: bold; color: #2d3436;">2ï¸âƒ£ ë°›ëŠ” ì‚¬ëŒ ì„ íƒ</div><input type="text" class="search-box" placeholder="ğŸ” ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰..." value="' + recipientSearchQuery + '" oninput="recipientSearchQuery = this.value; currentRecipientPage = 1; renderRecipientList();">';
  html += currentItems.map(name => '<button class="recipient-btn" onclick="sendEmailWithSelection(\'' + name + '\')">' + name + '<br><small style="color:#636e72;">' + EMAIL_RECIPIENTS[name] + '</small></button>').join('');
  if (totalPages > 1) {
    html += '<div class="pagination">';
    for (let i = 1; i <= totalPages; i++) {
      html += '<button class="page-btn' + (i === currentRecipientPage ? ' active' : '') + '" onclick="currentRecipientPage = ' + i + '; renderRecipientList();">' + i + '</button>';
    }
    html += '</div>';
  }
  document.getElementById('recipientList').innerHTML = html;
}

function closeEmailModal() {
  selectedSender = null;
  currentSenderPage = 1;
  currentRecipientPage = 1;
  senderSearchQuery = '';
  recipientSearchQuery = '';
  document.getElementById('emailModal').style.display = 'none';
}

async function sendEmailWithSelection(recipientName) {
  const recipient = EMAIL_RECIPIENTS[recipientName];
  const sender = EMAIL_SENDERS[selectedSender];
  const senderName = selectedSender;
  const location = currentLocation;
  const locName = /^[1-6]$/.test(location) ? location + 'íŒ€' : location;
  
  if (!selectedSender) {
    alert('âš ï¸ ë°œì‹ ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
    return;
  }
  
  const selectedCheckboxes = document.querySelectorAll('.equipment-checkbox:checked');
  const selectedEquipment = Array.from(selectedCheckboxes).map(cb => JSON.parse(cb.getAttribute('data-equipment').replace(/&apos;/g, "'")));
  
  if (selectedEquipment.length === 0) {
    alert('âš ï¸ ì „ì†¡í•  ì¥ë¹„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
    return;
  }
  
  // ëª¨ë‹¬ ìƒˆë¡œ ë Œë”ë§
  document.getElementById('recipientList').innerHTML = '<div style="text-align:center; padding:40px;"><div style="font-size:40px;">ğŸ“§</div><div style="margin-top:20px; font-size:18px; font-weight:bold;">ë©”ì¼ ì „ì†¡ ì¤‘...</div><div style="margin-top:10px; color:#636e72;">' + selectedEquipment.length + 'ê°œ ì¥ë¹„</div></div>';
  
  try {
    // ìì‚°ë²ˆí˜¸ ì œê±°, ìˆœë²ˆë§Œ ì¶”ê°€
    const numberedEquipment = selectedEquipment.map((item, index) => ({
      'ìˆœë²ˆ': index + 1,
      'ê¸°ê¸°ëª…': item['ê¸°ê¸°ëª…'],
      'ëª¨ë¸': item['ëª¨ë¸'],
      'S/N': item['ì œì¡°ë²ˆí˜¸']
    }));
    
    const ws = XLSX.utils.json_to_sheet(numberedEquipment);
    ws['!cols'] = [{ wch: 8 }, { wch: 35 }, { wch: 18 }, { wch: 20 }];
    
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = range.s.r; R <= range.e.r; ++R) {
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
        if (!ws[cell_address]) continue;
        if (!ws[cell_address].s) ws[cell_address].s = {};
        ws[cell_address].s = {
          alignment: { horizontal: 'center', vertical: 'center' },
          border: {
            top: { style: 'medium', color: { rgb: '000000' } },
            bottom: { style: 'medium', color: { rgb: '000000' } },
            left: { style: 'medium', color: { rgb: '000000' } },
            right: { style: 'medium', color: { rgb: '000000' } }
          },
          fill: R === 0 ? { fgColor: { rgb: '4CAF50' } } : { fgColor: { rgb: 'FFFFFF' } },
          font: R === 0 ? { bold: true, color: { rgb: 'FFFFFF' }, sz: 12 } : { sz: 11 }
        };
      }
    }
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, locName);
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
    const fileName = locName + '_ì¥ë¹„ëª©ë¡_' + selectedEquipment.length + 'ê°œ_' + new Date().toISOString().slice(0, 10) + '.xlsx';
    
    await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        recipient: recipient,
        sender: sender,
        senderName: senderName,
        locationName: locName,
        excelBase64: wbout,
        fileName: fileName
      })
    });
    
    document.getElementById('recipientList').innerHTML = '<div style="text-align:center; padding:40px;"><div style="font-size:60px;">ğŸ“¨</div><div style="margin-top:20px; font-size:18px; font-weight:bold; color:#00b894;">ë©”ì¼ ì „ì†¡ ìš”ì²­ ì™„ë£Œ!</div><div style="margin-top:10px; color:#636e72;">' + senderName + ' â†’ ' + recipientName + '<br>' + selectedEquipment.length + 'ê°œ ì¥ë¹„</div><div style="margin-top:15px; font-size:14px; color:#636e72;">ìˆ˜ì‹ ì ë©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br>(ìŠ¤íŒ¸í•¨ë„ í™•ì¸)</div><button class="download-btn" onclick="closeEmailModal();" style="margin-top:20px;">ë‹«ê¸°</button></div>';
    
  } catch (error) {
    document.getElementById('recipientList').innerHTML = '<div style="text-align:center; padding:40px;"><div style="font-size:60px;">âŒ</div><div style="margin-top:20px; font-size:18px; font-weight:bold; color:#d63031;">ì „ì†¡ ì‹¤íŒ¨</div><div style="margin-top:10px; color:#636e72;">' + error.message + '</div><button class="download-btn" onclick="closeEmailModal();" style="margin-top:20px;">ë‹«ê¸°</button></div>';
  }
}

function showCalendar() {
  const b = document.getElementById('searchBox');
  const issueDates = new Set();
  allData.forEach(r => {
    const data = parseCurrentLocation(r);
    if (data.date) {
      const detail = getDetailByDate(r, data.date);
      if (detail && isRealIssue(detail)) issueDates.add(data.date);
    }
  });
  const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
  const lastDate = new Date(currentYear, currentMonth, 0).getDate();
  let html = '<div class="month-nav"><button onclick="moveMonth(-1)">â—€</button><b>' + currentYear + 'ë…„ ' + currentMonth + 'ì›”</b><button onclick="moveMonth(1)">â–¶</button></div><div class="calendar">';
  ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(d => { html += '<div class="cal-header">' + d + '</div>'; });
  for (let i = 0; i < firstDay; i++) html += '<div></div>';
  for (let d = 1; d <= lastDate; d++) {
    const dateStr = String(currentMonth).padStart(2, '0') + '/' + String(d).padStart(2, '0');
    html += '<div class="cal-day' + (issueDates.has(dateStr) ? ' issue' : '') + '" onclick="selectDate(\'' + dateStr + '\', this)">' + d + '</div>';
  }
  html += '</div><div id="dateRes"></div>';
  b.innerHTML = html;
}

function moveMonth(direction) {
  currentMonth += direction;
  if (currentMonth > 12) { currentMonth = 1; currentYear++; }
  else if (currentMonth < 1) { currentMonth = 12; currentYear--; }
  showCalendar();
}

function selectDate(dateStr, element) {
  document.querySelectorAll('.cal-day').forEach(x => x.classList.remove('selected'));
  element.classList.add('selected');
  const found = allData.filter(r => {
    const data = parseCurrentLocation(r);
    if (data.date !== dateStr) return false;
    const detail = getDetailByDate(r, data.date);
    return detail && isRealIssue(detail);
  });
  if (found.length === 0) {
    document.getElementById('dateRes').innerHTML = '<p style="padding:20px; text-align:center;">íŠ¹ì´ì‚¬í•­ ì—†ìŒ</p>';
    return;
  }
  document.getElementById('dateRes').innerHTML = found.map(r => {
    const data = parseCurrentLocation(r);
    const locName = /^[1-6]$/.test(data.location) ? data.location + 'íŒ€' : data.location;
    const assetNum = r['ìì‚°ë²ˆí˜¸'] || r['ìì‚° ë²ˆí˜¸'] || '';
    const equipNum = getEquipmentNumber(r);
    const equipDisplay = equipNum ? r._equip + '(' + equipNum + ')' : r._equip;
    const detail = getDetailByDate(r, data.date);
    return '<div class="card issue"><div class="card-title">' + locName + ' / ' + equipDisplay + ' / ' + assetNum + '</div><div class="card-note">' + detail + '</div></div>';
  }).join('');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ ì‹¤í–‰
window.onload = function() {
  load();
};
</script>
</body>
</html>